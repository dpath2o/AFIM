

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>sea_ice_observations &mdash; AFIM 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=9edc463e" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=01f34227"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            AFIM
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../AFIM_sensitivity_methodology.html">Methodology: Antarctic (Land)Fast (Sea) Ice Modelling and Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lateral_drag_form_factor_creation.html">Coastal-drag form factors from high-resolution coastline and grounded icebergs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">AFIM</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">sea_ice_observations</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for sea_ice_observations</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span><span class="o">,</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">shutil</span><span class="o">,</span><span class="w"> </span><span class="nn">time</span><span class="o">,</span><span class="w"> </span><span class="nn">logging</span><span class="o">,</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w">   </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w">   </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w">    </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xesmf</span><span class="w">    </span><span class="k">as</span><span class="w"> </span><span class="nn">xe</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w">    </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w">   </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w">     </span><span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyresample</span><span class="w"> </span><span class="kn">import</span> <span class="n">geometry</span><span class="p">,</span> <span class="n">kd_tree</span>

<div class="viewcode-block" id="SeaIceObservations">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SeaIceObservations</span><span class="p">:</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span>
    
    <span class="c1">####################################################################################################</span>
    <span class="c1">##                                              NSIDC         </span>
    <span class="c1">####################################################################################################</span>
<div class="viewcode-block" id="SeaIceObservations.load_local_NSIDC">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.load_local_NSIDC">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_local_NSIDC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt0_str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtN_str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">local_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">monthly_files</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load NSIDC sea ice concentration data from local NetCDF files over a date range.</span>

<span class="sd">        INPUTS:</span>
<span class="sd">           dt0_str         : str, optional; start date in &#39;YYYY-MM-DD&#39; format. Defaults to self.dt0_str.</span>
<span class="sd">           dtN_str         : str, optional; end date in &#39;YYYY-MM-DD&#39; format. Defaults to self.dtN_str.</span>
<span class="sd">           local_directory : str or Path, optional; directory containing the NSIDC NetCDF files.</span>
<span class="sd">                             If None, uses self.NSIDC_dict[&quot;D_original&quot;].</span>
<span class="sd">           monthly_files   : bool, optional; iff True, loads monthly files; otherwise loads daily files.</span>

<span class="sd">        OUTPUTS</span>
<span class="sd">           xarray.Dataset; combined dataset loaded with xarray.open_mfdataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">promote_time</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[[</span><span class="s2">&quot;cdr_seaice_conc&quot;</span><span class="p">]]</span> <span class="k">if</span> <span class="s2">&quot;cdr_seaice_conc&quot;</span> <span class="ow">in</span> <span class="n">ds</span> <span class="k">else</span> <span class="n">ds</span>
            <span class="k">if</span> <span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">variables</span> <span class="ow">and</span> <span class="s2">&quot;tdim&quot;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="s2">&quot;tdim&quot;</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">})</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">set_coords</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ds</span>
        <span class="n">f_fmt</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NSIDC_dict</span><span class="p">[</span><span class="s2">&quot;G02202_v4_file_format&quot;</span><span class="p">]</span>
        <span class="n">dt0_str</span>  <span class="o">=</span> <span class="n">dt0_str</span> <span class="k">if</span> <span class="n">dt0_str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt0_str</span>
        <span class="n">dtN_str</span>  <span class="o">=</span> <span class="n">dtN_str</span> <span class="k">if</span> <span class="n">dtN_str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtN_str</span>
        <span class="n">freq_str</span> <span class="o">=</span> <span class="s1">&#39;monthly&#39;</span>             <span class="k">if</span> <span class="n">monthly_files</span>  <span class="k">else</span> <span class="s1">&#39;daily&#39;</span>
        <span class="n">D_local</span>  <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">local_directory</span><span class="p">)</span> <span class="k">if</span> <span class="n">local_directory</span> <span class="k">else</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NSIDC_dict</span><span class="p">[</span><span class="s2">&quot;D_original&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">hemisphere</span><span class="p">,</span> <span class="n">freq_str</span><span class="p">)</span>
        <span class="n">dt0</span>      <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">dt0_str</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">dtN</span>      <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">dtN_str</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f_vers_parsed</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">ver</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date_str</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">date_str</span> <span class="k">else</span> <span class="n">datetime</span><span class="o">.</span><span class="n">min</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">ver</span><span class="p">,</span> <span class="n">date_str</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">NSIDC_dict</span><span class="p">[</span><span class="s2">&quot;file_versions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">]</span>
        <span class="n">f_vers_parsed</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Sort by date</span>
        <span class="n">date_range</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">dt0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">dtN</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;MS&#39;</span> <span class="k">if</span> <span class="n">monthly_files</span> <span class="k">else</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span>
        <span class="n">P_NSIDCs</span>   <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dt_</span> <span class="ow">in</span> <span class="n">date_range</span><span class="p">:</span>
            <span class="n">f_version</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span> <span class="p">(</span><span class="n">ver</span> <span class="k">for</span> <span class="n">ver</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">f_vers_parsed</span><span class="p">)</span> <span class="k">if</span> <span class="n">dt_</span> <span class="o">&gt;=</span> <span class="n">d</span><span class="p">),</span> <span class="n">f_vers_parsed</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">F_</span>        <span class="o">=</span> <span class="n">f_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">freq</span> <span class="o">=</span> <span class="n">freq_str</span><span class="p">,</span>
                                     <span class="n">hem</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hemisphere_dict</span><span class="p">[</span><span class="s1">&#39;abbreviation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                                     <span class="n">date</span> <span class="o">=</span> <span class="n">dt_</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span>
                                     <span class="n">ver</span>  <span class="o">=</span> <span class="n">f_version</span><span class="p">)</span>
            <span class="n">P_</span>        <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">D_local</span><span class="p">,</span><span class="n">F_</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">P_</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">P_NSIDCs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P_</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing file: </span><span class="si">{</span><span class="n">P_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">P_NSIDCs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No NSIDC files found in </span><span class="si">{</span><span class="n">D_local</span><span class="si">}</span><span class="s2"> between </span><span class="si">{</span><span class="n">dt0_str</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">dtN_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using xarray to load </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">P_NSIDCs</span><span class="p">)</span><span class="si">}</span><span class="s2"> files in </span><span class="si">{</span><span class="n">D_local</span><span class="si">}</span><span class="s2">. Last file: </span><span class="si">{</span><span class="n">P_NSIDCs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="n">P_NSIDCs</span><span class="p">,</span>
                                 <span class="n">combine</span>    <span class="o">=</span> <span class="s2">&quot;by_coords&quot;</span><span class="p">,</span>
                                 <span class="n">parallel</span>   <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                 <span class="n">preprocess</span> <span class="o">=</span> <span class="n">promote_time</span><span class="p">)</span></div>


<div class="viewcode-block" id="SeaIceObservations.NSIDC_coordinate_transformation">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.NSIDC_coordinate_transformation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">NSIDC_coordinate_transformation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pyproj</span><span class="w"> </span><span class="kn">import</span> <span class="n">CRS</span><span class="p">,</span> <span class="n">Transformer</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert NSIDC dataset Cartesian coordinates (xgrid, ygrid) into geographic coordinates (longitude, latitude).</span>

<span class="sd">        This method transforms the Cartesian coordinates used in NSIDC datasets into</span>
<span class="sd">        standard geographic coordinates (longitude, latitude) based on the Polar</span>
<span class="sd">        Stereographic projection.</span>

<span class="sd">        INPUTS</span>
<span class="sd">            ds (xarray.Dataset): The NSIDC dataset containing Cartesian coordinates.</span>

<span class="sd">        OUTPUTS</span>
<span class="sd">            xarray.Dataset: The dataset with added `lon` and `lat` variables representing</span>
<span class="sd">                            geographic coordinates.</span>

<span class="sd">        NOTES:</span>
<span class="sd">            - The conversion is done using the Proj4 string specified in `self.NSIDC_dict[&quot;projection_string&quot;]`.</span>
<span class="sd">            - The transformed geographic coordinates are added to the dataset as new variables</span>
<span class="sd">              named `lon` and `lat`.</span>
<span class="sd">            - The method assumes the dataset contains `xgrid` and `ygrid` variables, which</span>
<span class="sd">              represent the Cartesian coordinates in meters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;xgrid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;ygrid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;xgrid and ygrid must have the same shape&quot;</span>
        <span class="n">crs_nsidc</span> <span class="o">=</span> <span class="n">CRS</span><span class="o">.</span><span class="n">from_proj4</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NSIDC_dict</span><span class="p">[</span><span class="s2">&quot;projection_string&quot;</span><span class="p">])</span>
        <span class="n">crs_wgs84</span> <span class="o">=</span> <span class="n">CRS</span><span class="o">.</span><span class="n">from_epsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sea_ice_dic</span><span class="p">[</span><span class="s2">&quot;projection_wgs84&quot;</span><span class="p">])</span>
        <span class="n">trans</span>     <span class="o">=</span> <span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="n">crs_proj</span><span class="p">,</span> <span class="n">crs_wgs84</span><span class="p">,</span> <span class="n">always_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span>  <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">),</span> <span class="n">lat</span><span class="p">)</span>
        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">),</span> <span class="n">lon</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ds</span></div>


<div class="viewcode-block" id="SeaIceObservations.compute_NSIDC_metrics">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.compute_NSIDC_metrics">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_NSIDC_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                              <span class="n">dt0_str</span>         <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">dtN_str</span>         <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">local_load_dir</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">monthly_files</span>   <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">P_zarr</span>          <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">overwrite</span>       <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">flags</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NSIDC_dict</span><span class="p">[</span><span class="s2">&quot;cdr_seaice_conc_flags&quot;</span><span class="p">]</span>
        <span class="n">SIC_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NSIDC_dict</span><span class="p">[</span><span class="s2">&quot;SIC_name&quot;</span><span class="p">]</span>
        <span class="n">dt0_str</span>  <span class="o">=</span> <span class="n">dt0_str</span> <span class="k">if</span> <span class="n">dt0_str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt0_str</span>
        <span class="n">dtN_str</span>  <span class="o">=</span> <span class="n">dtN_str</span> <span class="k">if</span> <span class="n">dtN_str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtN_str</span>
        <span class="k">if</span> <span class="n">monthly_files</span><span class="p">:</span>
            <span class="n">freq_str</span> <span class="o">=</span> <span class="s1">&#39;monthly&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">freq_str</span> <span class="o">=</span> <span class="s1">&#39;daily&#39;</span>
        <span class="n">D_local</span> <span class="o">=</span> <span class="n">local_load_dir</span> <span class="k">if</span> <span class="n">local_load_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NSIDC_dict</span><span class="p">[</span><span class="s2">&quot;D_original&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">hemisphere</span><span class="p">,</span> <span class="n">freq_str</span><span class="p">)</span>
        <span class="n">P_zarr</span>  <span class="o">=</span> <span class="n">P_zarr</span>         <span class="k">if</span> <span class="n">P_zarr</span>         <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">Path</span><span class="p">(</span><span class="n">D_local</span><span class="p">,</span> <span class="s2">&quot;zarr&quot;</span> <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">P_zarr</span><span class="p">)</span> <span class="ow">or</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="n">NSIDC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_local_NSIDC</span><span class="p">(</span><span class="n">dt0_str</span>         <span class="o">=</span> <span class="n">dt0_str</span><span class="p">,</span>
                                          <span class="n">dtN_str</span>         <span class="o">=</span> <span class="n">dtN_str</span><span class="p">,</span>
                                          <span class="n">local_directory</span> <span class="o">=</span> <span class="n">D_local</span><span class="p">)</span>
            <span class="n">aice</span>  <span class="o">=</span> <span class="n">NSIDC</span><span class="p">[</span><span class="n">SIC_name</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">aice</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">aice</span><span class="o">==</span><span class="n">flag</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">aice</span><span class="p">)</span>
            <span class="n">area</span>     <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NSIDC_dict</span><span class="p">[</span><span class="s2">&quot;P_cell_area&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">cell_area</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">SIC_scale</span>
            <span class="n">mask</span>     <span class="o">=</span> <span class="n">aice</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">icon_thresh</span>
            <span class="n">SIA</span>      <span class="o">=</span> <span class="p">(</span><span class="n">aice</span> <span class="o">*</span> <span class="n">area</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">notnull</span><span class="p">())</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">SIE</span>      <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">*</span> <span class="n">area</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">NSIDC_ts</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s1">&#39;SIA&#39;</span> <span class="p">:</span> <span class="p">((</span><span class="s1">&#39;time&#39;</span><span class="p">),</span><span class="n">SIA</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
                                   <span class="s1">&#39;SIE&#39;</span> <span class="p">:</span> <span class="p">((</span><span class="s1">&#39;time&#39;</span><span class="p">),</span><span class="n">SIE</span><span class="o">.</span><span class="n">values</span><span class="p">)},</span>
                                  <span class="n">coords</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span> <span class="p">:</span> <span class="p">((</span><span class="s1">&#39;time&#39;</span><span class="p">),</span> <span class="n">SIA</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">)})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**writing** NSIDC time series zarr file </span><span class="si">{</span><span class="n">P_zarr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">NSIDC_ts</span><span class="o">.</span><span class="n">to_zarr</span><span class="p">(</span><span class="n">P_zarr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">NSIDC_ts</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**loading** previously created NSIDC time series zarr file </span><span class="si">{</span><span class="n">P_zarr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="n">P_zarr</span><span class="p">,</span> <span class="n">consolidated</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


    <span class="c1">####################################################################################################</span>
    <span class="c1">##                                              AF2020         </span>
    <span class="c1">####################################################################################################</span>
<div class="viewcode-block" id="SeaIceObservations.load_AF2020_FIA_summary">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.load_AF2020_FIA_summary">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_AF2020_FIA_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                                <span class="n">repeat_climatology</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                <span class="n">start</span>             <span class="p">:</span> <span class="nb">str</span>  <span class="o">=</span> <span class="s2">&quot;1994-01-01&quot;</span><span class="p">,</span>
                                <span class="n">end</span>               <span class="p">:</span> <span class="nb">str</span>  <span class="o">=</span> <span class="s2">&quot;1999-12-31&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load AF2020 landfast sea ice area time series and compute day-of-year climatology.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        repeat_climatology : bool, optional</span>
<span class="sd">            If True, returns climatology repeated over the date range. If False, only returns 1D raw data.</span>
<span class="sd">        start : str, optional</span>
<span class="sd">            Start date for repeated climatology (default: &quot;1994-01-01&quot;).</span>
<span class="sd">        end : str, optional</span>
<span class="sd">            End date for repeated climatology (default: &quot;1999-12-31&quot;).</span>
<span class="sd">        smooth : int, optional</span>
<span class="sd">            Rolling window size for smoothing the day-of-year climatology (default: 5 days).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xr.Dataset</span>
<span class="sd">            Dataset with:</span>
<span class="sd">                - &#39;FIA_obs&#39;:           Daily FIA time series [time, region]</span>
<span class="sd">                - &#39;FIA_clim&#39;:          Smoothed climatology [doy, region]</span>
<span class="sd">                - &#39;FIA_clim_repeat&#39;:   Climatology repeated over [start, end] (optional)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">interp1d</span>
        <span class="n">csv_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AF_FI_dict</span><span class="p">[</span><span class="s1">&#39;P_AF2020_csv&#39;</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
        <span class="n">regions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;circumpolar&quot;</span><span class="p">,</span> <span class="s2">&quot;indian_ocean&quot;</span><span class="p">,</span> <span class="s2">&quot;western_pacific&quot;</span><span class="p">,</span> <span class="s2">&quot;ross_sea&quot;</span><span class="p">,</span> <span class="s2">&quot;amundsen_sea&quot;</span><span class="p">,</span> <span class="s2">&quot;weddell_sea&quot;</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Circumpolar&#39;</span><span class="p">:</span> <span class="s1">&#39;circumpolar&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;IOsector&#39;</span>   <span class="p">:</span> <span class="s1">&#39;indian_ocean&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;WPOsector&#39;</span>  <span class="p">:</span> <span class="s1">&#39;western_pacific&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;RSsector&#39;</span>   <span class="p">:</span> <span class="s1">&#39;ross_sea&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;BASsector&#39;</span>  <span class="p">:</span> <span class="s1">&#39;amundsen_sea&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;WSsector&#39;</span>  <span class="p">:</span> <span class="s1">&#39;weddell_sea&#39;</span><span class="p">})</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="s2">&quot;Month_start&quot;</span><span class="p">,</span> <span class="s2">&quot;Day_of_month_start&quot;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">({</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Year&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
                                    <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Month_start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
                                    <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Day_of_month_start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)},</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;doy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofyear</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">regions</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;doy&quot;</span><span class="p">]]</span>
        <span class="n">fia_obs</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">regions</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1000.0</span>  <span class="c1"># km² → 1000 km²</span>
        <span class="n">fia_obs_xr</span> <span class="o">=</span> <span class="n">fia_obs</span><span class="o">.</span><span class="n">to_xarray</span><span class="p">()</span><span class="o">.</span><span class="n">to_array</span><span class="p">(</span><span class="s2">&quot;region&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;region&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;doy&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s1">&#39;circumpolar&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected &#39;doy&#39; and &#39;circumpolar&#39; columns for climatology generation.&quot;</span><span class="p">)</span>
        <span class="n">doy_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">366</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;doy&quot;</span><span class="p">)[</span><span class="s2">&quot;circumpolar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;doy&quot;</span><span class="p">)[</span><span class="s2">&quot;circumpolar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="mf">1000.0</span>
        <span class="n">interp_func</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>
        <span class="n">clim_interp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;circumpolar&quot;</span><span class="p">:</span> <span class="n">interp_func</span><span class="p">(</span><span class="n">doy_vals</span><span class="p">)},</span> <span class="n">index</span><span class="o">=</span><span class="n">doy_vals</span><span class="p">)</span>
        <span class="n">fia_clim_doy</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">clim_interp</span><span class="p">[</span><span class="s2">&quot;circumpolar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span>  <span class="c1"># &lt;-- Add [:, None] to make it 2D</span>
                                    <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;doy&quot;</span><span class="p">:</span> <span class="n">doy_vals</span><span class="p">,</span> <span class="s2">&quot;region&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;circumpolar&quot;</span><span class="p">]},</span>
                                    <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;doy&quot;</span><span class="p">,</span> <span class="s2">&quot;region&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">repeat_climatology</span><span class="p">:</span>
            <span class="n">model_dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>
            <span class="n">doy_map</span> <span class="o">=</span> <span class="n">model_dates</span><span class="o">.</span><span class="n">dayofyear</span>
            <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">doy_map</span> <span class="o">&lt;</span> <span class="mi">366</span>
            <span class="n">model_dates</span> <span class="o">=</span> <span class="n">model_dates</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
            <span class="n">doy_map</span> <span class="o">=</span> <span class="n">doy_map</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
            <span class="n">repeated</span> <span class="o">=</span> <span class="n">fia_clim_doy</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">doy</span><span class="o">=</span><span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">doy_map</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
            <span class="n">fia_clim_re</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">repeated</span><span class="p">,</span>
                                       <span class="n">coords</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">model_dates</span><span class="p">,</span> <span class="s2">&quot;region&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;circumpolar&quot;</span><span class="p">]},</span>
                                       <span class="n">dims</span>   <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;region&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fia_clim_re</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s2">&quot;FIA_obs&quot;</span><span class="p">:</span> <span class="n">fia_obs_xr</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="s2">&quot;circumpolar&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;FIA_clim&quot;</span><span class="p">:</span> <span class="n">fia_clim_doy</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">fia_clim_re</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;FIA_clim_repeat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fia_clim_re</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AF2020 FIA data loaded from </span><span class="si">{</span><span class="n">csv_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ds</span></div>


<div class="viewcode-block" id="SeaIceObservations.AF2020_interpolate_FIA_clim">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.AF2020_interpolate_FIA_clim">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">AF2020_interpolate_FIA_clim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csv_df</span><span class="p">,</span> <span class="n">full_doy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">366</span><span class="p">)):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">interp1d</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">csv_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;Circumpolar&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s1">&#39;DOY_start&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected columns &#39;DOY_start&#39; and &#39;circumpolar&#39; in CSV.&quot;</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;DOY_start&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Circumpolar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">/</span><span class="mf">1e3</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;x and y arrays must be equal in length.&quot;</span><span class="p">)</span>
        <span class="n">interp_func</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">interp_func</span><span class="p">(</span><span class="n">full_doy</span><span class="p">),</span> <span class="n">coords</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;doy&quot;</span><span class="p">,</span> <span class="n">full_doy</span><span class="p">)])</span></div>


<div class="viewcode-block" id="SeaIceObservations.AF2020_clim_to_model_time">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.AF2020_clim_to_model_time">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">AF2020_clim_to_model_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> <span class="n">clim</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Expand a DOY-based climatology to match model time steps.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model : xr.DataArray</span>
<span class="sd">            Model time series with `time` coordinate.</span>
<span class="sd">        clim : xr.DataArray</span>
<span class="sd">            Climatology indexed by DOY and region.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xr.DataArray</span>
<span class="sd">            Climatology repeated over `model.time`, matched by DOY.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Compute day-of-year for each model date (drop Feb 29 if not in obs)</span>
        <span class="n">doy</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofyear</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">time</span><span class="p">},</span> <span class="n">dims</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
        <span class="c1"># Match each model day to a climatological value</span>
        <span class="n">matched</span> <span class="o">=</span> <span class="n">clim</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">doy</span><span class="o">=</span><span class="n">doy</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>  <span class="c1"># or method=&quot;pad&quot;</span>
        <span class="n">matched</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">time</span>  <span class="c1"># Align with model time</span>
        <span class="k">return</span> <span class="n">matched</span></div>


<div class="viewcode-block" id="SeaIceObservations.build_AF2020_grid_corners">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.build_AF2020_grid_corners">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_AF2020_grid_corners</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat_c</span><span class="p">,</span> <span class="n">lon_c</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct (ny+1, nx+1) corner arrays from center lat/lon arrays.</span>
<span class="sd">        Assumes a regular 2D rectilinear grid in EPSG:3412 projection.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        lat_c, lon_c : 2D arrays (ny, nx)</span>
<span class="sd">            Latitude and longitude of pixel centers.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        lat_b, lon_b : 2D arrays (ny+1, nx+1)</span>
<span class="sd">            Latitude and longitude of grid cell corners.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">lat_c</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">lat_padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">lat_c</span><span class="p">,</span> <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span><span class="p">)</span>
        <span class="n">lon_padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">lon_c</span><span class="p">,</span> <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span><span class="p">)</span>
        <span class="n">lat_b</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="n">lat_padded</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lat_padded</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">+</span>
                        <span class="n">lat_padded</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lat_padded</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:])</span>
        <span class="n">lon_b</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="n">lon_padded</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lon_padded</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">+</span>
                        <span class="n">lon_padded</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lon_padded</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:])</span>
        <span class="n">lon_b</span> <span class="o">=</span> <span class="p">((</span><span class="n">lon_b</span> <span class="o">+</span> <span class="mi">360</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lat_b</span><span class="p">,</span> <span class="n">lon_b</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_load_AF2020_FI_org_and_save_zarr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P_zarr</span><span class="p">):</span>
        <span class="n">D_obs</span>  <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AF_FI_dict</span><span class="p">[</span><span class="s1">&#39;D_AF2020_db_org&#39;</span><span class="p">])</span>
        <span class="n">P_orgs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">D_obs</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;FastIce_70_*.nc&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading original AF2020 NetCDF files: </span><span class="si">{</span><span class="n">P_orgs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">FI_obs</span>        <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="n">P_orgs</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;netcdf4&#39;</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="s1">&#39;by_coords&#39;</span><span class="p">)</span>
        <span class="n">FI_obs</span>        <span class="o">=</span> <span class="n">FI_obs</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="mi">32</span><span class="p">})</span>
        <span class="n">lat_c</span>         <span class="o">=</span> <span class="n">FI_obs</span><span class="o">.</span><span class="n">latitude</span>
        <span class="n">lon_c</span>         <span class="o">=</span> <span class="n">FI_obs</span><span class="o">.</span><span class="n">longitude</span>
        <span class="n">lat_b</span><span class="p">,</span> <span class="n">lon_b</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_AF2020_grid_corners</span><span class="p">(</span><span class="n">lat_c</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">lon_c</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">G_obs</span>         <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s2">&quot;lat&quot;</span>   <span class="p">:</span> <span class="p">((</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">),</span> <span class="n">lat_c</span><span class="p">),</span>
                                    <span class="s2">&quot;lon&quot;</span>   <span class="p">:</span> <span class="p">((</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">),</span> <span class="n">lon_c</span><span class="p">),</span>
                                    <span class="s2">&quot;lat_b&quot;</span> <span class="p">:</span> <span class="p">((</span><span class="s2">&quot;Y_b&quot;</span><span class="p">,</span> <span class="s2">&quot;X_b&quot;</span><span class="p">),</span> <span class="n">lat_b</span><span class="p">),</span>
                                    <span class="s2">&quot;lon_b&quot;</span> <span class="p">:</span> <span class="p">((</span><span class="s2">&quot;Y_b&quot;</span><span class="p">,</span> <span class="s2">&quot;X_b&quot;</span><span class="p">),</span> <span class="n">lon_b</span><span class="p">)})</span>
        <span class="n">G_t</span>           <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_cice_grid</span><span class="p">(</span><span class="n">grid_type</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">build_grid_corners</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">P_weights</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AF_FI_dict</span><span class="p">[</span><span class="s2">&quot;AF_reG_weights&quot;</span><span class="p">]</span>
        <span class="n">reuse_weights</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">P_weights</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Regridding observational data using weights: </span><span class="si">{</span><span class="n">P_weights</span><span class="si">}</span><span class="s2"> (reuse=</span><span class="si">{</span><span class="n">reuse_weights</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">reG_obs</span> <span class="o">=</span> <span class="n">xe</span><span class="o">.</span><span class="n">Regridder</span><span class="p">(</span><span class="n">G_obs</span><span class="p">,</span> <span class="n">G_t</span><span class="p">,</span>
                               <span class="n">method</span>            <span class="o">=</span> <span class="s2">&quot;conservative&quot;</span><span class="p">,</span>
                               <span class="n">periodic</span>          <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                               <span class="n">ignore_degenerate</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                               <span class="n">reuse_weights</span>     <span class="o">=</span> <span class="n">reuse_weights</span><span class="p">,</span>
                               <span class="n">filename</span>          <span class="o">=</span> <span class="n">P_weights</span><span class="p">)</span>
        <span class="n">fast_ice_mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">FI_obs</span><span class="p">[</span><span class="s1">&#39;Fast_Ice_Time_series&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">FI_frac</span>       <span class="o">=</span> <span class="n">fast_ice_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">fast_ice_mask</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
        <span class="n">FI_frac</span>       <span class="o">=</span> <span class="n">FI_frac</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">FI_frac</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># set 0s to NaN (optional: mask ocean)</span>
        <span class="n">FI_frac_reG</span>   <span class="o">=</span> <span class="n">reG_obs</span><span class="p">(</span><span class="n">FI_frac</span><span class="p">)</span>
        <span class="n">ds_out</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">data_vars</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;FI&quot;</span>       <span class="p">:</span> <span class="n">FI_frac_reG</span><span class="p">,</span>
                                         <span class="s2">&quot;FI_t_alt&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&quot;t_FI_obs&quot;</span><span class="p">,</span> <span class="n">FI_obs</span><span class="o">.</span><span class="n">date_alt</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;long_name&quot;</span>   <span class="p">:</span> <span class="n">FI_obs</span><span class="o">.</span><span class="n">date_alt</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;long_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                                                                                     <span class="s2">&quot;description&quot;</span> <span class="p">:</span> <span class="n">FI_obs</span><span class="o">.</span><span class="n">date_alt</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)})},</span>
                            <span class="n">coords</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;t_FI_obs&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&quot;t_FI_obs&quot;</span><span class="p">,</span> <span class="n">FI_obs</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Start date of 15- or 20-day image mosaic window.&quot;</span><span class="p">,</span>
                                                                              <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;days since 2000-1-1 0:0:0&quot;</span><span class="p">}),</span>
                                      <span class="s2">&quot;lon&quot;</span>      <span class="p">:</span> <span class="p">((</span><span class="s2">&quot;nj&quot;</span><span class="p">,</span> <span class="s2">&quot;ni&quot;</span><span class="p">),</span> <span class="n">G_t</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;degrees_east&quot;</span><span class="p">}),</span>
                                      <span class="s2">&quot;lat&quot;</span>      <span class="p">:</span> <span class="p">((</span><span class="s2">&quot;nj&quot;</span><span class="p">,</span> <span class="s2">&quot;ni&quot;</span><span class="p">),</span> <span class="n">G_t</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;degrees_north&quot;</span><span class="p">})})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving regridded dataset to Zarr: </span><span class="si">{</span><span class="n">P_zarr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ds_out</span><span class="o">.</span><span class="n">to_zarr</span><span class="p">(</span><span class="n">P_zarr</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">consolidated</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ds_out</span>

<div class="viewcode-block" id="SeaIceObservations.define_FIP_diff_names">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.define_FIP_diff_names">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">define_FIP_diff_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                     <span class="n">AF2020</span>            <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                     <span class="n">variable_name</span>     <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">lon_coord_name</span>    <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">lat_coord_name</span>    <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">time_coord_name</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">spatial_dim_names</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">thresh_val</span>        <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">name_space</span>        <span class="o">=</span> <span class="p">{}</span>
        <span class="n">spatial_dim_names</span> <span class="o">=</span> <span class="n">spatial_dim_names</span> <span class="k">if</span> <span class="n">spatial_dim_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">CICE_dict</span><span class="p">[</span><span class="s1">&#39;spatial_dims&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">AF2020</span><span class="p">:</span>
            <span class="n">name_var</span>   <span class="o">=</span> <span class="n">variable_name</span>   <span class="k">if</span> <span class="n">variable_name</span>   <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">AF_FI_dict</span><span class="p">[</span><span class="s2">&quot;variable_name&quot;</span><span class="p">]</span>
            <span class="n">name_lat</span>   <span class="o">=</span> <span class="n">lat_coord_name</span>  <span class="k">if</span> <span class="n">lat_coord_name</span>  <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">AF_FI_dict</span><span class="p">[</span><span class="s2">&quot;lat_coord_name&quot;</span><span class="p">]</span>
            <span class="n">name_lon</span>   <span class="o">=</span> <span class="n">lon_coord_name</span>  <span class="k">if</span> <span class="n">lon_coord_name</span>  <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">AF_FI_dict</span><span class="p">[</span><span class="s2">&quot;lon_coord_name&quot;</span><span class="p">]</span>
            <span class="n">name_dt</span>    <span class="o">=</span> <span class="n">time_coord_name</span> <span class="k">if</span> <span class="n">time_coord_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">AF_FI_dict</span><span class="p">[</span><span class="s2">&quot;time_coord_name&quot;</span><span class="p">]</span>
            <span class="n">thresh_val</span> <span class="o">=</span> <span class="n">thresh_val</span>      <span class="k">if</span> <span class="n">thresh_val</span>      <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">AF_FI_dict</span><span class="p">[</span><span class="s2">&quot;threshold_value&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>    
            <span class="n">name_var</span>   <span class="o">=</span> <span class="n">variable_name</span>   <span class="k">if</span> <span class="n">variable_name</span>   <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;aice&quot;</span>
            <span class="n">name_lat</span>   <span class="o">=</span> <span class="n">lat_coord_name</span>  <span class="k">if</span> <span class="n">lat_coord_name</span>  <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">CICE_dict</span><span class="p">[</span><span class="s2">&quot;tcoord_names&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">name_lon</span>   <span class="o">=</span> <span class="n">lon_coord_name</span>  <span class="k">if</span> <span class="n">lon_coord_name</span>  <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">CICE_dict</span><span class="p">[</span><span class="s2">&quot;tcoord_names&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">name_dt</span>    <span class="o">=</span> <span class="n">time_coord_name</span> <span class="k">if</span> <span class="n">time_coord_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">CICE_dict</span><span class="p">[</span><span class="s2">&quot;time_dim&quot;</span><span class="p">]</span>
            <span class="n">thresh_val</span> <span class="o">=</span> <span class="n">thresh_val</span>      <span class="k">if</span> <span class="n">thresh_val</span>      <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">icon_thresh</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;spatial_dims&#39;</span><span class="p">:</span> <span class="n">spatial_dim_names</span><span class="p">,</span>
                <span class="s1">&#39;time_dim&#39;</span>    <span class="p">:</span> <span class="n">name_dt</span><span class="p">,</span>
                <span class="s1">&#39;variable&#39;</span>    <span class="p">:</span> <span class="n">name_var</span><span class="p">,</span>
                <span class="s1">&#39;latitude&#39;</span>    <span class="p">:</span> <span class="n">name_lat</span><span class="p">,</span>
                <span class="s1">&#39;longitude&#39;</span>   <span class="p">:</span> <span class="n">name_lon</span><span class="p">,</span>
                <span class="s1">&#39;thresh_val&#39;</span>  <span class="p">:</span> <span class="n">thresh_val</span><span class="p">}</span></div>


<div class="viewcode-block" id="SeaIceObservations.define_fast_ice_coordinates">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.define_fast_ice_coordinates">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">define_fast_ice_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span>
                                    <span class="n">AF2020</span>            <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                    <span class="n">variable_name</span>     <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                    <span class="n">lon_coord_name</span>    <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                    <span class="n">lat_coord_name</span>    <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                    <span class="n">time_coord_name</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                    <span class="n">spatial_dim_names</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                    <span class="n">thresh_val</span>        <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_FIP_diff_names</span><span class="p">(</span><span class="n">AF2020</span>            <span class="o">=</span> <span class="n">AF2020</span><span class="p">,</span>
                                           <span class="n">variable_name</span>     <span class="o">=</span> <span class="n">variable_name</span><span class="p">,</span>
                                           <span class="n">lon_coord_name</span>    <span class="o">=</span> <span class="n">lon_coord_name</span><span class="p">,</span>
                                           <span class="n">lat_coord_name</span>    <span class="o">=</span> <span class="n">lat_coord_name</span><span class="p">,</span>
                                           <span class="n">time_coord_name</span>   <span class="o">=</span> <span class="n">time_coord_name</span><span class="p">,</span>
                                           <span class="n">spatial_dim_names</span> <span class="o">=</span> <span class="n">spatial_dim_names</span><span class="p">,</span>
                                           <span class="n">thresh_val</span>        <span class="o">=</span> <span class="n">thresh_val</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="s1">&#39;time_dim&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;datetimes&#39;</span>  <span class="p">:</span> <span class="n">dt</span><span class="p">,</span>
                <span class="s1">&#39;latitudes&#39;</span>  <span class="p">:</span> <span class="n">lat</span><span class="p">,</span>
                <span class="s1">&#39;longitudes&#39;</span> <span class="p">:</span> <span class="n">lon</span><span class="p">,</span>
                <span class="s1">&#39;names&#39;</span>      <span class="p">:</span> <span class="n">names</span><span class="p">}</span></div>


<div class="viewcode-block" id="SeaIceObservations.define_fast_ice_mask_da">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.define_fast_ice_mask_da">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">define_fast_ice_mask_da</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span>
                                <span class="n">AF2020</span>            <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">variable_name</span>     <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">lon_coord_name</span>    <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">lat_coord_name</span>    <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">time_coord_name</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">spatial_dim_names</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">thresh_val</span>        <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">coords</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_fast_ice_coordinates</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span>
                                                    <span class="n">AF2020</span>            <span class="o">=</span> <span class="n">AF2020</span><span class="p">,</span>
                                                    <span class="n">variable_name</span>     <span class="o">=</span> <span class="n">variable_name</span><span class="p">,</span>
                                                    <span class="n">lon_coord_name</span>    <span class="o">=</span> <span class="n">lon_coord_name</span><span class="p">,</span>
                                                    <span class="n">lat_coord_name</span>    <span class="o">=</span> <span class="n">lat_coord_name</span><span class="p">,</span>
                                                    <span class="n">time_coord_name</span>   <span class="o">=</span> <span class="n">time_coord_name</span><span class="p">,</span>
                                                    <span class="n">spatial_dim_names</span> <span class="o">=</span> <span class="n">spatial_dim_names</span><span class="p">,</span>
                                                    <span class="n">thresh_val</span>        <span class="o">=</span> <span class="n">thresh_val</span><span class="p">)</span>
        <span class="n">FI_mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">][</span><span class="s1">&#39;variable&#39;</span><span class="p">]]</span> <span class="o">&gt;=</span> <span class="n">coords</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">][</span><span class="s1">&#39;thresh_val&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">FI_mask</span><span class="p">,</span>
                            <span class="n">dims</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CICE_dict</span><span class="p">[</span><span class="s1">&#39;three_dims&#39;</span><span class="p">],</span>
                            <span class="n">coords</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">CICE_dict</span><span class="p">[</span><span class="s1">&#39;lat_coord_name&#39;</span><span class="p">]</span> <span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CICE_dict</span><span class="p">[</span><span class="s1">&#39;spatial_dims&#39;</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="s1">&#39;latitudes&#39;</span><span class="p">]),</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">CICE_dict</span><span class="p">[</span><span class="s1">&#39;lon_coord_name&#39;</span><span class="p">]</span> <span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CICE_dict</span><span class="p">[</span><span class="s1">&#39;spatial_dims&#39;</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="s1">&#39;longitudes&#39;</span><span class="p">]),</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">CICE_dict</span><span class="p">[</span><span class="s1">&#39;time_dim&#39;</span><span class="p">]</span>       <span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CICE_dict</span><span class="p">[</span><span class="s1">&#39;time_dim&#39;</span><span class="p">]</span>    <span class="p">,</span> <span class="n">coords</span><span class="p">[</span><span class="s1">&#39;datetimes&#39;</span><span class="p">])})</span></div>

    
<div class="viewcode-block" id="SeaIceObservations.define_regular_G">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.define_regular_G">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">define_regular_G</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid_res</span><span class="p">,</span>
                         <span class="n">region</span>            <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">360</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                         <span class="n">spatial_dim_names</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;nj&quot;</span><span class="p">,</span><span class="s2">&quot;ni&quot;</span><span class="p">)):</span>
        <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="n">region</span>
        <span class="n">lon_regular</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span> <span class="o">+</span> <span class="n">grid_res</span><span class="p">,</span> <span class="n">grid_res</span><span class="p">)</span>
        <span class="n">lat_regular</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">+</span> <span class="n">grid_res</span><span class="p">,</span> <span class="n">grid_res</span><span class="p">)</span>
        <span class="n">LON</span><span class="p">,</span> <span class="n">LAT</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lon_regular</span><span class="p">,</span><span class="n">lat_regular</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">CICE_dict</span><span class="p">[</span><span class="s1">&#39;lon_coord_name&#39;</span><span class="p">]</span> <span class="p">:</span> <span class="p">(</span><span class="n">spatial_dim_names</span><span class="p">,</span> <span class="n">LON</span><span class="p">),</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">CICE_dict</span><span class="p">[</span><span class="s1">&#39;lat_coord_name&#39;</span><span class="p">]</span> <span class="p">:</span> <span class="p">(</span><span class="n">spatial_dim_names</span><span class="p">,</span> <span class="n">LAT</span><span class="p">)})</span></div>


<div class="viewcode-block" id="SeaIceObservations.define_reG_regular_weights">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.define_reG_regular_weights">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">define_reG_regular_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span>
                                    <span class="n">G_res</span>             <span class="o">=</span> <span class="mf">0.15</span><span class="p">,</span>
                                    <span class="n">region</span>            <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">360</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="n">AF2020</span>            <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                    <span class="n">variable_name</span>     <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                    <span class="n">lon_coord_name</span>    <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                    <span class="n">lat_coord_name</span>    <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                    <span class="n">time_coord_name</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                    <span class="n">spatial_dim_names</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                    <span class="n">reG_method</span>        <span class="o">=</span> <span class="s2">&quot;bilinear&quot;</span><span class="p">,</span>
                                    <span class="n">periodic</span>          <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                    <span class="n">reuse_weights</span>     <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                    <span class="n">P_weights</span>         <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">coords</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_fast_ice_coordinates</span><span class="p">(</span><span class="n">da</span><span class="p">,</span>
                                                    <span class="n">AF2020</span>            <span class="o">=</span> <span class="n">AF2020</span><span class="p">,</span>
                                                    <span class="n">variable_name</span>     <span class="o">=</span> <span class="n">variable_name</span><span class="p">,</span>
                                                    <span class="n">lon_coord_name</span>    <span class="o">=</span> <span class="n">lon_coord_name</span><span class="p">,</span>
                                                    <span class="n">lat_coord_name</span>    <span class="o">=</span> <span class="n">lat_coord_name</span><span class="p">,</span>
                                                    <span class="n">time_coord_name</span>   <span class="o">=</span> <span class="n">time_coord_name</span><span class="p">,</span>
                                                    <span class="n">spatial_dim_names</span> <span class="o">=</span> <span class="n">spatial_dim_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">AF2020</span><span class="p">:</span> 
            <span class="n">P_weights</span> <span class="o">=</span> <span class="n">P_weights</span> <span class="k">if</span> <span class="n">P_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">AF_FI_dict</span><span class="p">[</span><span class="s2">&quot;P_reG_reg_weights&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">P_weights</span> <span class="o">=</span> <span class="n">P_weights</span> <span class="k">if</span> <span class="n">P_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">CICE_dict</span><span class="p">[</span><span class="s2">&quot;P_reG_reg_weights&quot;</span><span class="p">]</span>
        <span class="n">G_src</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">CICE_dict</span><span class="p">[</span><span class="s1">&#39;lat_coord_name&#39;</span><span class="p">]</span> <span class="p">:</span> <span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">][</span><span class="s1">&#39;spatial_dims&#39;</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="s1">&#39;latitudes&#39;</span><span class="p">]),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">CICE_dict</span><span class="p">[</span><span class="s1">&#39;lon_coord_name&#39;</span><span class="p">]</span> <span class="p">:</span> <span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">][</span><span class="s1">&#39;spatial_dims&#39;</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="s1">&#39;longitudes&#39;</span><span class="p">])})</span>
        <span class="n">G_dst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_regular_G</span><span class="p">(</span><span class="n">G_res</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">spatial_dim_names</span><span class="o">=</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">][</span><span class="s1">&#39;spatial_dims&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">xe</span><span class="o">.</span><span class="n">Regridder</span><span class="p">(</span><span class="n">G_src</span><span class="p">,</span> <span class="n">G_dst</span><span class="p">,</span>
                            <span class="n">method</span>            <span class="o">=</span> <span class="n">reG_method</span><span class="p">,</span>
                            <span class="n">periodic</span>          <span class="o">=</span> <span class="n">periodic</span><span class="p">,</span>
                            <span class="n">ignore_degenerate</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">reuse_weights</span>     <span class="o">=</span> <span class="n">reuse_weights</span><span class="p">,</span>
                            <span class="n">filename</span>          <span class="o">=</span> <span class="n">P_weights</span><span class="p">)</span></div>


<div class="viewcode-block" id="SeaIceObservations.define_fast_ice_persistence_da">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.define_fast_ice_persistence_da">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">define_fast_ice_persistence_da</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fip</span><span class="p">,</span> <span class="n">reG</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">reG</span><span class="p">:</span>
            <span class="n">G_dst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_regular_G</span><span class="p">(</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">360</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">spatial_dim_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">CICE_dict</span><span class="p">[</span><span class="s1">&#39;spatial_dims&#39;</span><span class="p">])</span>
            <span class="n">lats</span>  <span class="o">=</span> <span class="n">G_dst</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CICE_dict</span><span class="p">[</span><span class="s1">&#39;lat_coord_name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">lons</span>  <span class="o">=</span> <span class="n">G_dst</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CICE_dict</span><span class="p">[</span><span class="s1">&#39;lon_coord_name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lats</span> <span class="o">=</span> <span class="n">fip</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CICE_dict</span><span class="p">[</span><span class="s1">&#39;lat_coord_name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">lons</span> <span class="o">=</span> <span class="n">fip</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CICE_dict</span><span class="p">[</span><span class="s1">&#39;lon_coord_name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">fip</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                            <span class="n">dims</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CICE_dict</span><span class="p">[</span><span class="s1">&#39;spatial_dims&#39;</span><span class="p">],</span>
                            <span class="n">coords</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">CICE_dict</span><span class="p">[</span><span class="s1">&#39;lat_coord_name&#39;</span><span class="p">]</span> <span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CICE_dict</span><span class="p">[</span><span class="s1">&#39;spatial_dims&#39;</span><span class="p">],</span> <span class="n">lats</span><span class="p">),</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">CICE_dict</span><span class="p">[</span><span class="s1">&#39;lon_coord_name&#39;</span><span class="p">]</span> <span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CICE_dict</span><span class="p">[</span><span class="s1">&#39;spatial_dims&#39;</span><span class="p">],</span> <span class="n">lons</span><span class="p">)})</span></div>


<div class="viewcode-block" id="SeaIceObservations.compute_fip_weight">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.compute_fip_weight">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_fip_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">FIP</span>   <span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> 
                           <span class="n">mode</span>  <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;max&quot;</span><span class="p">,</span>
                           <span class="n">t</span>     <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
                           <span class="n">gamma</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return opacity weight in [0,1] where 0 =&gt; fully transparent, 1 =&gt; opaque.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;obs&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">FIP</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;FIP[&#39;obs&#39;] is required&quot;</span><span class="p">)</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">FIP</span><span class="p">[</span><span class="s2">&quot;obs&quot;</span><span class="p">]</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">FIP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mod&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span> <span class="ow">and</span> <span class="n">mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">mod</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span> <span class="ow">and</span> <span class="n">mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span> <span class="o">+</span> <span class="n">mod</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;prod&quot;</span> <span class="ow">and</span> <span class="n">mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">,</span> <span class="n">obs</span> <span class="o">*</span> <span class="n">mod</span><span class="p">)</span>  <span class="c1"># geometric mean</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="n">obs</span>  <span class="c1"># fall back to obs only</span>
        <span class="c1"># Soft ramp: 0 below t, then linear to 1 at 1.0</span>
        <span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">cov</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Optional contrast shaping</span>
        <span class="k">if</span> <span class="n">gamma</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">**</span> <span class="n">gamma</span>
        <span class="n">w</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;diff_weight&quot;</span>
        <span class="n">w</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">long_name</span><span class="o">=</span><span class="s2">&quot;opacity weight&quot;</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;weight ~ </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">(obs,mod), threshold=</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">, gamma=</span><span class="si">{</span><span class="n">gamma</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">w</span></div>


<div class="viewcode-block" id="SeaIceObservations.to_3031_extent">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.to_3031_extent">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_3031_extent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat2d</span><span class="p">,</span> <span class="n">lon2d</span><span class="p">,</span> <span class="n">buffer_m</span><span class="o">=</span><span class="mi">20_000</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Project a swath&#39;s lat/lon to EPSG:3031 and return [xmin, ymin, xmax, ymax] (+buffer).</span>
<span class="sd">        Wrap longitudes to [-180, 180) first to avoid dateline issues.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pyproj</span><span class="w"> </span><span class="kn">import</span> <span class="n">Transformer</span>
        <span class="n">lon2d</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalise_longitudes</span><span class="p">(</span><span class="n">lon2d</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="s2">&quot;-180-180&quot;</span><span class="p">)</span>
        <span class="n">transformer</span> <span class="o">=</span> <span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">,</span> <span class="s2">&quot;EPSG:3031&quot;</span><span class="p">,</span> <span class="n">always_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span>        <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">lon2d</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">lat2d</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
        <span class="n">x</span>           <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">y</span>           <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">finite</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span>  <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">finite</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="p">[</span><span class="n">finite</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span>  <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">finite</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y</span><span class="p">[</span><span class="n">finite</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">xmin</span> <span class="o">-</span> <span class="n">buffer_m</span><span class="p">,</span> <span class="n">ymin</span> <span class="o">-</span> <span class="n">buffer_m</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">+</span> <span class="n">buffer_m</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">+</span> <span class="n">buffer_m</span><span class="p">]</span></div>


<div class="viewcode-block" id="SeaIceObservations.union_extents">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.union_extents">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">union_extents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extents</span><span class="p">):</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">extents</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">extents</span><span class="p">]</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">extents</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">extents</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">ys</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">ys</span><span class="p">)]</span></div>


<div class="viewcode-block" id="SeaIceObservations.snap_extent_to_grid">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.snap_extent_to_grid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">snap_extent_to_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span> <span class="n">pixel_size</span><span class="o">=</span><span class="mi">5_000</span><span class="p">):</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">extent</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">xmin</span> <span class="o">/</span> <span class="n">pixel_size</span><span class="p">)</span> <span class="o">*</span> <span class="n">pixel_size</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">ymin</span> <span class="o">/</span> <span class="n">pixel_size</span><span class="p">)</span> <span class="o">*</span> <span class="n">pixel_size</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">/</span> <span class="n">pixel_size</span><span class="p">)</span> <span class="o">*</span> <span class="n">pixel_size</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">/</span> <span class="n">pixel_size</span><span class="p">)</span> <span class="o">*</span> <span class="n">pixel_size</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]</span></div>


<div class="viewcode-block" id="SeaIceObservations.make_area_definition">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.make_area_definition">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_area_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span>
                             <span class="n">pixel_size</span> <span class="o">=</span> <span class="mi">5_000</span><span class="p">,</span>
                             <span class="n">area_id</span>    <span class="o">=</span> <span class="s2">&quot;epsg3031_5km_union&quot;</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pyresample.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">AreaDefinition</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">extent</span>
        <span class="n">width</span>                  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">/</span> <span class="n">pixel_size</span><span class="p">))</span>
        <span class="n">height</span>                 <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span> <span class="o">/</span> <span class="n">pixel_size</span><span class="p">))</span>
        <span class="n">xmax</span>                   <span class="o">=</span> <span class="n">xmin</span> <span class="o">+</span> <span class="n">width</span>  <span class="o">*</span> <span class="n">pixel_size</span>
        <span class="n">ymax</span>                   <span class="o">=</span> <span class="n">ymin</span> <span class="o">+</span> <span class="n">height</span> <span class="o">*</span> <span class="n">pixel_size</span>
        <span class="k">return</span> <span class="n">AreaDefinition</span><span class="p">(</span><span class="n">area_id</span>     <span class="o">=</span> <span class="n">area_id</span><span class="p">,</span>
                              <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Common 5 km EPSG:3031 grid (union of inputs)&quot;</span><span class="p">,</span>
                              <span class="n">proj_id</span>     <span class="o">=</span> <span class="s2">&quot;epsg3031&quot;</span><span class="p">,</span>
                              <span class="n">projection</span>  <span class="o">=</span> <span class="s2">&quot;EPSG:3031&quot;</span><span class="p">,</span>
                              <span class="n">width</span>       <span class="o">=</span> <span class="n">width</span><span class="p">,</span>
                              <span class="n">height</span>      <span class="o">=</span> <span class="n">height</span><span class="p">,</span>
                              <span class="n">area_extent</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">))</span></div>


<div class="viewcode-block" id="SeaIceObservations.grid_coords_from_area">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.grid_coords_from_area">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">grid_coords_from_area</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">area_def</span><span class="p">,</span> <span class="n">pixel_size</span><span class="o">=</span><span class="mi">5_000</span><span class="p">):</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">area_def</span><span class="o">.</span><span class="n">area_extent</span>
        <span class="n">width</span><span class="p">,</span> <span class="n">height</span>          <span class="o">=</span> <span class="n">area_def</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">area_def</span><span class="o">.</span><span class="n">height</span>
        <span class="n">x</span>                      <span class="o">=</span> <span class="n">xmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">width</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">pixel_size</span>
        <span class="n">y</span>                      <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">height</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">pixel_size</span>  <span class="c1"># top-&gt;down (north-&gt;south)</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span></div>


<div class="viewcode-block" id="SeaIceObservations.resample_swath_to_area">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.resample_swath_to_area">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resample_swath_to_area</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_da</span><span class="p">,</span> <span class="n">lat2d</span><span class="p">,</span> <span class="n">lon2d</span><span class="p">,</span> <span class="n">area_def</span><span class="p">,</span> 
                               <span class="n">pixel_size</span> <span class="o">=</span> <span class="mi">5_000</span><span class="p">,</span>
                               <span class="n">radius</span>     <span class="o">=</span> <span class="mi">10_000</span><span class="p">,</span>
                               <span class="n">fill_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pyresample.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">SwathDefinition</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pyresample.kd_tree</span><span class="w">  </span><span class="kn">import</span> <span class="n">resample_nearest</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Nearest-neighbour resample a 2D swath (lat2d, lon2d) to an AreaDefinition grid.&quot;&quot;&quot;</span>
        <span class="n">lon2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalise_longitudes</span><span class="p">(</span><span class="n">lon2d</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="s2">&quot;-180-180&quot;</span><span class="p">)</span>  <span class="c1"># &lt;&lt; key fix: wrap before building the swath</span>
        <span class="n">swath</span> <span class="o">=</span> <span class="n">SwathDefinition</span><span class="p">(</span><span class="n">lons</span><span class="o">=</span><span class="n">lon2d</span><span class="p">,</span> <span class="n">lats</span><span class="o">=</span><span class="n">lat2d</span><span class="p">)</span>
        <span class="n">out2d</span> <span class="o">=</span> <span class="n">resample_nearest</span><span class="p">(</span><span class="n">source_geo_def</span>      <span class="o">=</span> <span class="n">swath</span><span class="p">,</span>
                                 <span class="n">data</span>                <span class="o">=</span> <span class="n">src_da</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                 <span class="n">target_geo_def</span>      <span class="o">=</span> <span class="n">area_def</span><span class="p">,</span>
                                 <span class="n">radius_of_influence</span> <span class="o">=</span> <span class="n">radius</span><span class="p">,</span>
                                 <span class="n">fill_value</span>          <span class="o">=</span> <span class="n">fill_value</span><span class="p">,</span>
                                 <span class="n">nprocs</span>              <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>            <span class="c1"># set &gt;0 to parallelise</span>
                                 <span class="n">reduce_data</span>         <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_coords_from_area</span><span class="p">(</span><span class="n">area_def</span><span class="p">,</span> <span class="n">pixel_size</span><span class="o">=</span><span class="n">pixel_size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">out2d</span><span class="p">,</span>
                            <span class="n">dims</span>   <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">),</span>
                            <span class="n">coords</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;standard_name&quot;</span><span class="p">:</span> <span class="s2">&quot;projection_x_coordinate&quot;</span><span class="p">}),</span>
                                      <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;standard_name&quot;</span><span class="p">:</span> <span class="s2">&quot;projection_y_coordinate&quot;</span><span class="p">})},</span>
                            <span class="n">name</span>   <span class="o">=</span> <span class="n">src_da</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">attrs</span>  <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="s2">&quot;EPSG:3031&quot;</span><span class="p">,</span> <span class="s2">&quot;grid_mapping&quot;</span><span class="p">:</span> <span class="s2">&quot;spstereo&quot;</span><span class="p">,</span> <span class="s2">&quot;res&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">pixel_size</span> <span class="p">),</span> <span class="o">**</span><span class="n">src_da</span><span class="o">.</span><span class="n">attrs</span><span class="p">})</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_xy_to_lonlat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pyproj</span><span class="w"> </span><span class="kn">import</span> <span class="n">Transformer</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="mi">3031</span><span class="p">,</span> <span class="mi">4326</span><span class="p">,</span> <span class="n">always_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span>

<div class="viewcode-block" id="SeaIceObservations.add_lonlat_from_epsg3031">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.add_lonlat_from_epsg3031">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_lonlat_from_epsg3031</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> 
                                 <span class="n">x_name</span>    <span class="o">=</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span>
                                 <span class="n">y_name</span>    <span class="o">=</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span>
                                 <span class="n">wrap</span>      <span class="o">=</span> <span class="s2">&quot;0..360&quot;</span><span class="p">,</span>       <span class="c1"># or &quot;-180..180&quot;</span>
                                 <span class="n">out_dtype</span> <span class="o">=</span> <span class="s2">&quot;float32&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">dims</span> <span class="ow">or</span> <span class="n">y_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected dims &#39;</span><span class="si">{</span><span class="n">y_name</span><span class="si">}</span><span class="s2">&#39;, &#39;</span><span class="si">{</span><span class="n">x_name</span><span class="si">}</span><span class="s2">&#39; in dataset.&quot;</span><span class="p">)</span>
        <span class="c1"># broadcast 1-D x/y -&gt; 2-D (y,x)</span>
        <span class="n">X2D</span><span class="p">,</span> <span class="n">Y2D</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="n">x_name</span><span class="p">],</span> <span class="n">ds</span><span class="p">[</span><span class="n">y_name</span><span class="p">])</span>  <span class="c1"># shapes (y,x)</span>
        <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xy_to_lonlat</span><span class="p">,</span> <span class="n">X2D</span><span class="p">,</span> <span class="n">Y2D</span><span class="p">,</span>
                                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="n">y_name</span><span class="p">,</span> <span class="n">x_name</span><span class="p">],</span> <span class="p">[</span><span class="n">y_name</span><span class="p">,</span> <span class="n">x_name</span><span class="p">]],</span>
                                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="n">y_name</span><span class="p">,</span> <span class="n">x_name</span><span class="p">],</span> <span class="p">[</span><span class="n">y_name</span><span class="p">,</span> <span class="n">x_name</span><span class="p">]],</span>
                                <span class="n">dask</span><span class="o">=</span><span class="s2">&quot;parallelized&quot;</span><span class="p">,</span>
                                <span class="n">vectorize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],)</span>
        <span class="c1"># wrap longitudes &amp; cast </span>
        <span class="k">if</span> <span class="n">wrap</span> <span class="o">==</span> <span class="s2">&quot;0..360&quot;</span><span class="p">:</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalise_longitudes</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="s2">&quot;0-360&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalise_longitudes</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="s2">&quot;-180-180&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">out_dtype</span><span class="p">:</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">out_dtype</span><span class="p">)</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">out_dtype</span><span class="p">)</span>
        <span class="c1"># attach as coordinates (on same (y,x) dims)</span>
        <span class="k">return</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">)</span></div>


<div class="viewcode-block" id="SeaIceObservations.regional_fast_ice_area">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.regional_fast_ice_area">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">regional_fast_ice_area</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
                                <span class="n">region</span>    <span class="o">=</span> <span class="p">(</span><span class="mf">52.5</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">70.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">64</span><span class="p">),</span>
                                <span class="n">lon_name</span>  <span class="o">=</span> <span class="s2">&quot;longitude&quot;</span><span class="p">,</span>
                                <span class="n">lat_name</span>  <span class="o">=</span> <span class="s2">&quot;latitude&quot;</span><span class="p">,</span>
                                <span class="n">area_name</span> <span class="o">=</span> <span class="s2">&quot;area&quot;</span><span class="p">,</span>
                                <span class="n">fast_name</span> <span class="o">=</span> <span class="s2">&quot;Fast_Ice_Time_series&quot;</span><span class="p">,</span>
                                <span class="n">threshold</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
                                <span class="n">lon_wrap</span>  <span class="o">=</span> <span class="s2">&quot;0-360&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute regional fast-ice area (km^2) time series from AF2020-like DS with</span>
<span class="sd">        curvilinear lon/lat and a per-cell area field.</span>
<span class="sd">        region = (lon_min, lon_max, lat_min, lat_max)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="n">region</span>
        <span class="c1"># --- 1) Use static lon/lat &amp; area from first time slice (avoid time broadcast)</span>
        <span class="n">lon2d</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">lon_name</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">lat2d</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">lat_name</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">area2d</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">area_name</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># assumed m^2</span>
        <span class="c1"># --- 2) Normalize longitudes to match region convention</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">wrap</span><span class="p">(</span><span class="n">lon</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lon_wrap</span> <span class="o">==</span> <span class="s2">&quot;0-360&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">((</span><span class="n">lon</span> <span class="o">%</span> <span class="mi">360</span><span class="p">)</span> <span class="o">+</span> <span class="mi">360</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">((</span><span class="n">lon</span> <span class="o">+</span> <span class="mf">180.0</span><span class="p">)</span> <span class="o">%</span> <span class="mf">360.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">180.0</span>
        <span class="n">lon2d</span> <span class="o">=</span> <span class="n">wrap</span><span class="p">(</span><span class="n">lon2d</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lon_wrap</span> <span class="o">==</span> <span class="s2">&quot;0-360&quot;</span><span class="p">:</span>
            <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span> <span class="o">=</span> <span class="n">lon_min</span> <span class="o">%</span> <span class="mi">360</span><span class="p">,</span> <span class="n">lon_max</span> <span class="o">%</span> <span class="mi">360</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lon_min</span> <span class="o">=</span> <span class="p">((</span><span class="n">lon_min</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span><span class="p">)</span> <span class="o">-</span> <span class="mi">180</span>
            <span class="n">lon_max</span> <span class="o">=</span> <span class="p">((</span><span class="n">lon_max</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span><span class="p">)</span> <span class="o">-</span> <span class="mi">180</span>
        <span class="c1"># --- 3) Build region mask (handle seam-crossing gracefully)</span>
        <span class="k">if</span> <span class="n">lon_min</span> <span class="o">&lt;=</span> <span class="n">lon_max</span><span class="p">:</span>
            <span class="n">mask_lon</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon2d</span> <span class="o">&gt;=</span> <span class="n">lon_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lon2d</span> <span class="o">&lt;=</span> <span class="n">lon_max</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask_lon</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon2d</span> <span class="o">&gt;=</span> <span class="n">lon_min</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">lon2d</span> <span class="o">&lt;=</span> <span class="n">lon_max</span><span class="p">)</span>  <span class="c1"># across seam</span>
        <span class="n">mask_lat</span> <span class="o">=</span> <span class="p">(</span><span class="n">lat2d</span> <span class="o">&gt;=</span> <span class="n">lat_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat2d</span> <span class="o">&lt;=</span> <span class="n">lat_max</span><span class="p">)</span>
        <span class="n">region_mask</span> <span class="o">=</span> <span class="n">mask_lon</span> <span class="o">&amp;</span> <span class="n">mask_lat</span>                      <span class="c1"># (Y, X)</span>
        <span class="c1"># --- 4) Convert area to 1000-km^2</span>
        <span class="n">area_km2</span> <span class="o">=</span> <span class="n">area2d</span> <span class="o">/</span> <span class="mf">1e9</span>
        <span class="c1"># OPTIONAL: crop to bounding indices to reduce work</span>
        <span class="n">jdim</span><span class="p">,</span> <span class="n">idim</span> <span class="o">=</span> <span class="n">lat2d</span><span class="o">.</span><span class="n">dims</span>  <span class="c1"># expect (&quot;Y&quot;,&quot;X&quot;)</span>
        <span class="n">j_any</span> <span class="o">=</span> <span class="n">region_mask</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">idim</span><span class="p">)</span>
        <span class="n">i_any</span> <span class="o">=</span> <span class="n">region_mask</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">jdim</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">j_any</span><span class="o">.</span><span class="n">any</span><span class="p">())</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="n">i_any</span><span class="o">.</span><span class="n">any</span><span class="p">()):</span>
            <span class="n">j_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">j_any</span><span class="o">.</span><span class="n">values</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">i_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">i_any</span><span class="o">.</span><span class="n">values</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">j0</span><span class="p">,</span> <span class="n">j1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">j_idx</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="nb">int</span><span class="p">(</span><span class="n">j_idx</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">i0</span><span class="p">,</span> <span class="n">i1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i_idx</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="nb">int</span><span class="p">(</span><span class="n">i_idx</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">region_mask</span> <span class="o">=</span> <span class="n">region_mask</span><span class="o">.</span><span class="n">isel</span><span class="p">({</span><span class="n">jdim</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="n">j0</span><span class="p">,</span> <span class="n">j1</span><span class="p">),</span> <span class="n">idim</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="n">i1</span><span class="p">)})</span>
            <span class="n">area_km2</span>    <span class="o">=</span> <span class="n">area_km2</span><span class="o">.</span><span class="n">isel</span><span class="p">({</span><span class="n">jdim</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="n">j0</span><span class="p">,</span> <span class="n">j1</span><span class="p">),</span> <span class="n">idim</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="n">i1</span><span class="p">)})</span>
        <span class="c1"># --- 5) Fast-ice presence per time (binary), then area sum over region</span>
        <span class="n">fast</span> <span class="o">=</span> <span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="n">fast_name</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)</span>
        <span class="c1"># align cropped mask/area to fast dims (time, Y, X)</span>
        <span class="n">region_mask3</span> <span class="o">=</span> <span class="n">region_mask</span><span class="o">.</span><span class="n">broadcast_like</span><span class="p">(</span><span class="n">fast</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">area_km2_3</span>   <span class="o">=</span> <span class="n">area_km2</span><span class="o">.</span><span class="n">broadcast_like</span><span class="p">(</span><span class="n">fast</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="c1"># area at each time = sum( fast * region_mask * area )</span>
        <span class="n">fia_ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">fast</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">region_mask3</span><span class="p">)</span> <span class="o">*</span> <span class="n">area_km2_3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="n">jdim</span><span class="p">,</span> <span class="n">idim</span><span class="p">))</span>
        <span class="n">fia_ts</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;FIA_1e3-km2&quot;</span>
        <span class="n">fia_ts</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Fast-ice area (1e3-km^2) in region </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">, threshold&gt;=</span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">fia_ts</span></div>


    <span class="c1">####################################################################################################</span>
    <span class="c1">##                                          CCI SIT         </span>
    <span class="c1">####################################################################################################</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_norm_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">out</span> <span class="ow">or</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_days_in_month</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">12</span><span class="p">):</span> <span class="k">return</span> <span class="mi">31</span>
        <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">11</span><span class="p">):</span> <span class="k">return</span> <span class="mi">30</span>
        <span class="k">return</span> <span class="mi">29</span> <span class="k">if</span> <span class="p">((</span><span class="n">y</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">y</span> <span class="o">%</span> <span class="mi">400</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="k">else</span> <span class="mi">28</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_month_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">t0</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span> <span class="n">t1</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">)</span>
        <span class="n">last</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_days_in_month</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">m</span><span class="p">),</span> <span class="n">tz</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="n">last</span> <span class="o">&lt;</span> <span class="n">t0</span> <span class="ow">or</span> <span class="n">first</span> <span class="o">&gt;</span> <span class="n">t1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_yyyymmdd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">]:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?&lt;!\d)(20\d</span><span class="si">{2}</span><span class="s2">)(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])(?!\d)&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">mo</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">mo</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_yyyymm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]]:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?&lt;!\d)(20\d</span><span class="si">{2}</span><span class="s2">)(0[1-9]|1[0-2])(?!\d)&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

<div class="viewcode-block" id="SeaIceObservations.build_sea_ice_satellite_paths">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.build_sea_ice_satellite_paths">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_sea_ice_satellite_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                      <span class="n">dt0_str</span>      <span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                      <span class="n">dtN_str</span>      <span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                      <span class="n">hemisphere</span>   <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                      <span class="n">institutions</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;ESA&quot;</span><span class="p">,</span><span class="s2">&quot;AWI&quot;</span><span class="p">),</span>
                                      <span class="n">sensors</span>      <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>          <span class="c1"># [&quot;cryosat2&quot;,&quot;envisat&quot;,&quot;sentinel3a&quot;,&quot;sentinel3b&quot;]</span>
                                      <span class="n">levels</span>       <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>          <span class="c1"># ESA: [&quot;L2P&quot;,&quot;L3C&quot;]; AWI: [&quot;l2p_release&quot;,&quot;l3cp_release&quot;]</span>
                                      <span class="n">versions</span>     <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>          <span class="c1"># ESA only; and only &quot;v2.0&quot; or &quot;v3.0&quot;</span>
                                      <span class="n">root_esa</span>     <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                                      <span class="n">root_awi</span>     <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a de-duplicated, time-filtered list of NetCDF files for satellite sea-ice</span>
<span class="sd">        products across ESA and/or AWI directory layouts.</span>

<span class="sd">        Time filtering:</span>
<span class="sd">            - Returns files whose date/month lies within the closed interval</span>
<span class="sd">            [dt0_str, dtN_str], interpreted in UTC.</span>
<span class="sd">            - Daily products (e.g., ESA L2P) are filtered by date parsed from the filename</span>
<span class="sd">            (YYYYMMDD). Monthly products (e.g., ESA L3C or AWI monthly layout) are</span>
<span class="sd">            filtered by overlap between the (year, month) and [dt0, dtN].</span>

<span class="sd">        Supported directory patterns (walked automatically):</span>
<span class="sd">            ESA “flat” layout:</span>
<span class="sd">                &lt;root_esa&gt;/&lt;L2P|L3C&gt;/&lt;sensor&gt;/&lt;hemisphere&gt;/*.nc</span>
<span class="sd">                (hemisphere directory may be &#39;NH&#39;/&#39;SH&#39; or lowercase)</span>
<span class="sd">                - L2P: filenames contain YYYYMMDD</span>
<span class="sd">                - L3C: filenames often contain YYYYMM</span>

<span class="sd">            ESA versioned layout:</span>
<span class="sd">                &lt;root_esa&gt;/&lt;L2P|L3C&gt;/&lt;sensor&gt;/&lt;version&gt;/&lt;HEMISPHERE&gt;/&lt;YYYY&gt;/&lt;MM&gt;/*.nc</span>
<span class="sd">                (HEMISPHERE can be &#39;NH&#39;/&#39;SH&#39; or lowercase; &lt;MM&gt; subdirs may be absent)</span>

<span class="sd">            AWI release layout:</span>
<span class="sd">                &lt;root_awi&gt;/&lt;l2p_release|l3cp_release&gt;/&lt;hemisphere&gt;/&lt;sensor&gt;/&lt;YYYY&gt;[/&lt;MM&gt;]/*.nc</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dt0_str, dtN_str</span>
<span class="sd">            Start and end of the desired time window (inclusive). Any pandas-parsable</span>
<span class="sd">            string is accepted (e.g., &quot;2002-01-01&quot;, &quot;2012-12-31&quot;). Interpreted as UTC.</span>
<span class="sd">        hemisphere</span>
<span class="sd">            Hemisphere selector. If None, uses `self.hemisphere_dict[&#39;abbreviation&#39;]`.</span>
<span class="sd">            Case is normalized; both &#39;sh&#39;/&#39;nh&#39; and &#39;SH&#39;/&#39;NH&#39; are supported in dir scans.</span>
<span class="sd">        institutions</span>
<span class="sd">            Iterable of institutions to include (case-insensitive). Valid values include</span>
<span class="sd">            &quot;ESA&quot; and/or &quot;AWI&quot;. If None or empty, both are searched.</span>
<span class="sd">        sensors</span>
<span class="sd">            Optional iterable of sensor names to filter (case-insensitive, matched to</span>
<span class="sd">            directory names under the institution layout).</span>
<span class="sd">        levels</span>
<span class="sd">            Optional iterable of level strings. ESA: &quot;L2P&quot;, &quot;L3C&quot;.</span>
<span class="sd">            AWI: &quot;l2p_release&quot;, &quot;l3cp_release&quot;. If &quot;l2p&quot;/&quot;l3c&quot; are provided for AWI</span>
<span class="sd">            they are mapped to &quot;l2p_release&quot;/&quot;l3cp_release&quot;.</span>
<span class="sd">        versions</span>
<span class="sd">            ESA only: one or more version directory names (e.g., &quot;v2.0&quot;, &quot;v3.0&quot;).</span>
<span class="sd">            Case-insensitive. Ignored for AWI.</span>
<span class="sd">        root_esa, root_awi</span>
<span class="sd">            Root directories for ESA and AWI datasets.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List[Path]</span>
<span class="sd">            Sorted unique list of file paths within the requested time window that</span>
<span class="sd">            satisfy the filters.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Filename parsing assumes dates follow YYYYMMDD (daily) or YYYYMM (monthly)</span>
<span class="sd">        within 2000–2099. Files without such tokens are kept only when they live in</span>
<span class="sd">        a year/month directory that overlaps [dt0, dtN].</span>
<span class="sd">        - If `institutions` is None or empty, both ESA and AWI are scanned.</span>
<span class="sd">        - All timestamps are treated as UTC to avoid tz-comparison issues.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; paths = self.build_sea_ice_satellite_paths(</span>
<span class="sd">        ...     &quot;2002-01-01&quot;, &quot;2002-12-31&quot;,</span>
<span class="sd">        ...     hemisphere=&quot;sh&quot;,</span>
<span class="sd">        ...     institutions=[&quot;ESA&quot;, &quot;AWI&quot;],</span>
<span class="sd">        ...     sensors=[&quot;cryosat2&quot;, &quot;envisat&quot;],</span>
<span class="sd">        ...     levels=[&quot;L2P&quot;,&quot;L3C&quot;,&quot;l2p_release&quot;]</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; len(paths), paths[:3]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dt0_str</span> <span class="o">=</span> <span class="n">dt0_str</span> <span class="k">if</span> <span class="n">dt0_str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt0_str</span>
        <span class="n">dtN_str</span> <span class="o">=</span> <span class="n">dtN_str</span> <span class="k">if</span> <span class="n">dtN_str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtN_str</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">dt0_str</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">dtN_str</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t1</span> <span class="o">&lt;</span> <span class="n">t0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dtN_str date must be &gt;= dt0_str date&quot;</span><span class="p">)</span>
        <span class="n">hem</span> <span class="o">=</span> <span class="n">hemisphere</span> <span class="k">if</span> <span class="n">hemisphere</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">hemisphere_dict</span><span class="p">[</span><span class="s2">&quot;abbreviation&quot;</span><span class="p">]</span>
        <span class="n">hem_upper</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">hem</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">hem_lower</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">hem</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">hem_dirs_esa</span> <span class="o">=</span> <span class="p">[</span><span class="n">hem_upper</span><span class="p">,</span> <span class="n">hem_lower</span><span class="p">]</span>  <span class="c1"># try both cases for ESA</span>
        <span class="n">root_esa</span> <span class="o">=</span> <span class="n">root_esa</span> <span class="k">if</span> <span class="n">root_esa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sea_Ice_Obs_dict</span><span class="p">[</span><span class="s1">&#39;ESA-CCI&#39;</span><span class="p">]</span>
        <span class="n">root_awi</span> <span class="o">=</span> <span class="n">root_awi</span> <span class="k">if</span> <span class="n">root_awi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sea_Ice_Obs_dict</span><span class="p">[</span><span class="s1">&#39;AWI&#39;</span><span class="p">]</span>
        <span class="n">root_esa</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">root_esa</span><span class="p">)</span>
        <span class="n">root_awi</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">root_awi</span><span class="p">)</span>
        <span class="c1"># filters (case-normalized)</span>
        <span class="n">insts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_norm_list</span><span class="p">(</span><span class="n">institutions</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]))</span>
        <span class="n">sensor_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_norm_list</span><span class="p">(</span><span class="n">sensors</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]))</span> <span class="k">if</span> <span class="n">sensors</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">version_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_norm_list</span><span class="p">(</span><span class="n">versions</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]))</span> <span class="k">if</span> <span class="n">versions</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">level_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_norm_list</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]))</span> <span class="k">if</span> <span class="n">levels</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># ---------------- ESA ----------------</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">insts</span> <span class="ow">or</span> <span class="s2">&quot;ESA&quot;</span> <span class="ow">in</span> <span class="n">insts</span><span class="p">:</span>
            <span class="n">esa_levels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;L2P&quot;</span><span class="p">,</span> <span class="s2">&quot;L3C&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">level_set</span> <span class="k">else</span> <span class="p">([</span><span class="n">L</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">L</span> <span class="ow">in</span> <span class="n">level_set</span> <span class="k">if</span> <span class="n">L</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;L2P&quot;</span><span class="p">,</span> <span class="s2">&quot;L3C&quot;</span><span class="p">)]</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;L2P&quot;</span><span class="p">,</span> <span class="s2">&quot;L3C&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">L</span> <span class="ow">in</span> <span class="n">esa_levels</span><span class="p">:</span>
                <span class="n">Ldir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">root_esa</span><span class="p">,</span><span class="n">L</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">Ldir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="k">continue</span>
                <span class="c1"># &lt;root&gt;/&lt;L&gt;/&lt;sensor&gt;/...</span>
                <span class="k">for</span> <span class="n">sdir</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">Ldir</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()):</span>
                    <span class="n">sensor</span> <span class="o">=</span> <span class="n">sdir</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">sensor_set</span> <span class="ow">and</span> <span class="n">sensor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sensor_set</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="c1"># A) flat: .../L2P|L3C/&lt;sensor&gt;/&lt;hem&gt;/*.nc   (hem &#39;nh&#39;/&#39;sh&#39; any case)</span>
                    <span class="k">for</span> <span class="n">hem_dir</span> <span class="ow">in</span> <span class="n">hem_dirs_esa</span><span class="p">:</span>
                        <span class="n">flat_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">sdir</span><span class="p">,</span><span class="n">hem_dir</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">flat_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                            <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">flat_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.nc&quot;</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">L</span> <span class="o">==</span> <span class="s2">&quot;L2P&quot;</span><span class="p">:</span>
                                    <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_yyyymmdd</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">ts</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ts</span> <span class="o">&lt;</span> <span class="n">t0</span> <span class="ow">or</span> <span class="n">ts</span> <span class="o">&gt;</span> <span class="n">t1</span><span class="p">:</span>
                                        <span class="k">continue</span>
                                <span class="k">else</span><span class="p">:</span>  <span class="c1"># L3C</span>
                                    <span class="n">ym</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_yyyymm</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">ym</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_month_overlap</span><span class="p">(</span><span class="n">ym</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ym</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">):</span>
                                        <span class="k">continue</span>
                                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
                    <span class="c1"># B) versioned: .../L2P|L3C/&lt;sensor&gt;/&lt;ver&gt;/&lt;HEM&gt;/YYYY/MM/*.nc</span>
                    <span class="k">for</span> <span class="n">vdir</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sdir</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()):</span>
                        <span class="n">vname</span> <span class="o">=</span> <span class="n">vdir</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="c1"># skip if this &#39;vdir&#39; is actually the hemisphere dir from flat layout</span>
                        <span class="k">if</span> <span class="n">vname</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;nh&quot;</span><span class="p">,</span> <span class="s2">&quot;sh&quot;</span><span class="p">}:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">version_set</span> <span class="ow">and</span> <span class="n">vname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">version_set</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">for</span> <span class="n">hem_dir</span> <span class="ow">in</span> <span class="n">hem_dirs_esa</span><span class="p">:</span>
                            <span class="n">hdir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">vdir</span><span class="p">,</span><span class="n">hem_dir</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">hdir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                                <span class="k">continue</span>
                            <span class="k">for</span> <span class="n">ydir</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">hdir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;[12][0-9][0-9][0-9]&quot;</span><span class="p">)):</span>
                                <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ydir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                <span class="n">mdirs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">ydir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;[01][0-9]&quot;</span><span class="p">)))</span>
                                <span class="k">if</span> <span class="n">mdirs</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">mdir</span> <span class="ow">in</span> <span class="n">mdirs</span><span class="p">:</span>
                                        <span class="n">m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mdir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_month_overlap</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">):</span>
                                            <span class="k">continue</span>
                                        <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">mdir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.nc&quot;</span><span class="p">)):</span>
                                            <span class="k">if</span> <span class="n">L</span> <span class="o">==</span> <span class="s2">&quot;L2P&quot;</span><span class="p">:</span>
                                                <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_yyyymmdd</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                                <span class="k">if</span> <span class="n">ts</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ts</span> <span class="o">&lt;</span> <span class="n">t0</span> <span class="ow">or</span> <span class="n">ts</span> <span class="o">&gt;</span> <span class="n">t1</span><span class="p">:</span>
                                                    <span class="k">continue</span>
                                            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ydir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.nc&quot;</span><span class="p">)):</span>
                                        <span class="k">if</span> <span class="n">L</span> <span class="o">==</span> <span class="s2">&quot;L2P&quot;</span><span class="p">:</span>
                                            <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_yyyymmdd</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                            <span class="k">if</span> <span class="n">ts</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ts</span> <span class="o">&lt;</span> <span class="n">t0</span> <span class="ow">or</span> <span class="n">ts</span> <span class="o">&gt;</span> <span class="n">t1</span><span class="p">:</span>
                                                <span class="k">continue</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">ym</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_yyyymm</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                            <span class="k">if</span> <span class="n">ym</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_month_overlap</span><span class="p">(</span><span class="n">ym</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ym</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">):</span>
                                                <span class="k">continue</span>
                                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="c1"># ---------------- AWI ----------------</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">insts</span> <span class="ow">or</span> <span class="s2">&quot;AWI&quot;</span> <span class="ow">in</span> <span class="n">insts</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">level_set</span><span class="p">:</span>
                <span class="n">awi_levels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;l2p_release&quot;</span><span class="p">,</span> <span class="s2">&quot;l3cp_release&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># map friendly ESA-like inputs to AWI release names</span>
                <span class="n">canonical</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">L</span> <span class="ow">in</span> <span class="n">level_set</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">l</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;l2p_release&quot;</span><span class="p">,</span> <span class="s2">&quot;l3cp_release&quot;</span><span class="p">):</span>
                        <span class="n">canonical</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">l</span> <span class="o">==</span> <span class="s2">&quot;l2p&quot;</span><span class="p">:</span>
                        <span class="n">canonical</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;l2p_release&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">l</span> <span class="o">==</span> <span class="s2">&quot;l3c&quot;</span><span class="p">:</span>
                        <span class="n">canonical</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;l3cp_release&quot;</span><span class="p">)</span>
                <span class="n">awi_levels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">canonical</span><span class="p">))</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;l2p_release&quot;</span><span class="p">,</span> <span class="s2">&quot;l3cp_release&quot;</span><span class="p">]</span>
            <span class="n">LHEM</span> <span class="o">=</span> <span class="n">hem_lower</span>  <span class="c1"># AWI uses lower-case hemisphere dirs</span>
            <span class="k">for</span> <span class="n">Lraw</span> <span class="ow">in</span> <span class="n">awi_levels</span><span class="p">:</span>
                <span class="n">Ldir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">root_awi</span><span class="p">,</span><span class="n">Lraw</span><span class="p">,</span><span class="n">LHEM</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">Ldir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">sdir</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">Ldir</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()):</span>
                    <span class="n">sensor</span> <span class="o">=</span> <span class="n">sdir</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">sensor_set</span> <span class="ow">and</span> <span class="n">sensor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sensor_set</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">for</span> <span class="n">ydir</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sdir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;[12][0-9][0-9][0-9]&quot;</span><span class="p">)):</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ydir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">mdirs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">ydir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;[01][0-9]&quot;</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="n">mdirs</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">mdir</span> <span class="ow">in</span> <span class="n">mdirs</span><span class="p">:</span>
                                <span class="n">m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mdir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_month_overlap</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">):</span>
                                    <span class="k">continue</span>
                                <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">mdir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.nc&quot;</span><span class="p">)))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># year-only dir; filter by yyyymm in filenames when available</span>
                            <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ydir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.nc&quot;</span><span class="p">)):</span>
                                <span class="n">ym</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_yyyymm</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">ym</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_month_overlap</span><span class="p">(</span><span class="n">ym</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ym</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">):</span>
                                    <span class="k">continue</span>
                                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="c1"># de-dup &amp; sort</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">out</span><span class="p">))</span></div>


    <span class="c1"># ------------------------- map grids (LAEA/EASE-like) ------------------------- #</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_match_lon_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon_1d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">grid_lon_2d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Map swath longitudes to the same wrap as the target grid.&quot;&quot;&quot;</span>
        <span class="n">gmin</span><span class="p">,</span> <span class="n">gmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">grid_lon_2d</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">grid_lon_2d</span><span class="p">)</span>
        <span class="n">grid_is_180</span> <span class="o">=</span> <span class="p">(</span><span class="n">gmin</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mf">180.0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">gmax</span> <span class="o">&lt;=</span> <span class="mf">180.0</span><span class="p">)</span>
        <span class="n">lon_a</span> <span class="o">=</span> <span class="p">((</span><span class="n">lon_1d</span> <span class="o">+</span> <span class="mf">180.0</span><span class="p">)</span> <span class="o">%</span> <span class="mf">360.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">180.0</span>   <span class="c1"># [-180, 180)</span>
        <span class="n">lon_b</span> <span class="o">=</span> <span class="n">lon_1d</span> <span class="o">%</span> <span class="mf">360.0</span>                       <span class="c1"># [0, 360)</span>
        <span class="n">lon_b</span><span class="p">[</span><span class="n">lon_b</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">360.0</span>
        <span class="c1"># pick the representation whose range best matches the grid</span>
        <span class="k">if</span> <span class="n">grid_is_180</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">lon_a</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">lon_b</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_first</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">names</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ds</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="SeaIceObservations.laea_area_def">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.laea_area_def">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">laea_area_def</span><span class="p">(</span><span class="n">hem</span>   <span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">nx</span>    <span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                      <span class="n">ny</span>    <span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                      <span class="n">dx_km</span> <span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                      <span class="n">lon0</span>  <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a Lambert Azimuthal Equal-Area grid centered on the pole.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hem : {&#39;sh&#39;,&#39;nh&#39;}</span>
<span class="sd">            Hemisphere.</span>
<span class="sd">        nx, ny : int</span>
<span class="sd">            Grid shape (x, y).</span>
<span class="sd">        dx_km : float</span>
<span class="sd">            Grid spacing in kilometers (projected meters).</span>
<span class="sd">        lon0 : float, default 0.0</span>
<span class="sd">            Central longitude (°E). ESA products commonly use 0.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pyresample.geometry.AreaDefinition</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">geometry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;pyresample is required: `pip install pyresample`&quot;</span><span class="p">)</span>
        <span class="n">hem</span>       <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">hem</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">lat0</span>      <span class="o">=</span> <span class="o">-</span><span class="mf">90.0</span> <span class="k">if</span> <span class="n">hem</span> <span class="o">==</span> <span class="s2">&quot;sh&quot;</span> <span class="k">else</span> <span class="mf">90.0</span>
        <span class="n">proj_id</span>   <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;laea_</span><span class="si">{</span><span class="n">hem</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">dx_km</span><span class="p">)</span><span class="si">}</span><span class="s2">km_</span><span class="si">{</span><span class="n">nx</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">ny</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">proj_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;proj&quot;</span>    <span class="p">:</span> <span class="s2">&quot;laea&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;lat_0&quot;</span>   <span class="p">:</span> <span class="n">lat0</span><span class="p">,</span>
                     <span class="s2">&quot;lon_0&quot;</span>   <span class="p">:</span> <span class="n">lon0</span><span class="p">,</span>
                     <span class="s2">&quot;a&quot;</span>       <span class="p">:</span> <span class="mf">6378137.0</span><span class="p">,</span>
                     <span class="s2">&quot;b&quot;</span>       <span class="p">:</span> <span class="mf">6356752.314245</span><span class="p">,</span>
                     <span class="s2">&quot;units&quot;</span>   <span class="p">:</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;no_defs&quot;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="c1"># extent centered on the pole</span>
        <span class="n">half_w</span>      <span class="o">=</span> <span class="p">(</span><span class="n">nx</span> <span class="o">*</span> <span class="n">dx_km</span> <span class="o">*</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">half_h</span>      <span class="o">=</span> <span class="p">(</span><span class="n">ny</span> <span class="o">*</span> <span class="n">dx_km</span> <span class="o">*</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">area_extent</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">half_w</span><span class="p">,</span> <span class="o">-</span><span class="n">half_h</span><span class="p">,</span> <span class="n">half_w</span><span class="p">,</span> <span class="n">half_h</span><span class="p">)</span>
        <span class="n">area_id</span>     <span class="o">=</span> <span class="n">proj_id</span>
        <span class="n">description</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;LAEA </span><span class="si">{</span><span class="n">hem</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">dx_km</span><span class="si">}</span><span class="s2">km </span><span class="si">{</span><span class="n">nx</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">ny</span><span class="si">}</span><span class="s2"> lon0=</span><span class="si">{</span><span class="n">lon0</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">geometry</span><span class="o">.</span><span class="n">AreaDefinition</span><span class="p">(</span><span class="n">area_id</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">proj_id</span><span class="p">,</span> <span class="n">proj_dict</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">area_extent</span><span class="p">)</span></div>


<div class="viewcode-block" id="SeaIceObservations.ease2_sh_50km">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.ease2_sh_50km">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ease2_sh_50km</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convenience grid roughly matching AWI SH L3C (216×216 @ ~50 km, lon0=0).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">SeaIceObservations</span><span class="o">.</span><span class="n">laea_area_def</span><span class="p">(</span><span class="s2">&quot;sh&quot;</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="mi">216</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="mi">216</span><span class="p">,</span> <span class="n">dx_km</span><span class="o">=</span><span class="mf">50.0</span><span class="p">,</span> <span class="n">lon0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span></div>


<div class="viewcode-block" id="SeaIceObservations.ease2_nh_25km">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.ease2_nh_25km">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ease2_nh_25km</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convenience grid for NH (432×432 @ ~25 km, lon0=0).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">SeaIceObservations</span><span class="o">.</span><span class="n">laea_area_def</span><span class="p">(</span><span class="s2">&quot;nh&quot;</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="mi">432</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="mi">432</span><span class="p">,</span> <span class="n">dx_km</span><span class="o">=</span><span class="mf">25.0</span><span class="p">,</span> <span class="n">lon0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span></div>


    <span class="c1"># ------------------------- file path indexing &amp; QA helpers ------------------------- #</span>
<div class="viewcode-block" id="SeaIceObservations.index_satellite_paths">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.index_satellite_paths">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">index_satellite_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a tidy index of satellite files with parsed dates for QA/QC and selection.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame</span>
<span class="sd">            Columns:</span>
<span class="sd">              - path: Path</span>
<span class="sd">              - kind: {&quot;daily&quot;,&quot;monthly&quot;,&quot;unknown&quot;}</span>
<span class="sd">              - date: UTC Timestamp (daily) or first-of-month (monthly) or NaT</span>
<span class="sd">              - year, month, day: ints or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="n">Path</span><span class="p">,</span> <span class="n">paths</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_yyyymmdd</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span> <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;daily&quot;</span><span class="p">,</span>
                             <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">ts</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">ts</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">ts</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="n">ts</span><span class="o">.</span><span class="n">day</span><span class="p">})</span>
                <span class="k">continue</span>
            <span class="n">ym</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_yyyymm</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ym</span><span class="p">:</span>
                <span class="n">y</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">ym</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span> <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;monthly&quot;</span><span class="p">,</span>
                             <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">),</span>
                             <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">m</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span> <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
                             <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
        <span class="c1"># Stable sort so &#39;first&#39;/&#39;last&#39; are deterministic</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span>          <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">],</span>
                            <span class="n">na_position</span> <span class="o">=</span> <span class="s2">&quot;last&quot;</span><span class="p">,</span>
                            <span class="n">kind</span>        <span class="o">=</span> <span class="s2">&quot;mergesort&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="SeaIceObservations.dedup_daily_one_file_per_day">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.dedup_daily_one_file_per_day">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">dedup_daily_one_file_per_day</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">prefer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;last&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        From an indexed DataFrame (see index_satellite_paths), select one file per day.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : DataFrame</span>
<span class="sd">            Output of `index_satellite_paths`.</span>
<span class="sd">        prefer : {&quot;first&quot;,&quot;last&quot;}, default &quot;last&quot;</span>
<span class="sd">            If multiple files map to the same day, choose the first/last after sorting.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DataFrame</span>
<span class="sd">            Subset of `df` with kind == &quot;daily&quot; and unique &#39;date&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dfd</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;daily&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dfd</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dfd</span>
        <span class="n">dfd</span>  <span class="o">=</span> <span class="n">dfd</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">])</span>
        <span class="n">pick</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;first&quot;</span><span class="p">:</span> <span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="s2">&quot;last&quot;</span><span class="p">:</span> <span class="s2">&quot;last&quot;</span><span class="p">}[</span><span class="n">prefer</span><span class="p">]</span>
        <span class="n">dfd</span>  <span class="o">=</span> <span class="n">dfd</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pick</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dfd</span></div>


    <span class="c1"># ------------------------- LEVEL 2 (DAILY UN-GRIDDED) ------------------------- #</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_l2p_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">index_array</span><span class="p">,</span>                 <span class="c1"># masked or ndarray; shape (k,n_out) OR (n_out,k)</span>
                     <span class="n">dist_array</span><span class="p">,</span>                  <span class="c1"># masked or ndarray; same shape/orientation</span>
                     <span class="n">valid_input_index</span><span class="p">,</span>           <span class="c1"># (Nvalid_in,)</span>
                     <span class="n">valid_output_index</span><span class="p">,</span>          <span class="c1"># (n_out,) ints OR bool mask of length ny*nx</span>
                     <span class="n">swath_SIT</span><span class="p">,</span>                   <span class="c1"># (Nswath,)</span>
                     <span class="n">swath_unc</span><span class="p">,</span>                   <span class="c1"># (Nswath,)</span>
                     <span class="n">out_shape</span> <span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>  <span class="c1"># (ny, nx)</span>
                     <span class="n">roi_m</span>     <span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                     <span class="n">sigma_m</span>   <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">out_shape</span>
        <span class="c1"># reduce sources to KD-tree&#39;s valid input subset</span>
        <span class="n">src_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">swath_SIT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)[</span><span class="n">valid_input_index</span><span class="p">]</span>
        <span class="n">src_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">swath_unc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)[</span><span class="n">valid_input_index</span><span class="p">]</span>
        <span class="c1"># normalise valid_output_index → integer flat indices</span>
        <span class="n">voi</span>            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">valid_output_index</span><span class="p">)</span>
        <span class="n">out_idx</span>        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">voi</span><span class="p">)</span> <span class="k">if</span> <span class="n">voi</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">bool</span> <span class="k">else</span> <span class="n">voi</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">n_out_expected</span> <span class="o">=</span> <span class="n">out_idx</span><span class="o">.</span><span class="n">size</span>
        <span class="c1"># fill masked arrays to ndarrays + build &quot;exists&quot; mask</span>
        <span class="n">idx</span>          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">index_array</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">dst</span>          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">dist_array</span><span class="p">,</span>  <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">neigh_exists</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">index_array</span><span class="p">)</span>
        <span class="c1"># orient to (k, n_out) i.e. neighbours along axis 0</span>
        <span class="k">if</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">n_out_expected</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">n_out_expected</span><span class="p">:</span>
            <span class="n">idx</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">neigh_exists</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dst</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">neigh_exists</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Neighbour array shape </span><span class="si">{</span><span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> incompatible with n_out=</span><span class="si">{</span><span class="n">n_out_expected</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">n_out</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">n_out</span> <span class="o">!=</span> <span class="n">n_out_expected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Internal n_out mismatch: </span><span class="si">{</span><span class="n">n_out</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">n_out_expected</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># gather neighbour values from reduced swath</span>
        <span class="n">v_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">src_s</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;clip&quot;</span><span class="p">)</span>    <span class="c1"># (k, n_out)</span>
        <span class="n">v_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">src_u</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;clip&quot;</span><span class="p">)</span>    <span class="c1"># (k, n_out)</span>
        <span class="c1"># validity</span>
        <span class="n">within_roi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dst</span> <span class="o">&lt;=</span> <span class="n">roi_m</span><span class="p">)</span>
        <span class="n">val_ok</span>     <span class="o">=</span> <span class="n">neigh_exists</span> <span class="o">&amp;</span> <span class="n">within_roi</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">v_s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">v_u</span><span class="p">)</span>
        <span class="c1"># weights</span>
        <span class="k">if</span> <span class="n">sigma_m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">val_ok</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">val_ok</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">dst</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">sigma_m</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="c1"># reductions along neighbour axis</span>
        <span class="n">wsum</span>     <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sitnum</span>   <span class="o">=</span> <span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">v_s</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">umean</span>    <span class="o">=</span> <span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">v_u</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">senum</span>    <span class="o">=</span> <span class="p">((</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">v_u</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">n_cnt</span>    <span class="o">=</span> <span class="n">val_ok</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int32&quot;</span><span class="p">)</span>
        <span class="n">sit_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">sitnum</span><span class="p">,</span> <span class="n">wsum</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">wsum</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">where</span><span class="o">=</span><span class="n">wsum</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">u_mean</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">umean</span><span class="p">,</span>  <span class="n">wsum</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">wsum</span><span class="p">,</span>  <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">where</span><span class="o">=</span><span class="n">wsum</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">se_mean</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">senum</span><span class="p">),</span> <span class="n">wsum</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">wsum</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">where</span><span class="o">=</span><span class="n">wsum</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># scatter back to flat arrays</span>
        <span class="n">nflat</span>        <span class="o">=</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">nx</span>
        <span class="n">SIT_flat</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nflat</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
        <span class="n">SIT_unc_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nflat</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
        <span class="n">U_cell_flat</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nflat</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
        <span class="n">N_cell_flat</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nflat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int32&quot;</span><span class="p">)</span>
        <span class="n">SIT_flat</span><span class="p">[</span><span class="n">out_idx</span><span class="p">]</span>     <span class="o">=</span> <span class="n">sit_mean</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">SIT_unc_flat</span><span class="p">[</span><span class="n">out_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">se_mean</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">U_cell_flat</span><span class="p">[</span><span class="n">out_idx</span><span class="p">]</span>  <span class="o">=</span> <span class="n">u_mean</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">N_cell_flat</span><span class="p">[</span><span class="n">out_idx</span><span class="p">]</span>  <span class="o">=</span> <span class="n">n_cnt</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">SIT_flat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">),</span>
                <span class="n">SIT_unc_flat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">),</span>
                <span class="n">U_cell_flat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">),</span>
                <span class="n">N_cell_flat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">))</span>

    <span class="c1"># ------------------------- main driver ------------------------- #</span>
<div class="viewcode-block" id="SeaIceObservations.l2p_to_daily_grid_pyresample">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.l2p_to_daily_grid_pyresample">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">l2p_to_daily_grid_pyresample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                     <span class="n">paths</span>             <span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span>
                                     <span class="n">hem</span>               <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                     <span class="n">area_def</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                     <span class="n">roi_km</span>            <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">75.0</span><span class="p">,</span>
                                     <span class="n">neighbours</span>        <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
                                     <span class="n">epsilon</span>           <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                                     <span class="n">gaussian_sigma_km</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                     <span class="n">lat_cut</span>           <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                     <span class="n">time_at_noon</span>      <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;     </span>
<span class="sd">        Resample ESA/AWI **L2P swath** files to a **daily gridded** product on an</span>
<span class="sd">        equal-area polar grid using pyresample nearest-neighbour sets.</span>

<span class="sd">        The algorithm:</span>
<span class="sd">        1) Group all valid swath samples by UTC day (per file) using `time` variable.</span>
<span class="sd">        2) For each day:</span>
<span class="sd">           - Build a SwathDefinition from lon/lat points.</span>
<span class="sd">           - Use `pyresample.kd_tree.get_neighbour_info` to find up to `neighbours`</span>
<span class="sd">             candidates within `roi_km` of each grid cell.</span>
<span class="sd">           - Combine neighbour SIT &amp; uncertainty with uniform or Gaussian weights.</span>
<span class="sd">        3) Assemble (time, y, x) arrays and compute hemispheric daily means with</span>
<span class="sd">           cos(latitude) weights.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        paths : list of Path</span>
<span class="sd">            L2P NetCDF files. Each must include variables:</span>
<span class="sd">            `sea_ice_thickness`, `sea_ice_thickness_uncertainty`, `lon`, `lat`, `time`.</span>
<span class="sd">        hem : {&#39;sh&#39;,&#39;nh&#39;}, optional</span>
<span class="sd">            Hemisphere. Defaults to `self.hemisphere_dict[&#39;abbreviation&#39;]` when present,</span>
<span class="sd">            else &#39;sh&#39;.</span>
<span class="sd">        area_def : pyresample.geometry.AreaDefinition, optional</span>
<span class="sd">            Target equal-area grid. If None, uses `ease2_sh_50km()` for SH or</span>
<span class="sd">            `ease2_nh_25km()` for NH.</span>
<span class="sd">        roi_km : float, default 75.0</span>
<span class="sd">            Radius of influence for neighbour search (kilometres).</span>
<span class="sd">        neighbours : int, default 16</span>
<span class="sd">            Max neighbours per grid cell from KD-tree.</span>
<span class="sd">        epsilon : float, default 0.0</span>
<span class="sd">            Search tolerance passed to pyresample (trade accuracy vs. speed).</span>
<span class="sd">        gaussian_sigma_km : float or None, default None</span>
<span class="sd">            If set, apply Gaussian weights with this sigma (km); otherwise uniform.</span>
<span class="sd">        lat_cut : float or None, default None</span>
<span class="sd">            Optional extra swath mask: for SH keep `lat &lt;= lat_cut`; for NH keep</span>
<span class="sd">            `lat &gt;= lat_cut`. Useful for excluding marginal seas.</span>
<span class="sd">        time_at_noon : bool, default True</span>
<span class="sd">            If True, time coordinate is day+12:00Z; else midnight.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.Dataset</span>
<span class="sd">            Dimensions: time, y, x</span>
<span class="sd">            Coordinates: lon(y,x), lat(y,x), time</span>
<span class="sd">            Data variables:</span>
<span class="sd">                SIT(time,y,x)       [m]</span>
<span class="sd">                SIT_unc(time,y,x)   [m] propagated standard error</span>
<span class="sd">                u_cell(time,y,x)    [m] per-cell uncertainty mean (neighbour-weighted)</span>
<span class="sd">                n_cell(time,y,x)    [#] count of contributing neighbours per cell</span>
<span class="sd">                SIT_hem(time)       [m] hemispheric mean</span>
<span class="sd">                SIT_hem_unc(time)   [m] propagated SE for hemispheric mean</span>
<span class="sd">                SIT_hem_u(time)     [m] hemispheric mean of per-cell uncertainty</span>
<span class="sd">                SIT_hem_n(time)     [#] total contributing neighbours (sum over grid)</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Hemispheric means use cos(lat) weights on the target grid after resampling.</span>
<span class="sd">        - Propagated SE follows: sqrt(sum(w^2 * se^2)) / sum(w).</span>
<span class="sd">        - Files missing required variables are skipped (warning).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">geometry</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">kd_tree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;pyresample is required: `pip install pyresample`&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">paths</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No L2P paths provided&quot;</span><span class="p">)</span>
        <span class="n">hem</span> <span class="o">=</span> <span class="p">(</span><span class="n">hem</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">hemisphere_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;abbreviation&quot;</span><span class="p">,</span> <span class="s2">&quot;sh&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">area_def</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">area_def</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ease2_sh_50km</span><span class="p">()</span> <span class="k">if</span> <span class="n">hem</span> <span class="o">==</span> <span class="s2">&quot;sh&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ease2_nh_25km</span><span class="p">()</span>
        <span class="c1"># grid lon/lat for metadata &amp; hemispheric weights</span>
        <span class="n">lons2d</span><span class="p">,</span> <span class="n">lats2d</span> <span class="o">=</span> <span class="n">area_def</span><span class="o">.</span><span class="n">get_lonlats</span><span class="p">()</span>
        <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">area_def</span><span class="o">.</span><span class="n">shape</span>
        <span class="c1"># collect swath samples by UTC day</span>
        <span class="n">by_day</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">Path</span><span class="p">,</span> <span class="n">paths</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">{})</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
                    <span class="n">required</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;sea_ice_thickness&quot;</span><span class="p">,</span> <span class="s2">&quot;sea_ice_thickness_uncertainty&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">variables</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">required</span><span class="p">):</span>
                        <span class="c1"># skip quietly if this file is not SIT L2P</span>
                        <span class="k">continue</span>
                    <span class="n">sit_da</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_first</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;sea_ice_thickness&quot;</span><span class="p">,</span> <span class="s2">&quot;SIT&quot;</span><span class="p">,</span> <span class="s2">&quot;sit&quot;</span><span class="p">])</span>
                    <span class="n">unc_da</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_first</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;sea_ice_thickness_uncertainty&quot;</span><span class="p">,</span> <span class="s2">&quot;SIT_unc&quot;</span><span class="p">,</span> <span class="s2">&quot;uncertainty&quot;</span><span class="p">])</span>
                    <span class="n">lon_da</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_first</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">])</span>
                    <span class="n">lat_da</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_first</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;latitude&quot;</span><span class="p">])</span>
                    <span class="n">tim_da</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_first</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;acquisition_time&quot;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">sit_da</span><span class="p">,</span> <span class="n">unc_da</span><span class="p">,</span> <span class="n">lon_da</span><span class="p">,</span> <span class="n">lat_da</span><span class="p">,</span> <span class="n">tim_da</span><span class="p">)):</span>
                        <span class="c1"># Skip quietly if not an SIT L2P file</span>
                        <span class="k">continue</span>
                    <span class="n">sit</span> <span class="o">=</span> <span class="n">sit_da</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">unc</span> <span class="o">=</span> <span class="n">unc_da</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">lon</span> <span class="o">=</span> <span class="n">lon_da</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">lon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_lon_range</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lons2d</span><span class="p">)</span>
                    <span class="n">lat</span> <span class="o">=</span> <span class="n">lat_da</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">tt</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">tim_da</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># unreadable file: skip</span>
                <span class="k">continue</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">sit</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">unc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lat_cut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">valid</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">lat</span> <span class="o">&lt;=</span> <span class="n">lat_cut</span><span class="p">)</span> <span class="k">if</span> <span class="n">hem</span> <span class="o">==</span> <span class="s2">&quot;sh&quot;</span> <span class="k">else</span> <span class="p">(</span><span class="n">lat</span> <span class="o">&gt;=</span> <span class="n">lat_cut</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">valid</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[skip] </span><span class="si">{</span><span class="n">fp</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: finite(sit)=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">sit</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;finite(lon)=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> finite(lat)=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">sit</span><span class="p">,</span> <span class="n">unc</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">tt</span> <span class="o">=</span> <span class="n">sit</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span> <span class="n">unc</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span> <span class="n">lon</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span> <span class="n">lat</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span> <span class="n">tt</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
            <span class="n">days</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">days</span><span class="p">):</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="p">(</span><span class="n">days</span> <span class="o">==</span> <span class="n">d</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">sel</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">dkey</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">)</span>
                <span class="n">rec</span> <span class="o">=</span> <span class="n">by_day</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">dkey</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">sit</span><span class="o">=</span><span class="p">[],</span> <span class="n">unc</span><span class="o">=</span><span class="p">[],</span> <span class="n">lon</span><span class="o">=</span><span class="p">[],</span> <span class="n">lat</span><span class="o">=</span><span class="p">[]))</span>
                <span class="n">rec</span><span class="p">[</span><span class="s2">&quot;sit&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sit</span><span class="p">[</span><span class="n">sel</span><span class="p">])</span>
                <span class="n">rec</span><span class="p">[</span><span class="s2">&quot;unc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unc</span><span class="p">[</span><span class="n">sel</span><span class="p">])</span>
                <span class="n">rec</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="n">sel</span><span class="p">])</span>
                <span class="n">rec</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="n">sel</span><span class="p">])</span>
        <span class="c1"># empty output if nothing usable</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">by_day</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
                <span class="n">coords</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;datetime64[ns]&quot;</span><span class="p">)),</span>
                            <span class="n">y</span>    <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)),</span>
                            <span class="n">x</span>    <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)),</span>
                            <span class="n">lon</span>  <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">lons2d</span><span class="p">),</span>
                            <span class="n">lat</span>  <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">lats2d</span><span class="p">)))</span>
        <span class="n">roi_m</span> <span class="o">=</span> <span class="n">roi_km</span> <span class="o">*</span> <span class="mf">1000.0</span>
        <span class="n">sigma_m</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">gaussian_sigma_km</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">gaussian_sigma_km</span> <span class="o">*</span> <span class="mf">1000.0</span>
        <span class="c1"># allocate outputs</span>
        <span class="n">days_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">by_day</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">T</span>           <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">days_sorted</span><span class="p">)</span>
        <span class="n">SIT</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">T</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
        <span class="n">SIT_unc</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">T</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
        <span class="n">U_cell</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">T</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
        <span class="n">N_cell</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">T</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int32&quot;</span><span class="p">)</span>
        <span class="c1"># time coordinate</span>
        <span class="k">if</span> <span class="n">time_at_noon</span><span class="p">:</span>
            <span class="n">tcoord</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">date</span><span class="p">())</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s2">&quot;UTC&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">days_sorted</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tcoord</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">date</span><span class="p">())</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s2">&quot;UTC&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">days_sorted</span><span class="p">]</span>
        <span class="n">tcoord</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">tcoord</span><span class="p">)</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="c1"># resample per day</span>
        <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">days_sorted</span><span class="p">):</span>
            <span class="n">s</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">by_day</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="s2">&quot;sit&quot;</span><span class="p">])</span>
            <span class="n">u</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">by_day</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="s2">&quot;unc&quot;</span><span class="p">])</span>
            <span class="n">lo</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">by_day</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="s2">&quot;lon&quot;</span><span class="p">])</span>
            <span class="n">la</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">by_day</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="s2">&quot;lat&quot;</span><span class="p">])</span>
            <span class="n">swath</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">SwathDefinition</span><span class="p">(</span><span class="n">lons</span><span class="o">=</span><span class="n">lo</span><span class="p">,</span> <span class="n">lats</span><span class="o">=</span><span class="n">la</span><span class="p">)</span>
            <span class="n">valid_in_idx</span><span class="p">,</span> <span class="n">valid_out_idx</span><span class="p">,</span> <span class="n">index_array</span><span class="p">,</span> <span class="n">dist_array</span> <span class="o">=</span> <span class="n">kd_tree</span><span class="o">.</span><span class="n">get_neighbour_info</span><span class="p">(</span><span class="n">source_geo_def</span>      <span class="o">=</span> <span class="n">swath</span><span class="p">,</span>
                                                                                              <span class="n">target_geo_def</span>      <span class="o">=</span> <span class="n">area_def</span><span class="p">,</span>
                                                                                              <span class="n">radius_of_influence</span> <span class="o">=</span> <span class="n">roi_m</span><span class="p">,</span>
                                                                                              <span class="n">neighbours</span>          <span class="o">=</span> <span class="n">neighbours</span><span class="p">,</span>
                                                                                              <span class="n">epsilon</span>             <span class="o">=</span> <span class="n">epsilon</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">valid_out_idx</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">sit2d</span><span class="p">,</span> <span class="n">se2d</span><span class="p">,</span> <span class="n">u2d</span><span class="p">,</span> <span class="n">n2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_l2p_weights</span><span class="p">(</span><span class="n">index_array</span>        <span class="o">=</span> <span class="n">index_array</span><span class="p">,</span>
                                                      <span class="n">dist_array</span>         <span class="o">=</span> <span class="n">dist_array</span><span class="p">,</span>
                                                      <span class="n">valid_input_index</span>  <span class="o">=</span> <span class="n">valid_in_idx</span><span class="p">,</span>
                                                      <span class="n">valid_output_index</span> <span class="o">=</span> <span class="n">valid_out_idx</span><span class="p">,</span>
                                                      <span class="n">swath_SIT</span>          <span class="o">=</span> <span class="n">s</span><span class="p">,</span>
                                                      <span class="n">swath_unc</span>          <span class="o">=</span> <span class="n">u</span><span class="p">,</span>
                                                      <span class="n">out_shape</span>          <span class="o">=</span> <span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">),</span>
                                                      <span class="n">roi_m</span>              <span class="o">=</span> <span class="n">roi_m</span><span class="p">,</span>
                                                      <span class="n">sigma_m</span>            <span class="o">=</span> <span class="n">sigma_m</span><span class="p">)</span>
            <span class="n">SIT</span><span class="p">[</span><span class="n">it</span><span class="p">,:,:]</span>     <span class="o">=</span> <span class="n">sit2d</span>
            <span class="n">SIT_unc</span><span class="p">[</span><span class="n">it</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">se2d</span>
            <span class="n">U_cell</span><span class="p">[</span><span class="n">it</span><span class="p">,:,:]</span>  <span class="o">=</span> <span class="n">u2d</span>
            <span class="n">N_cell</span><span class="p">[</span><span class="n">it</span><span class="p">,:,:]</span>  <span class="o">=</span> <span class="n">n2d</span>
        <span class="c1"># hemispheric daily aggregates with cos(lat) weights</span>
        <span class="n">W</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">lats2d</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>          <span class="c1"># (y,x)</span>
        <span class="n">valid</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">SIT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">W</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">S</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span> <span class="n">SIT</span><span class="p">,</span>     <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">U</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span> <span class="n">SIT_unc</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">Uc</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span> <span class="n">U_cell</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">W3</span>      <span class="o">=</span> <span class="n">W</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">wsum</span>    <span class="o">=</span> <span class="p">(</span><span class="n">W3</span> <span class="o">*</span> <span class="n">valid</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>                   <span class="c1"># (time,)</span>
        <span class="n">sit_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">S</span>  <span class="o">*</span> <span class="n">W3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">ume_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">Uc</span> <span class="o">*</span> <span class="n">W3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">se_num</span>  <span class="o">=</span> <span class="p">((</span><span class="n">W3</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">U</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">SIT_hem</span>     <span class="o">=</span> <span class="n">sit_num</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wsum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wsum</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">SIT_hem_u</span>   <span class="o">=</span> <span class="n">ume_num</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wsum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wsum</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">SIT_hem_unc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">se_num</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wsum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wsum</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">SIT_hem_n</span>   <span class="o">=</span> <span class="n">N_cell</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int32&quot;</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">data_vars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">SIT</span>         <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">SIT</span><span class="p">),</span>
                                         <span class="n">SIT_unc</span>     <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">SIT_unc</span><span class="p">),</span>
                                         <span class="n">u_cell</span>      <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">U_cell</span><span class="p">),</span>
                                         <span class="n">n_cell</span>      <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">N_cell</span><span class="p">),</span>
                                         <span class="n">SIT_hem</span>     <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;time&quot;</span><span class="p">,),</span> <span class="n">SIT_hem</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)),</span>
                                         <span class="n">SIT_hem_unc</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;time&quot;</span><span class="p">,),</span> <span class="n">SIT_hem_unc</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)),</span>
                                         <span class="n">SIT_hem_u</span>   <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;time&quot;</span><span class="p">,),</span> <span class="n">SIT_hem_u</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)),</span>
                                         <span class="n">SIT_hem_n</span>   <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;time&quot;</span><span class="p">,),</span> <span class="n">SIT_hem_n</span><span class="p">),),</span>
                        <span class="n">coords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">tcoord</span><span class="p">),</span>
                                      <span class="n">y</span>    <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)),</span>
                                      <span class="n">x</span>    <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)),</span>
                                      <span class="n">lon</span>  <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">lons2d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">)),</span>
                                      <span class="n">lat</span>  <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">lats2d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">))),</span>
                        <span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">note</span> <span class="o">=</span> <span class="s2">&quot;L2P swath resampled to target grid via pyresample neighbour info; &quot;</span>
                                            <span class="s2">&quot;Gaussian weighting if gaussian_sigma_km set; SE propagated as sqrt(sum(w^2 u^2))/sum(w).&quot;</span><span class="p">))</span>
        <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;SIT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">standard_name</span><span class="o">=</span><span class="s2">&quot;sea_ice_thickness&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">))</span>
        <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;SIT_unc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">standard_name</span><span class="o">=</span><span class="s2">&quot;sea_ice_thickness standard_error&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ds</span></div>


    <span class="c1"># ------------------------- one-call convenience ------------------------- #</span>
<div class="viewcode-block" id="SeaIceObservations.make_daily_gridded_SIT">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.make_daily_gridded_SIT">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_daily_gridded_SIT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                               <span class="n">dt0_str</span>           <span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                               <span class="n">dtN_str</span>           <span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                               <span class="n">hemisphere</span>        <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">institutions</span>      <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;ESA&quot;</span><span class="p">,</span> <span class="s2">&quot;AWI&quot;</span><span class="p">),</span>
                               <span class="n">sensors</span>           <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">levels</span>            <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">versions</span>          <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">root_esa</span>          <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">root_awi</span>          <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">roi_km</span>            <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">75.0</span><span class="p">,</span>
                               <span class="n">neighbours</span>        <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
                               <span class="n">epsilon</span>           <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                               <span class="n">gaussian_sigma_km</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">lat_cut</span>           <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">time_at_noon</span>      <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                               <span class="n">prefer</span>            <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;last&quot;</span><span class="p">,</span>
                               <span class="n">area_def</span>          <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a daily gridded SIT dataset for a time window in one call.</span>

<span class="sd">        This:</span>
<span class="sd">        1) Uses `build_sea_ice_satellite_paths(...)` to find L2P files in [dt0, dtN].</span>
<span class="sd">        2) Indexes &amp; de-duplicates to one file per day (configurable).</span>
<span class="sd">        3) Calls `l2p_to_daily_grid_pyresample(...)` to produce (time,y,x) fields</span>
<span class="sd">           plus hemispheric daily series.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.Dataset</span>
<span class="sd">            See `l2p_to_daily_grid_pyresample` for structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># prefer configured roots if not supplied</span>
        <span class="k">if</span> <span class="n">root_esa</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">root_esa</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ROOT_ESA_DEF&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">root_awi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">root_awi</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ROOT_AWI_DEF&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_sea_ice_satellite_paths</span><span class="p">(</span><span class="n">dt0_str</span>      <span class="o">=</span> <span class="n">dt0_str</span><span class="p">,</span>
                                                   <span class="n">dtN_str</span>      <span class="o">=</span> <span class="n">dtN_str</span><span class="p">,</span>
                                                   <span class="n">hemisphere</span>   <span class="o">=</span> <span class="n">hemisphere</span><span class="p">,</span>
                                                   <span class="n">institutions</span> <span class="o">=</span> <span class="n">institutions</span><span class="p">,</span>
                                                   <span class="n">sensors</span>      <span class="o">=</span> <span class="n">sensors</span><span class="p">,</span>
                                                   <span class="n">levels</span>       <span class="o">=</span> <span class="n">levels</span><span class="p">,</span>
                                                   <span class="n">versions</span>     <span class="o">=</span> <span class="n">versions</span><span class="p">,</span>
                                                   <span class="n">root_esa</span>     <span class="o">=</span> <span class="n">root_esa</span><span class="p">,</span>
                                                   <span class="n">root_awi</span>     <span class="o">=</span> <span class="n">root_awi</span><span class="p">)</span>
        <span class="n">df</span>          <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_satellite_paths</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
        <span class="n">df_daily</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dedup_daily_one_file_per_day</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">prefer</span><span class="o">=</span><span class="n">prefer</span><span class="p">)</span>
        <span class="n">daily_paths</span> <span class="o">=</span> <span class="n">df_daily</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2p_to_daily_grid_pyresample</span><span class="p">(</span><span class="n">paths</span>             <span class="o">=</span> <span class="n">daily_paths</span><span class="p">,</span>
                                                 <span class="n">hem</span>               <span class="o">=</span> <span class="n">hemisphere</span><span class="p">,</span>
                                                 <span class="n">area_def</span>          <span class="o">=</span> <span class="n">area_def</span><span class="p">,</span>
                                                 <span class="n">roi_km</span>            <span class="o">=</span> <span class="n">roi_km</span><span class="p">,</span>
                                                 <span class="n">neighbours</span>        <span class="o">=</span> <span class="n">neighbours</span><span class="p">,</span>
                                                 <span class="n">epsilon</span>           <span class="o">=</span> <span class="n">epsilon</span><span class="p">,</span>
                                                 <span class="n">gaussian_sigma_km</span> <span class="o">=</span> <span class="n">gaussian_sigma_km</span><span class="p">,</span>
                                                 <span class="n">lat_cut</span>           <span class="o">=</span> <span class="n">lat_cut</span><span class="p">,</span>
                                                 <span class="n">time_at_noon</span>      <span class="o">=</span> <span class="n">time_at_noon</span><span class="p">)</span></div>


    <span class="c1"># ------------------------- LEVEL 3 (MONTLY GRIDDED) ------------------------- #</span>
<div class="viewcode-block" id="SeaIceObservations.dedup_monthly_one_file_per_month">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.dedup_monthly_one_file_per_month">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">dedup_monthly_one_file_per_month</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">prefer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;last&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        From an indexed DataFrame (see index_satellite_paths), select one file per month.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : DataFrame</span>
<span class="sd">            Output of `index_satellite_paths`.</span>
<span class="sd">        prefer : {&quot;first&quot;,&quot;last&quot;}, default &quot;last&quot;</span>
<span class="sd">            If multiple files map to the same (year, month), keep the first/last after sorting.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DataFrame</span>
<span class="sd">            Subset with kind == &quot;monthly&quot; (or daily files that encode YYYYMM) and unique (year, month).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dfm</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;monthly&quot;</span><span class="p">,</span><span class="s2">&quot;daily&quot;</span><span class="p">])]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dfm</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dfm</span>
        <span class="c1"># For daily entries we keep (year, month) for grouping</span>
        <span class="n">dfm</span><span class="p">[</span><span class="s2">&quot;yymm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dfm</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">],</span> <span class="n">dfm</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">]))</span>
        <span class="n">dfm</span> <span class="o">=</span> <span class="n">dfm</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;yymm&quot;</span><span class="p">])</span>
        <span class="n">dfm</span> <span class="o">=</span> <span class="n">dfm</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;year&quot;</span><span class="p">,</span><span class="s2">&quot;month&quot;</span><span class="p">,</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
        <span class="n">pick</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;first&quot;</span><span class="p">:</span><span class="s2">&quot;first&quot;</span><span class="p">,</span><span class="s2">&quot;last&quot;</span><span class="p">:</span><span class="s2">&quot;last&quot;</span><span class="p">}[</span><span class="n">prefer</span><span class="p">]</span>
        <span class="n">dfm</span> <span class="o">=</span> <span class="n">dfm</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;year&quot;</span><span class="p">,</span><span class="s2">&quot;month&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pick</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dfm</span></div>


<div class="viewcode-block" id="SeaIceObservations.l3c_paths_to_monthly_grid">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.l3c_paths_to_monthly_grid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">l3c_paths_to_monthly_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                  <span class="n">paths</span>              <span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span>
                                  <span class="n">hem</span>                <span class="p">:</span> <span class="nb">str</span>   <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="n">sic_thresh_percent</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mf">15.0</span><span class="p">,</span>
                                  <span class="n">mask_strategy</span>      <span class="p">:</span> <span class="nb">str</span>  <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>    <span class="c1"># {&quot;none&quot;,&quot;quality&quot;,&quot;status&quot;,&quot;both&quot;}</span>
                                  <span class="n">include_snow</span>       <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                  <span class="n">include_flags</span>      <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                  <span class="n">min_obs</span>            <span class="p">:</span> <span class="nb">int</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>               <span class="c1"># if an &quot;n_observations&quot; variable exists</span>
                                  <span class="n">time_midpoint</span>      <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assemble ESA L3C / AWI l3cp_release files (already on LAEA grids) into a</span>
<span class="sd">        single (time, y, x) dataset with hemispheric monthly means.</span>

<span class="sd">        This function mirrors the L2P driver logic, but **no resampling** is done:</span>
<span class="sd">        it reads gridded variables straight from the files and standardizes dims.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        paths : list[Path]</span>
<span class="sd">            Monthly L3 NetCDF paths (ESA L3C or AWI l3cp_release).</span>
<span class="sd">        hem : {&#39;sh&#39;,&#39;nh&#39;}, optional</span>
<span class="sd">            Hemisphere hint (controls sign in optional lat_cut if you add one later).</span>
<span class="sd">            Defaults to `self.hemisphere_dict[&#39;abbreviation&#39;]` if present.</span>
<span class="sd">        sic_thresh_percent : float or None, default 15.0</span>
<span class="sd">            If set, mask cells with sea_ice_concentration &lt; threshold (percent).</span>
<span class="sd">        mask_strategy : {&quot;none&quot;,&quot;quality&quot;,&quot;status&quot;,&quot;both&quot;}, default &quot;none&quot;</span>
<span class="sd">            - &quot;quality&quot; keeps cells with quality_flag == 0</span>
<span class="sd">            - &quot;status&quot;  keeps cells with status_flag  == 0</span>
<span class="sd">            - &quot;both&quot;    requires both conditions</span>
<span class="sd">        include_snow : bool, default True</span>
<span class="sd">            Include snow_depth and snow_depth_uncertainty when present.</span>
<span class="sd">        include_flags : bool, default True</span>
<span class="sd">            Include flag fields (quality_flag, status_flag, region_code) when present.</span>
<span class="sd">        min_obs : int, default 1</span>
<span class="sd">            If a count variable exists (e.g., &quot;n_observations&quot;), require count &gt;= min_obs.</span>
<span class="sd">        time_midpoint : bool, default True</span>
<span class="sd">            If time_bnds variable exists, use midpoint as the time coordinate.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.Dataset</span>
<span class="sd">            Dimensions: time, y, x</span>
<span class="sd">            Coordinates: lon(y,x), lat(y,x), time</span>
<span class="sd">            Data variables:</span>
<span class="sd">                SIT(time,y,x)       [m]</span>
<span class="sd">                SIT_unc(time,y,x)   [m] per-cell uncertainty (SE)</span>
<span class="sd">                SIC(time,y,x)       [%] if present</span>
<span class="sd">                snow_depth(time,y,x) [m] if requested/present</span>
<span class="sd">                snow_depth_unc(time,y,x) [m] if requested/present</span>
<span class="sd">                quality_flag/status_flag/region_code if requested/present</span>
<span class="sd">                SIT_hem(time)       [m] hemispheric mean</span>
<span class="sd">                SIT_hem_unc(time)   [m] propagated SE = sqrt(sum(w^2 * se^2))/sum(w)</span>
<span class="sd">                SIT_hem_u(time)     [m] hemispheric mean of per-cell uncertainty</span>
<span class="sd">                SIT_hem_n(time)     [#] count of valid contributing cells</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">paths</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No L3 paths provided&quot;</span><span class="p">)</span>
        <span class="n">hem</span> <span class="o">=</span> <span class="p">(</span><span class="n">hem</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">hemisphere_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;abbreviation&quot;</span><span class="p">,</span> <span class="s2">&quot;sh&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="c1"># Store per-file outputs here then concat along time at the end</span>
        <span class="n">out_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lat_template</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">lon_template</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">Path</span><span class="p">,</span> <span class="n">paths</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Flexible getters</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_first</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">names</span><span class="p">)</span>
            <span class="c1"># Dim normalization (yc/xc or y/x)</span>
            <span class="n">ydim</span> <span class="o">=</span> <span class="s2">&quot;yc&quot;</span> <span class="k">if</span> <span class="s2">&quot;yc&quot;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">dims</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span> <span class="k">if</span> <span class="s2">&quot;y&quot;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">dims</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">xdim</span> <span class="o">=</span> <span class="s2">&quot;xc&quot;</span> <span class="k">if</span> <span class="s2">&quot;xc&quot;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">dims</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span> <span class="k">if</span> <span class="s2">&quot;x&quot;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">dims</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ydim</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">xdim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">continue</span>
            <span class="n">ds_work</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="n">ydim</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">xdim</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">})</span>
            <span class="c1"># Coordinates</span>
            <span class="n">lat2d</span> <span class="o">=</span> <span class="n">G</span><span class="p">([</span><span class="s2">&quot;lat&quot;</span><span class="p">])</span>
            <span class="n">lon2d</span> <span class="o">=</span> <span class="n">G</span><span class="p">([</span><span class="s2">&quot;lon&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">lat2d</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lon2d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">continue</span>
            <span class="c1"># Persist a lat/lon template (assumed constant across files)</span>
            <span class="n">lat_template</span> <span class="o">=</span> <span class="n">lat2d</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="n">lat_template</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lat_template</span>
            <span class="n">lon_template</span> <span class="o">=</span> <span class="n">lon2d</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="n">lon_template</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lon_template</span>
            <span class="c1"># Variables of interest</span>
            <span class="n">SIT</span>   <span class="o">=</span> <span class="n">G</span><span class="p">([</span><span class="s2">&quot;sea_ice_thickness&quot;</span><span class="p">,</span> <span class="s2">&quot;SIT&quot;</span><span class="p">,</span> <span class="s2">&quot;sit&quot;</span><span class="p">])</span>
            <span class="n">SIT_U</span> <span class="o">=</span> <span class="n">G</span><span class="p">([</span><span class="s2">&quot;sea_ice_thickness_uncertainty&quot;</span><span class="p">,</span> <span class="s2">&quot;SIT_unc&quot;</span><span class="p">,</span> <span class="s2">&quot;sit_unc&quot;</span><span class="p">,</span> <span class="s2">&quot;uncertainty&quot;</span><span class="p">])</span>
            <span class="n">SIC</span>   <span class="o">=</span> <span class="n">G</span><span class="p">([</span><span class="s2">&quot;sea_ice_concentration&quot;</span><span class="p">,</span> <span class="s2">&quot;sic&quot;</span><span class="p">])</span>
            <span class="n">SD</span>    <span class="o">=</span> <span class="n">G</span><span class="p">([</span><span class="s2">&quot;snow_depth&quot;</span><span class="p">,</span> <span class="s2">&quot;snow_thickness&quot;</span><span class="p">])</span>
            <span class="n">SDU</span>   <span class="o">=</span> <span class="n">G</span><span class="p">([</span><span class="s2">&quot;snow_depth_uncertainty&quot;</span><span class="p">,</span> <span class="s2">&quot;snow_thickness_uncertainty&quot;</span><span class="p">])</span>
            <span class="n">QF</span>    <span class="o">=</span> <span class="n">G</span><span class="p">([</span><span class="s2">&quot;quality_flag&quot;</span><span class="p">])</span>
            <span class="n">SF</span>    <span class="o">=</span> <span class="n">G</span><span class="p">([</span><span class="s2">&quot;status_flag&quot;</span><span class="p">])</span>
            <span class="n">RC</span>    <span class="o">=</span> <span class="n">G</span><span class="p">([</span><span class="s2">&quot;region_code&quot;</span><span class="p">])</span>
            <span class="n">NOBS</span>  <span class="o">=</span> <span class="n">G</span><span class="p">([</span><span class="s2">&quot;n_observations&quot;</span><span class="p">,</span> <span class="s2">&quot;num_observations&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">])</span>
            <span class="c1"># Required: SIT &amp; SIT_U at least</span>
            <span class="k">if</span> <span class="n">SIT</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">SIT_U</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds</span><span class="o">.</span><span class="n">close</span><span class="p">();</span> <span class="k">continue</span>
            <span class="c1"># Time coordinate (often size 1 per file, but robust to &gt;1)</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">G</span><span class="p">([</span><span class="s2">&quot;time&quot;</span><span class="p">])</span>
            <span class="n">tbnd</span> <span class="o">=</span> <span class="n">G</span><span class="p">([</span><span class="s2">&quot;time_bnds&quot;</span><span class="p">,</span> <span class="s2">&quot;time_bounds&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds</span><span class="o">.</span><span class="n">close</span><span class="p">();</span> <span class="k">continue</span>
            <span class="n">tvals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tvals</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tvals</span> <span class="o">=</span> <span class="n">tvals</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">time_midpoint</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tbnd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tb</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">tbnd</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># (time, nv)</span>
                    <span class="n">tmid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">tvals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">tmid</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;unix&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># fall back to time center</span>
                    <span class="k">pass</span>
            <span class="c1"># Build a mask</span>
            <span class="n">base_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">SIT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">SIT_U</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">lat2d</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">lon2d</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">SIC</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sic_thresh_percent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">base_mask</span> <span class="o">&amp;=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">SIC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SIC</span> <span class="o">&gt;=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sic_thresh_percent</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">NOBS</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">min_obs</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="n">min_obs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">base_mask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">NOBS</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">min_obs</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">mask_strategy</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;quality&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">QF</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">base_mask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">QF</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mask_strategy</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">SF</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">base_mask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">SF</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">mask_strategy</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask_strategy</span> <span class="ow">or</span> <span class="s2">&quot;none&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="c1"># Ensure 3D shape: (time, y, x)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">_as3</span><span class="p">(</span><span class="n">da</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="s2">&quot;yc&quot;</span><span class="p">,</span> <span class="s2">&quot;xc&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
                <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">v</span>
            <span class="n">sit3</span>  <span class="o">=</span> <span class="n">_as3</span><span class="p">(</span><span class="n">SIT</span><span class="p">)</span>
            <span class="n">sunc3</span> <span class="o">=</span> <span class="n">_as3</span><span class="p">(</span><span class="n">SIT_U</span><span class="p">)</span>
            <span class="n">mask3</span> <span class="o">=</span> <span class="n">base_mask</span>
            <span class="k">if</span> <span class="n">mask3</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">mask3</span> <span class="o">=</span> <span class="n">mask3</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">SIC</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sic3</span> <span class="o">=</span> <span class="n">_as3</span><span class="p">(</span><span class="n">SIC</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">SD</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">include_snow</span><span class="p">:</span>
                <span class="n">sd3</span> <span class="o">=</span> <span class="n">_as3</span><span class="p">(</span><span class="n">SD</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">SDU</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">include_snow</span><span class="p">:</span>
                <span class="n">sdu3</span> <span class="o">=</span> <span class="n">_as3</span><span class="p">(</span><span class="n">SDU</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">QF</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">include_flags</span><span class="p">:</span>
                <span class="n">qf3</span> <span class="o">=</span> <span class="n">_as3</span><span class="p">(</span><span class="n">QF</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">SF</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">include_flags</span><span class="p">:</span>
                <span class="n">sf3</span> <span class="o">=</span> <span class="n">_as3</span><span class="p">(</span><span class="n">SF</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">RC</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">include_flags</span><span class="p">:</span>
                <span class="n">rc3</span> <span class="o">=</span> <span class="n">_as3</span><span class="p">(</span><span class="n">RC</span><span class="p">)</span>
            <span class="c1"># Apply mask: keep NaNs outside valid cells</span>
            <span class="n">S</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask3</span><span class="p">,</span> <span class="n">sit3</span><span class="p">,</span>  <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">U</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask3</span><span class="p">,</span> <span class="n">sunc3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">SIC</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">SICv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask3</span><span class="p">,</span> <span class="n">sic3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">SD</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">include_snow</span><span class="p">:</span>
                <span class="n">SDv</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask3</span><span class="p">,</span> <span class="n">sd3</span><span class="p">,</span>  <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">SDU</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">include_snow</span><span class="p">:</span>
                <span class="n">SDUv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask3</span><span class="p">,</span> <span class="n">sdu3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Hemispheric weighting</span>
            <span class="n">W2</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">lat2d</span><span class="o">.</span><span class="n">values</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
            <span class="n">W3</span>      <span class="o">=</span> <span class="n">W2</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">valid</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
            <span class="n">wsum</span>    <span class="o">=</span> <span class="p">(</span><span class="n">W3</span> <span class="o">*</span> <span class="n">valid</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">sit_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>  <span class="o">*</span> <span class="n">W3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">u_num</span>   <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>  <span class="o">*</span> <span class="n">W3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">se_num</span>  <span class="o">=</span> <span class="p">((</span><span class="n">W3</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">SIT_hem</span>     <span class="o">=</span> <span class="n">sit_num</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wsum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wsum</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">SIT_hem_u</span>   <span class="o">=</span> <span class="n">u_num</span>   <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wsum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wsum</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">SIT_hem_unc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">se_num</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wsum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wsum</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">SIT_hem_n</span>   <span class="o">=</span> <span class="n">valid</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int32&quot;</span><span class="p">)</span>
            <span class="c1"># ---- NEW: concentration-weighted hemispheric mean (SIC weights) ----</span>
            <span class="n">SIT_wgt</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">S</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
            <span class="n">SIT_wgt_u</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">S</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
            <span class="n">SIT_wgt_unc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">S</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
            <span class="n">SIT_wgt_n</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">S</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int32&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">SIC</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Convert SIC to fraction [0..1] for correct uncertainty propagation.</span>
                <span class="n">sic_units</span> <span class="o">=</span> <span class="p">(</span><span class="n">SIC</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;units&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">sic3_raw</span> <span class="o">=</span> <span class="n">_as3</span><span class="p">(</span><span class="n">SIC</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;percent&quot;</span> <span class="ow">in</span> <span class="n">sic_units</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;%&quot;</span> <span class="ow">in</span> <span class="n">sic_units</span><span class="p">):</span>
                    <span class="n">Wsic</span> <span class="o">=</span> <span class="n">sic3_raw</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">100.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># heuristic fallback</span>
                    <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">sic3_raw</span><span class="p">)</span>
                    <span class="n">Wsic</span> <span class="o">=</span> <span class="p">(</span><span class="n">sic3_raw</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">vmax</span><span class="p">)</span> <span class="ow">and</span> <span class="n">vmax</span> <span class="o">&gt;</span> <span class="mf">1.5</span> <span class="k">else</span> <span class="n">sic3_raw</span>
                    <span class="n">Wsic</span> <span class="o">=</span> <span class="n">Wsic</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                <span class="c1"># Honor the same base mask used for S/U (keeps SIC &gt;= thresh, flags, etc.)</span>
                <span class="c1"># mask3 is (time,y,x); if it&#39;s 2D, lift it to 3D</span>
                <span class="n">m3</span> <span class="o">=</span> <span class="n">mask3</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m3</span><span class="p">,</span> <span class="s2">&quot;ndim&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">m3</span> <span class="o">=</span> <span class="n">m3</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
                <span class="n">Wsic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">m3</span><span class="p">,</span> <span class="n">Wsic</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="c1"># Weighted mean thickness DOES NOT require uncertainty to be finite</span>
                <span class="n">v_sit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">S</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">Wsic</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Wsic</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">wsum</span>  <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">v_sit</span><span class="p">,</span> <span class="n">Wsic</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">num</span>   <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">v_sit</span><span class="p">,</span> <span class="n">S</span> <span class="o">*</span> <span class="n">Wsic</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">SIT_wgt</span>   <span class="o">=</span> <span class="n">num</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wsum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wsum</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">SIT_wgt_n</span> <span class="o">=</span> <span class="n">v_sit</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int32&quot;</span><span class="p">)</span>
                <span class="c1"># For the uncertainty aggregates, only use pixels where uncertainty is finite</span>
                <span class="n">v_u</span>      <span class="o">=</span> <span class="n">v_sit</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
                <span class="n">wsum_u</span>   <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">v_u</span><span class="p">,</span> <span class="n">Wsic</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">num_u</span>    <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">v_u</span><span class="p">,</span> <span class="n">U</span> <span class="o">*</span> <span class="n">Wsic</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">se_num_u</span> <span class="o">=</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">v_u</span><span class="p">,</span> <span class="n">Wsic</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">v_u</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">SIT_wgt_u</span>   <span class="o">=</span> <span class="n">num_u</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wsum_u</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wsum_u</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">SIT_wgt_unc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">se_num_u</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wsum_u</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wsum_u</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="c1"># Assemble per-file dataset (time may be &gt;1)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ds_out</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">data_vars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">SIT</span>         <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">S</span><span class="p">),</span>
                                                 <span class="n">SIT_unc</span>     <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">U</span><span class="p">),</span>
                                                 <span class="n">SIT_hem</span>     <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;time&quot;</span><span class="p">,),</span> <span class="n">SIT_hem</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)),</span>
                                                 <span class="n">SIT_hem_unc</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;time&quot;</span><span class="p">,),</span> <span class="n">SIT_hem_unc</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)),</span>
                                                 <span class="n">SIT_hem_u</span>   <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;time&quot;</span><span class="p">,),</span> <span class="n">SIT_hem_u</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)),</span>
                                                 <span class="n">SIT_hem_n</span>   <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;time&quot;</span><span class="p">,),</span> <span class="n">SIT_hem_n</span><span class="p">),</span>
                                                 <span class="n">SIT_wgt</span>     <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;time&quot;</span><span class="p">,),</span> <span class="n">SIT_wgt</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)),</span>
                                                 <span class="n">SIT_wgt_unc</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;time&quot;</span><span class="p">,),</span> <span class="n">SIT_wgt_unc</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)),</span>
                                                 <span class="n">SIT_wgt_u</span>   <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;time&quot;</span><span class="p">,),</span> <span class="n">SIT_wgt_u</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)),</span>
                                                 <span class="n">SIT_wgt_n</span>   <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;time&quot;</span><span class="p">,),</span> <span class="n">SIT_wgt_n</span><span class="p">)),</span>
                                <span class="n">coords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">tvals</span><span class="p">)</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()),</span>
                                              <span class="n">y</span>    <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lat2d</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s2">&quot;yc&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)),</span>
                                              <span class="n">x</span>    <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lat2d</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s2">&quot;xc&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)),</span>
                                              <span class="n">lon</span>  <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">lon2d</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">)),</span>
                                              <span class="n">lat</span>  <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">lat2d</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">))))</span>
            <span class="k">if</span> <span class="n">SIC</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds_out</span><span class="p">[</span><span class="s2">&quot;SIC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">SICv</span><span class="p">)</span>
                <span class="n">ds_out</span><span class="p">[</span><span class="s2">&quot;SIC&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">standard_name</span><span class="o">=</span><span class="s2">&quot;sea_ice_area_fraction&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;percent&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">include_snow</span> <span class="ow">and</span> <span class="n">SD</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds_out</span><span class="p">[</span><span class="s2">&quot;snow_depth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">SDv</span><span class="p">)</span>
                <span class="n">ds_out</span><span class="p">[</span><span class="s2">&quot;snow_depth&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">standard_name</span><span class="o">=</span><span class="s2">&quot;surface_snow_thickness_where_sea_ice&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">include_snow</span> <span class="ow">and</span> <span class="n">SDU</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds_out</span><span class="p">[</span><span class="s2">&quot;snow_depth_unc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">SDUv</span><span class="p">)</span>
                <span class="n">ds_out</span><span class="p">[</span><span class="s2">&quot;snow_depth_unc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">standard_name</span><span class="o">=</span><span class="s2">&quot;surface_snow_thickness_where_sea_ice standard_error&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">include_flags</span> <span class="ow">and</span> <span class="n">QF</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds_out</span><span class="p">[</span><span class="s2">&quot;quality_flag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">qf3</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int8&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">include_flags</span> <span class="ow">and</span> <span class="n">SF</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds_out</span><span class="p">[</span><span class="s2">&quot;status_flag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">sf3</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int8&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">include_flags</span> <span class="ow">and</span> <span class="n">RC</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds_out</span><span class="p">[</span><span class="s2">&quot;region_code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">rc3</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int8&quot;</span><span class="p">))</span>
            <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds_out</span><span class="p">)</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">out_list</span><span class="p">:</span>
            <span class="c1"># Empty shell with lat/lon if we managed to see one file’s coords</span>
            <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">coords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;datetime64[ns]&quot;</span><span class="p">)),</span>
                                            <span class="n">y</span>    <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lat_template</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="k">if</span> <span class="n">lat_template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)),</span>
                                            <span class="n">x</span>    <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lat_template</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="k">if</span> <span class="n">lat_template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)),</span>
                                            <span class="n">lon</span>  <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">lon_template</span> <span class="k">if</span> <span class="n">lon_template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))),</span>
                                            <span class="n">lat</span>  <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">lat_template</span> <span class="k">if</span> <span class="n">lat_template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))),))</span>
        <span class="n">ds_all</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">out_list</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
        <span class="n">ds_all</span><span class="p">[</span><span class="s2">&quot;SIT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">standard_name</span><span class="o">=</span><span class="s2">&quot;sea_ice_thickness&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">))</span>
        <span class="n">ds_all</span><span class="p">[</span><span class="s2">&quot;SIT_unc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">standard_name</span><span class="o">=</span><span class="s2">&quot;sea_ice_thickness standard_error&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">))</span>
        <span class="n">ds_all</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">note</span><span class="o">=</span><span class="s2">&quot;Assembled L3 (ESA L3C / AWI l3cp_release) monthly grids with optional QC &amp; SIC threshold; hemispheric means use cos(lat) weights.&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ds_all</span></div>


<div class="viewcode-block" id="SeaIceObservations.make_monthly_gridded_SIT_L3">
<a class="viewcode-back" href="../api.html#sea_ice_observations.SeaIceObservations.make_monthly_gridded_SIT_L3">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_monthly_gridded_SIT_L3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                    <span class="n">dt0_str</span>            <span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                    <span class="n">dtN_str</span>            <span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                    <span class="n">hemisphere</span>         <span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                    <span class="n">institutions</span>       <span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;ESA&quot;</span><span class="p">,</span><span class="s2">&quot;AWI&quot;</span><span class="p">),</span>
                                    <span class="n">sensors</span>            <span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                    <span class="n">levels</span>             <span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;L3C&quot;</span><span class="p">,</span><span class="s2">&quot;l3cp_release&quot;</span><span class="p">),</span>
                                    <span class="n">versions</span>           <span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                    <span class="n">root_esa</span>           <span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                    <span class="n">root_awi</span>           <span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                    <span class="n">prefer</span>             <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;last&quot;</span><span class="p">,</span>
                                    <span class="n">sic_thresh_percent</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mf">15.0</span><span class="p">,</span>
                                    <span class="n">mask_strategy</span>      <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>         <span class="c1"># {&quot;none&quot;,&quot;quality&quot;,&quot;status&quot;,&quot;both&quot;}</span>
                                    <span class="n">include_snow</span>       <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                    <span class="n">include_flags</span>      <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                    <span class="n">min_obs</span>            <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                                    <span class="n">time_midpoint</span>      <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a monthly gridded SIT dataset from L3 products (ESA L3C / AWI l3cp_release)</span>
<span class="sd">        in one call. Mirrors the L2P one-call driver but skips resampling.</span>

<span class="sd">        Steps:</span>
<span class="sd">        1) Find files with `build_sea_ice_satellite_paths(...)`</span>
<span class="sd">        2) Index and de-duplicate to one file per month</span>
<span class="sd">        3) Assemble into (time,y,x) arrays with `l3c_paths_to_monthly_grid(...)`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># default roots from module globals if not specified</span>
        <span class="k">if</span> <span class="n">root_esa</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">root_esa</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ROOT_ESA_DEF&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">root_awi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">root_awi</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ROOT_AWI_DEF&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_sea_ice_satellite_paths</span><span class="p">(</span><span class="n">dt0_str</span>      <span class="o">=</span> <span class="n">dt0_str</span><span class="p">,</span>
                                                   <span class="n">dtN_str</span>      <span class="o">=</span> <span class="n">dtN_str</span><span class="p">,</span>
                                                   <span class="n">hemisphere</span>   <span class="o">=</span> <span class="n">hemisphere</span><span class="p">,</span>
                                                   <span class="n">institutions</span> <span class="o">=</span> <span class="n">institutions</span><span class="p">,</span>
                                                   <span class="n">sensors</span>      <span class="o">=</span> <span class="n">sensors</span><span class="p">,</span>
                                                   <span class="n">levels</span>       <span class="o">=</span> <span class="n">levels</span><span class="p">,</span>
                                                   <span class="n">versions</span>     <span class="o">=</span> <span class="n">versions</span><span class="p">,</span>
                                                   <span class="n">root_esa</span>     <span class="o">=</span> <span class="n">root_esa</span><span class="p">,</span>
                                                   <span class="n">root_awi</span>     <span class="o">=</span> <span class="n">root_awi</span><span class="p">)</span>
        <span class="c1"># QA &amp; dedup to one per month</span>
        <span class="n">df</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_satellite_paths</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
        <span class="n">df_mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dedup_monthly_one_file_per_month</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">prefer</span><span class="o">=</span><span class="n">prefer</span><span class="p">)</span>
        <span class="n">P_mos</span> <span class="o">=</span> <span class="n">df_mo</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">l3c_paths_to_monthly_grid</span><span class="p">(</span><span class="n">paths</span>              <span class="o">=</span> <span class="n">P_mos</span><span class="p">,</span>
                                              <span class="n">hem</span>                <span class="o">=</span> <span class="n">hemisphere</span><span class="p">,</span>
                                              <span class="n">sic_thresh_percent</span> <span class="o">=</span> <span class="n">sic_thresh_percent</span><span class="p">,</span>
                                              <span class="n">mask_strategy</span>      <span class="o">=</span> <span class="n">mask_strategy</span><span class="p">,</span>
                                              <span class="n">include_snow</span>       <span class="o">=</span> <span class="n">include_snow</span><span class="p">,</span>
                                              <span class="n">include_flags</span>      <span class="o">=</span> <span class="n">include_flags</span><span class="p">,</span>
                                              <span class="n">min_obs</span>            <span class="o">=</span> <span class="n">min_obs</span><span class="p">,</span>
                                              <span class="n">time_midpoint</span>      <span class="o">=</span> <span class="n">time_midpoint</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Daniel Atwater.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>