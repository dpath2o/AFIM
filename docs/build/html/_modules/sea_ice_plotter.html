

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>sea_ice_plotter &mdash; AFIM 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=9edc463e" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=01f34227"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            AFIM
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../AFIM_sensitivity_methodology.html">Methodology: Antarctic (Land)Fast (Sea) Ice Modelling and Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lateral_drag_form_factor_creation.html">Coastal-drag form factors from high-resolution coastline and grounded icebergs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">AFIM</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">sea_ice_plotter</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for sea_ice_plotter</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">time</span><span class="o">,</span><span class="w"> </span><span class="nn">imageio</span><span class="o">,</span><span class="w"> </span><span class="nn">pygmt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w">            </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w">            </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w">         </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w">             </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.dates</span><span class="w">  </span><span class="k">as</span><span class="w"> </span><span class="nn">mdates</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w">                </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w">                 </span><span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w">             </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w">            </span><span class="kn">import</span> <span class="n">datetime</span>

<div class="viewcode-block" id="SeaIcePlotter">
<a class="viewcode-back" href="../sea_ice_plotter.html#sea_ice_plotter.SeaIcePlotter">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SeaIcePlotter</span><span class="p">:</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span>

<div class="viewcode-block" id="SeaIcePlotter.load_ice_shelves">
<a class="viewcode-back" href="../sea_ice_plotter.html#sea_ice_plotter.SeaIcePlotter.load_ice_shelves">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_ice_shelves</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load and preprocess Antarctic ice shelf polygons for PyGMT plotting.</span>

<span class="sd">        This method reads a shapefile containing Antarctic coastal geometries,</span>
<span class="sd">        filters for polygons classified as ice shelves (`POLY_TYPE == &#39;S&#39;`),</span>
<span class="sd">        ensures valid geometry, reprojects them to WGS84 (EPSG:4326),</span>
<span class="sd">        and applies a zero-width buffer to clean topology issues.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        geopandas.GeoSeries</span>
<span class="sd">            Cleaned and reprojected geometries of Antarctic ice shelves.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - The input shapefile path is read from `self.config[&#39;pygmt_dict&#39;][&#39;P_coast_shape&#39;]`.</span>
<span class="sd">        - This method is typically used to overlay ice shelf boundaries in PyGMT plots.</span>
<span class="sd">        - The returned geometries can be passed directly to `pygmt.Figure.plot()`.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        - self.plot_FIA_FIP_faceted : Uses this method to overlay ice shelves in map panels.</span>
<span class="sd">        - geopandas.read_file : For reading shapefiles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gdf</span>                     <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pygmt_dict&#39;</span><span class="p">][</span><span class="s1">&#39;P_coast_shape&#39;</span><span class="p">])</span>
        <span class="n">shelves</span>                 <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;POLY_TYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">]</span>
        <span class="n">shelves</span>                 <span class="o">=</span> <span class="n">shelves</span><span class="p">[</span><span class="o">~</span><span class="n">shelves</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">is_empty</span> <span class="o">&amp;</span> <span class="n">shelves</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">notnull</span><span class="p">()]</span>
        <span class="n">shelves</span>                 <span class="o">=</span> <span class="n">shelves</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">)</span>
        <span class="n">shelves</span><span class="o">.</span><span class="n">geometry</span>        <span class="o">=</span> <span class="n">shelves</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">shelves</span><span class="o">.</span><span class="n">geometry</span></div>


<div class="viewcode-block" id="SeaIcePlotter.create_IBCSO_bath">
<a class="viewcode-back" href="../sea_ice_plotter.html#sea_ice_plotter.SeaIcePlotter.create_IBCSO_bath">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_IBCSO_bath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract and save a masked IBCSO bathymetry layer for Antarctic plotting.</span>

<span class="sd">        This method loads the IBCSO v2.0 dataset (as a NetCDF raster), extracts</span>
<span class="sd">        the seafloor depth (negative elevations), masks out land areas (positive or zero),</span>
<span class="sd">        and saves a cleaned version to NetCDF for use in plotting.</span>

<span class="sd">        The result is saved at the path specified in</span>
<span class="sd">        `self.config[&#39;pygmt_dict&#39;][&#39;P_IBCSO_bath&#39;]`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Input file is assumed to be a NetCDF raster with variable `band_data`.</span>
<span class="sd">        - Only `band=0` is used (i.e., the main bathymetric band).</span>
<span class="sd">        - Output variable is named `bath` and excludes attributes and encodings for simplicity.</span>
<span class="sd">        - This method is typically called once to prepare the bathymetry layer before reuse.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        - self.load_IBCSO_bath : Loads the pre-saved masked bathymetry layer.</span>
<span class="sd">        - https://www.ibcso.org/ : International Bathymetric Chart of the Southern Ocean.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ds</span>               <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pygmt_dict&#39;</span><span class="p">][</span><span class="s1">&#39;P_IBCSO_bed&#39;</span><span class="p">])</span>
        <span class="n">bed</span>              <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">band_data</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">bed_masked</span>       <span class="o">=</span> <span class="n">bed</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">bed_masked</span><span class="o">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s2">&quot;bath&quot;</span> 
        <span class="n">bed_masked</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>    
        <span class="n">ds_out</span>           <span class="o">=</span> <span class="n">bed_masked</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">()</span>
        <span class="n">ds_out</span><span class="o">.</span><span class="n">attrs</span>     <span class="o">=</span> <span class="p">{}</span>        
        <span class="n">ds_out</span><span class="o">.</span><span class="n">encoding</span>  <span class="o">=</span> <span class="p">{}</span>     
        <span class="n">ds_out</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pygmt_dict&#39;</span><span class="p">][</span><span class="s2">&quot;P_IBCSO_bath&quot;</span><span class="p">])</span></div>


<div class="viewcode-block" id="SeaIcePlotter.load_IBCSO_bath">
<a class="viewcode-back" href="../sea_ice_plotter.html#sea_ice_plotter.SeaIcePlotter.load_IBCSO_bath">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_IBCSO_bath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load masked IBCSO bathymetry dataset prepared by `create_IBCSO_bath()`.</span>

<span class="sd">        Returns the `bath` variable from the NetCDF file specified in</span>
<span class="sd">        `self.config[&#39;pygmt_dict&#39;][&quot;P_IBCSO_bath&quot;]`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            2D array of bathymetry values (only ocean depths, in meters).</span>
<span class="sd">            Values are negative below sea level, NaN over land.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - This method assumes that `create_IBCSO_bath()` has already been run.</span>
<span class="sd">        - Designed for use in PyGMT background plotting or masking.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        - self.create_IBCSO_bath : Creates this file if it doesn&#39;t exist.</span>
<span class="sd">        - xarray.open_dataset : Loads the bathymetry layer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pygmt_dict&#39;</span><span class="p">][</span><span class="s2">&quot;P_IBCSO_bath&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">bath</span></div>

    
<div class="viewcode-block" id="SeaIcePlotter.create_cbar_frame">
<a class="viewcode-back" href="../sea_ice_plotter.html#sea_ice_plotter.SeaIcePlotter.create_cbar_frame">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_cbar_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extend_cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_ann_steps</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a GMT-style colorbar annotation frame string for PyGMT plotting.</span>

<span class="sd">        This utility generates a clean, readable colorbar frame string using adaptive</span>
<span class="sd">        step sizing based on the data range. An optional second axis label (e.g., for units)</span>
<span class="sd">        and extension arrows can be included.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        series : list or tuple of float</span>
<span class="sd">            Data range for the colorbar as [vmin, vmax].</span>
<span class="sd">        label : str</span>
<span class="sd">            Label text for the colorbar (e.g., &quot;Fast Ice Persistence&quot;).</span>
<span class="sd">        units : str, optional</span>
<span class="sd">            Units label to be shown along the secondary (y) axis (e.g., &quot;1/100&quot;).</span>
<span class="sd">        extend_cbar : bool, optional</span>
<span class="sd">            Whether to append extension arrows to the colorbar (+e). Default is False.</span>
<span class="sd">        max_ann_steps : int, default=10</span>
<span class="sd">            Desired maximum number of major annotations (controls tick spacing).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str or list of str</span>
<span class="sd">            GMT-format colorbar annotation string (e.g., &quot;a0.1f0.02+lLabel&quot;), or</span>
<span class="sd">            a list of two strings if `units` is provided.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Tick spacing is determined using a scaled logarithmic rounding to ensure clean steps (e.g., 0.1, 0.2, 0.5).</span>
<span class="sd">        - If `extend_cbar` is True, `+e` is added to indicate out-of-bounds extension arrows.</span>
<span class="sd">        - Compatible with `pygmt.Figure.colorbar(frame=...)`.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; self.create_cbar_frame([0.01, 1.0], &quot;Persistence&quot;, units=&quot;1/100&quot;)</span>
<span class="sd">        [&#39;a0.1f0.02+lPersistence&#39;, &#39;y+l 1/100&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">series</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vrange</span> <span class="o">=</span> <span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span>
        <span class="n">raw_step</span> <span class="o">=</span> <span class="n">vrange</span> <span class="o">/</span> <span class="n">max_ann_steps</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">raw_step</span><span class="p">))</span>
        <span class="n">base</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">exp</span>
        <span class="n">mult</span> <span class="o">=</span> <span class="n">raw_step</span> <span class="o">/</span> <span class="n">base</span>
        <span class="k">if</span> <span class="n">mult</span> <span class="o">&lt;</span> <span class="mf">1.5</span><span class="p">:</span>
            <span class="n">ann_step</span> <span class="o">=</span> <span class="n">base</span> <span class="o">*</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">mult</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">ann_step</span> <span class="o">=</span> <span class="n">base</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">mult</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">ann_step</span> <span class="o">=</span> <span class="n">base</span> <span class="o">*</span> <span class="mi">5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ann_step</span> <span class="o">=</span> <span class="n">base</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="n">tick_step</span> <span class="o">=</span> <span class="n">ann_step</span> <span class="o">/</span> <span class="mi">5</span>
        <span class="n">ann_str</span>  <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ann_step</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">tick_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick_step</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="c1"># Build annotation string</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;a</span><span class="si">{</span><span class="n">ann_str</span><span class="si">}</span><span class="s2">f</span><span class="si">{</span><span class="n">tick_str</span><span class="si">}</span><span class="s2">+l</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">extend_cbar</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">+=</span> <span class="s2">&quot;+e&quot;</span>  <span class="c1"># or use &quot;+eU&quot; / &quot;+eL&quot; for one-sided arrows</span>
        <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="k">return</span> <span class="p">[</span><span class="n">frame</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;y+l </span><span class="si">{</span><span class="n">units</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">frame</span></div>


<div class="viewcode-block" id="SeaIcePlotter.get_meridian_center_from_geographic_extent">
<a class="viewcode-back" href="../sea_ice_plotter.html#sea_ice_plotter.SeaIcePlotter.get_meridian_center_from_geographic_extent">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_meridian_center_from_geographic_extent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geographic_extent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the optimal central meridian for PyGMT polar stereographic projections.</span>

<span class="sd">        Given a geographic extent in longitude/latitude format, this method calculates</span>
<span class="sd">        the central meridian (longitude) to use in &#39;S&lt;lon&gt;/&lt;lat&gt;/&lt;width&gt;&#39; PyGMT projection</span>
<span class="sd">        strings. It accounts for dateline wrapping and ensures the plot is centered visually.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        geographic_extent : list of float</span>
<span class="sd">            Geographic region as [min_lon, max_lon, min_lat, max_lat]. Accepts longitudes in</span>
<span class="sd">            either [-180, 180] or [0, 360] and gracefully handles dateline crossing.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Central meridian (longitude) in the range [-180, 180].</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - If the computed center falls outside the intended range (e.g., due to dateline wrapping), </span>
<span class="sd">            the method rotates the meridian 180째 to better align the figure.</span>
<span class="sd">        - The result is saved to `self.plot_meridian_center` for reuse.</span>
<span class="sd">        - Used in PyGMT stereographic projections like `&#39;S{lon}/-90/30c&#39;`.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        - https://docs.generic-mapping-tools.org/latest/cookbook/proj.html</span>
<span class="sd">        - pygmt.Figure.basemap : For setting map projections using meridian centers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span> <span class="o">=</span> <span class="n">geographic_extent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">geographic_extent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lon_min_360</span> <span class="o">=</span> <span class="n">lon_min</span> <span class="o">%</span> <span class="mi">360</span>
        <span class="n">lon_max_360</span> <span class="o">=</span> <span class="n">lon_max</span> <span class="o">%</span> <span class="mi">360</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lon_max_360</span> <span class="o">-</span> <span class="n">lon_min_360</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">:</span>
            <span class="n">center</span> <span class="o">=</span> <span class="p">((</span><span class="n">lon_min_360</span> <span class="o">+</span> <span class="n">lon_max_360</span> <span class="o">+</span> <span class="mi">360</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon_min_360</span> <span class="o">+</span> <span class="n">lon_max_360</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">center</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">:</span>
            <span class="n">center</span> <span class="o">-=</span> <span class="mi">360</span>
        <span class="c1"># Edge case fix: ensure center is visually aligned with geographic_extent</span>
        <span class="c1"># If the computed center is 180째 out of phase (i.e., upside-down plots)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">geographic_extent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">center</span> <span class="o">&lt;=</span> <span class="n">geographic_extent</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="c1"># Flip 180째</span>
            <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">center</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span>
            <span class="k">if</span> <span class="n">center</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">:</span>
                <span class="n">center</span> <span class="o">-=</span> <span class="mi">360</span>
        <span class="c1">#print(f&quot;meridian center computed as {center:.2f}째&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_meridian_center</span> <span class="o">=</span> <span class="n">center</span>
        <span class="k">return</span> <span class="n">center</span></div>


<div class="viewcode-block" id="SeaIcePlotter.generate_regional_annotation_stats">
<a class="viewcode-back" href="../sea_ice_plotter.html#sea_ice_plotter.SeaIcePlotter.generate_regional_annotation_stats">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_regional_annotation_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">lon_coord_name</span><span class="p">,</span> <span class="n">lat_coord_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate summary statistics (mean, std, min, max) and their locations within a geographic region.</span>

<span class="sd">        This helper function extracts the portion of a 2D `xarray.DataArray` that falls within a given </span>
<span class="sd">        geographic bounding box, computes spatial statistics on valid (non-NaN) values, and formats </span>
<span class="sd">        the results for annotation in PyGMT plots.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        da : xarray.DataArray</span>
<span class="sd">            2D gridded data array (e.g., fast ice persistence) with latitude and longitude coordinates.</span>
<span class="sd">        region : list or tuple of float</span>
<span class="sd">            Bounding box for the region in the form [lon_min, lon_max, lat_min, lat_max].</span>
<span class="sd">        lon_coord_name : str</span>
<span class="sd">            Name of the longitude coordinate in `da` (e.g., &#39;TLON&#39;).</span>
<span class="sd">        lat_coord_name : str</span>
<span class="sd">            Name of the latitude coordinate in `da` (e.g., &#39;TLAT&#39;).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of str</span>
<span class="sd">            Formatted text lines with:</span>
<span class="sd">            - Mean</span>
<span class="sd">            - Standard deviation</span>
<span class="sd">            - Data extent (number of valid grid cells)</span>
<span class="sd">            - Minimum value and its lat/lon location</span>
<span class="sd">            - Maximum value and its lat/lon location</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Longitude and latitude slices are derived using `np.searchsorted`, assuming monotonic grid coordinates.</span>
<span class="sd">        - Only finite (non-NaN) values are included in statistics.</span>
<span class="sd">        - Output is intended to be used directly in `fig.text()` or `fig.legend()` in PyGMT plotting routines.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; stats = self.generate_regional_annotation_stats(FIP_DA, region=[0, 90, -75, -60], lon_coord_name=&#39;TLON&#39;, lat_coord_name=&#39;TLAT&#39;)</span>
<span class="sd">        &gt;&gt;&gt; for line in stats:</span>
<span class="sd">        &gt;&gt;&gt;     print(line)</span>
<span class="sd">        Mean: 0.73</span>
<span class="sd">        Std: 0.18</span>
<span class="sd">        Extent: 1246</span>
<span class="sd">        Min:  0.02 at (-68.41, 23.65)</span>
<span class="sd">        Max: 1.00 at (-66.82, 45.12)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the latitude and longitude coordinates (TLAT, TLON)</span>
        <span class="n">da_lats</span>    <span class="o">=</span> <span class="n">da</span><span class="p">[</span><span class="n">lat_coord_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">da_lons</span>    <span class="o">=</span> <span class="n">da</span><span class="p">[</span><span class="n">lon_coord_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">lon_min_ni</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">da_lons</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">region</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">lon_max_ni</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">da_lons</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">region</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>        
        <span class="n">lat_min_nj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">da_lats</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">region</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">lat_max_nj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">da_lats</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">region</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">da_sliced</span>  <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">nj</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lat_min_nj</span><span class="p">,</span> <span class="n">lat_max_nj</span><span class="p">),</span> <span class="n">ni</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lon_min_ni</span><span class="p">,</span> <span class="n">lon_max_ni</span><span class="p">))</span>
        <span class="n">lon_sliced</span> <span class="o">=</span> <span class="n">da</span><span class="p">[</span><span class="n">lon_coord_name</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">nj</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lat_min_nj</span><span class="p">,</span> <span class="n">lat_max_nj</span><span class="p">),</span> <span class="n">ni</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lon_min_ni</span><span class="p">,</span> <span class="n">lon_max_ni</span><span class="p">))</span>
        <span class="n">lat_sliced</span> <span class="o">=</span> <span class="n">da</span><span class="p">[</span><span class="n">lat_coord_name</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">nj</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lat_min_nj</span><span class="p">,</span> <span class="n">lat_max_nj</span><span class="p">),</span> <span class="n">ni</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lon_min_ni</span><span class="p">,</span> <span class="n">lon_max_ni</span><span class="p">))</span>
        <span class="c1"># Get the data, latitudes, and longitudes</span>
        <span class="n">data</span>       <span class="o">=</span> <span class="n">da_sliced</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">lat</span>        <span class="o">=</span> <span class="n">lat_sliced</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">lon</span>        <span class="o">=</span> <span class="n">lon_sliced</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">data_valid</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
        <span class="n">lat_valid</span>  <span class="o">=</span> <span class="n">lat</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
        <span class="n">lon_valid</span>  <span class="o">=</span> <span class="n">lon</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
        <span class="c1"># Calculate statistics</span>
        <span class="n">spatial_mean</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data_valid</span><span class="p">)</span>
        <span class="n">spatial_std</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data_valid</span><span class="p">)</span>
        <span class="n">spatial_extent</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_valid</span><span class="p">)</span>
        <span class="n">data_min</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data_valid</span><span class="p">)</span>
        <span class="n">data_max</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data_valid</span><span class="p">)</span>
        <span class="c1"># Get min/max locations (lat, lon)</span>
        <span class="n">min_index</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">data_valid</span><span class="p">)</span>
        <span class="n">max_index</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">data_valid</span><span class="p">)</span>
        <span class="n">min_location</span> <span class="o">=</span> <span class="p">(</span><span class="n">lat_valid</span><span class="p">[</span><span class="n">min_index</span><span class="p">],</span> <span class="n">lon_valid</span><span class="p">[</span><span class="n">min_index</span><span class="p">])</span>
        <span class="n">max_location</span> <span class="o">=</span> <span class="p">(</span><span class="n">lat_valid</span><span class="p">[</span><span class="n">max_index</span><span class="p">],</span> <span class="n">lon_valid</span><span class="p">[</span><span class="n">max_index</span><span class="p">])</span>
        <span class="c1"># Format text to display</span>
        <span class="n">text</span>  <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Mean: </span><span class="si">{</span><span class="n">spatial_mean</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Std: </span><span class="si">{</span><span class="n">spatial_std</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Extent: </span><span class="si">{</span><span class="n">spatial_extent</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Min:  </span><span class="si">{</span><span class="n">data_min</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">min_location</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Max: </span><span class="si">{</span><span class="n">data_max</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">max_location</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">text</span></div>


<div class="viewcode-block" id="SeaIcePlotter.extract_min_max_dates">
<a class="viewcode-back" href="../sea_ice_plotter.html#sea_ice_plotter.SeaIcePlotter.extract_min_max_dates">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_min_max_dates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts_dict</span><span class="p">,</span> <span class="n">keys2plot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="s1">&#39;FIA&#39;</span><span class="p">,</span> <span class="n">time_coord</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract the minimum and maximum datetime values from time series data.</span>

<span class="sd">        This method scans through a dictionary of time series objects (either xarray.DataArrays,</span>
<span class="sd">        xarray.Datasets, or nested dictionaries containing a DataArray under `primary_key`),</span>
<span class="sd">        and returns the earliest and latest valid time values found across all selected entries.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ts_dict : dict</span>
<span class="sd">            A dictionary where each value is either:</span>
<span class="sd">            - an xarray.DataArray with a `time_coord` coordinate, or</span>
<span class="sd">            - a dictionary containing a DataArray under the key `primary_key`.</span>
<span class="sd">            Keys typically represent simulation or experiment identifiers.</span>

<span class="sd">        keys2plot : list of str, optional</span>
<span class="sd">            If provided, restricts the operation to keys within this list.</span>
<span class="sd">            Keys not in `keys2plot` will be skipped.</span>

<span class="sd">        primary_key : str, default &#39;FIA&#39;</span>
<span class="sd">            The key to use when accessing nested dictionaries within `ts_dict`.</span>
<span class="sd">            Ignored if the value is already a DataArray or Dataset.</span>

<span class="sd">        time_coord : str, default &#39;time&#39;</span>
<span class="sd">            The name of the time coordinate to extract from each DataArray.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tmin : pandas.Timestamp</span>
<span class="sd">            The earliest datetime found across all valid time series.</span>

<span class="sd">        tmax : pandas.Timestamp</span>
<span class="sd">            The latest datetime found across all valid time series.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Entries in `ts_dict` with missing or malformed time coordinates are skipped.</span>
<span class="sd">        - The key &quot;AF2020&quot; is always excluded.</span>
<span class="sd">        - If no valid entries remain after filtering, a warning is logged and `None` is returned.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_dts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dict_key</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">ts_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">keys2plot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dict_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys2plot</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">dict_key</span> <span class="o">==</span> <span class="s2">&quot;AF2020&quot;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dict_key</span><span class="si">}</span><span class="s2"> simulation will be included in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_method_name</span><span class="p">()</span><span class="si">}</span><span class="s2">()&quot;</span><span class="p">)</span>
            <span class="c1"># Handle both nested dict and direct DataArray</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">primary_key</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">da</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">primary_key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">da</span> <span class="o">=</span> <span class="n">data</span>  <span class="c1"># assume data is already a DataArray</span>
            <span class="n">df_dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="n">time_coord</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)})</span>
            <span class="n">df_dts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_dt</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">df_dts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No data to plot after filtering with keys2plot.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">df_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_dts</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">all_times</span> <span class="o">=</span> <span class="n">df_all</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">all_times</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">all_times</span><span class="o">.</span><span class="n">max</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_hex_to_rgb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hexstr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">hexstr</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span> <span class="mi">16</span><span class="p">))</span>

<div class="viewcode-block" id="SeaIcePlotter.write_tricolour_cpt">
<a class="viewcode-back" href="../sea_ice_plotter.html#sea_ice_plotter.SeaIcePlotter.write_tricolour_cpt">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_tricolour_cpt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">P_cpt</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">vmin</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">vmid</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span>  <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">vmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span>  <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">cmin</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;#2CA25F&quot;</span><span class="p">,</span>  <span class="c1"># green</span>
        <span class="n">cmid</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;#FDAE61&quot;</span><span class="p">,</span>  <span class="c1"># orange</span>
        <span class="n">cmax</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;#2171B5&quot;</span><span class="p">,</span>  <span class="c1"># blue</span>
        <span class="n">background_rgb</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;255/255/255&quot;</span><span class="p">,</span>
        <span class="n">foreground_rgb</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;0/0/0&quot;</span><span class="p">,</span>
        <span class="n">nan_rgb</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;255/255/255&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">r1</span><span class="p">,</span> <span class="n">g1</span><span class="p">,</span> <span class="n">b1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hex_to_rgb</span><span class="p">(</span><span class="n">cmin</span><span class="p">)</span>
        <span class="n">r2</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hex_to_rgb</span><span class="p">(</span><span class="n">cmid</span><span class="p">)</span>
        <span class="n">r3</span><span class="p">,</span> <span class="n">g3</span><span class="p">,</span> <span class="n">b3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hex_to_rgb</span><span class="p">(</span><span class="n">cmax</span><span class="p">)</span>

        <span class="n">cpt_text</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">vmin</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">r1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">g1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">b1</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">vmid</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">r2</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">g2</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">b2</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">vmid</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">r2</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">g2</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">b2</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">vmax</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">r3</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">g3</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">b3</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;B </span><span class="si">{</span><span class="n">background_rgb</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;F </span><span class="si">{</span><span class="n">foreground_rgb</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;N </span><span class="si">{</span><span class="n">nan_rgb</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="n">P_cpt</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">P_cpt</span><span class="p">)</span>
        <span class="n">P_cpt</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">P_cpt</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">cpt_text</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">P_cpt</span><span class="p">)</span></div>


<div class="viewcode-block" id="SeaIcePlotter.tricolor_cpt_and_alpha">
<a class="viewcode-back" href="../sea_ice_plotter.html#sea_ice_plotter.SeaIcePlotter.tricolor_cpt_and_alpha">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">tricolor_cpt_and_alpha</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">P_cpt</span><span class="p">,</span>
        <span class="n">obs</span><span class="p">,</span>
        <span class="n">mod</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="c1"># CPT</span>
        <span class="n">vmin</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">vmid</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span>  <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">vmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span>  <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">cmin</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;#2CA25F&quot;</span><span class="p">,</span>
        <span class="n">cmid</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;#FDAE61&quot;</span><span class="p">,</span>
        <span class="n">cmax</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;#2171B5&quot;</span><span class="p">,</span>
        <span class="c1"># difference sign</span>
        <span class="n">diff_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;obs-mod&quot;</span><span class="p">,</span>   <span class="c1"># recommended for green=model-dom, blue=obs-dom</span>
        <span class="c1"># alpha rule</span>
        <span class="n">alpha_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;max&quot;</span><span class="p">,</span>      <span class="c1"># &quot;max&quot; or &quot;mean&quot;</span>
        <span class="n">alpha_power</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">alpha_floor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">nan_transparency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">,</span>  <span class="c1"># percent (0 opaque, 100 transparent)</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns (cpt_path, z, t)</span>
<span class="sd">        z: clipped difference in [vmin,vmax]</span>
<span class="sd">        t: transparency percent in [0,100] (0 opaque)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cpt_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_tricolour_cpt</span><span class="p">(</span>
            <span class="n">P_cpt</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmid</span><span class="o">=</span><span class="n">vmid</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmin</span><span class="o">=</span><span class="n">cmin</span><span class="p">,</span> <span class="n">cmid</span><span class="o">=</span><span class="n">cmid</span><span class="p">,</span> <span class="n">cmax</span><span class="o">=</span><span class="n">cmax</span>
        <span class="p">)</span>

        <span class="n">obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">dm</span> <span class="o">=</span> <span class="n">diff_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dm</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;obs-mod&quot;</span><span class="p">,</span> <span class="s2">&quot;obs_minus_mod&quot;</span><span class="p">):</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">obs</span> <span class="o">-</span> <span class="n">mod</span>
        <span class="k">elif</span> <span class="n">dm</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;mod-obs&quot;</span><span class="p">,</span> <span class="s2">&quot;mod_minus_obs&quot;</span><span class="p">):</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">mod</span> <span class="o">-</span> <span class="n">obs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;diff_mode must be &#39;obs-mod&#39; or &#39;mod-obs&#39;.&quot;</span><span class="p">)</span>

        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">)</span>

        <span class="n">am</span> <span class="o">=</span> <span class="n">alpha_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">am</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">mod</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">am</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span> <span class="o">+</span> <span class="n">mod</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;alpha_mode must be &#39;max&#39; or &#39;mean&#39;.&quot;</span><span class="p">)</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">alpha_power</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">**</span> <span class="n">alpha_power</span>
        <span class="k">if</span> <span class="n">alpha_floor</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">alpha_floor</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">alpha_floor</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span>

        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span>

        <span class="n">bad</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">|</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">bad</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bad</span><span class="p">,</span> <span class="n">nan_transparency</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bad</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cpt_path</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">t</span></div>


<div class="viewcode-block" id="SeaIcePlotter.write_tricolor_category_cpt">
<a class="viewcode-back" href="../sea_ice_plotter.html#sea_ice_plotter.SeaIcePlotter.write_tricolor_category_cpt">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_tricolor_category_cpt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">P_cpt</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="c1"># codes: 0=agreement, 1=model-dom, 2=obs-dom</span>
        <span class="n">int0</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
        <span class="n">int1</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">),</span>
        <span class="n">int2</span><span class="o">=</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">),</span>
        <span class="n">hex0</span><span class="o">=</span><span class="s2">&quot;#FDAE61&quot;</span><span class="p">,</span>  <span class="c1"># agreement = orange</span>
        <span class="n">hex1</span><span class="o">=</span><span class="s2">&quot;#2CA25F&quot;</span><span class="p">,</span>  <span class="c1"># model-dom = green</span>
        <span class="n">hex2</span><span class="o">=</span><span class="s2">&quot;#2171B5&quot;</span><span class="p">,</span>  <span class="c1"># obs-dom   = blue</span>
        <span class="n">background_rgb</span><span class="o">=</span><span class="s2">&quot;255/255/255&quot;</span><span class="p">,</span>
        <span class="n">foreground_rgb</span><span class="o">=</span><span class="s2">&quot;0/0/0&quot;</span><span class="p">,</span>
        <span class="n">nan_rgb</span><span class="o">=</span><span class="s2">&quot;255/255/255&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">r0</span><span class="p">,</span> <span class="n">g0</span><span class="p">,</span> <span class="n">b0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hex_to_rgb</span><span class="p">(</span><span class="n">hex0</span><span class="p">)</span>
        <span class="n">r1</span><span class="p">,</span> <span class="n">g1</span><span class="p">,</span> <span class="n">b1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hex_to_rgb</span><span class="p">(</span><span class="n">hex1</span><span class="p">)</span>
        <span class="n">r2</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hex_to_rgb</span><span class="p">(</span><span class="n">hex2</span><span class="p">)</span>

        <span class="n">cpt_text</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">int0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">r0</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">g0</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">b0</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">int0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">r0</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">g0</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">b0</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">int1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">r1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">g1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">b1</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">int1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">r1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">g1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">b1</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">int2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">r2</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">g2</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">b2</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">int2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">r2</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">g2</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">b2</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;B </span><span class="si">{</span><span class="n">background_rgb</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;F </span><span class="si">{</span><span class="n">foreground_rgb</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;N </span><span class="si">{</span><span class="n">nan_rgb</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="n">P_cpt</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">P_cpt</span><span class="p">)</span>
        <span class="n">P_cpt</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">P_cpt</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">cpt_text</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">P_cpt</span><span class="p">)</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_is_dask_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;compute&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;dask&quot;</span> <span class="ow">in</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_auto_mask_zero</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">da</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decide whether to mask zeros:</span>
<span class="sd">          - categorical fields (e.g., diff_cat with flag_values) -&gt; do NOT mask zero</span>
<span class="sd">          - continuous fields -&gt; mask zero by default</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">fv</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flag_values&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="n">is_categorical</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;diff_cat&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">fv</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;0 1 2&quot;</span><span class="p">,</span> <span class="s2">&quot;0 1 2 &quot;</span><span class="p">})</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">is_categorical</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_lonlat_2d</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">da2</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">bcoords</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">tcoords</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">lon_coord_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">lat_coord_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">infer_if_missing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return (lon2d, lat2d) as numpy arrays matching da2.shape.</span>
<span class="sd">        Priority:</span>
<span class="sd">          1) explicit coord names (lon_coord_name/lat_coord_name) present in da2</span>
<span class="sd">          2) infer from common coord names in da2 if infer_if_missing</span>
<span class="sd">          3) B/T grid (self.G_u / self.G_t) with nj/ni subsetting</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure clean 2D view, and standard ordering if possible</span>
        <span class="k">if</span> <span class="n">da2</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected 2D DataArray; got dims=</span><span class="si">{</span><span class="n">da2</span><span class="o">.</span><span class="n">dims</span><span class="si">}</span><span class="s2">, shape=</span><span class="si">{</span><span class="n">da2</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># ---- 1) Explicit coords ----</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lon_coord_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">lat_coord_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lon_coord_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lat_coord_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide both lon_coord_name and lat_coord_name.&quot;</span><span class="p">)</span>
            <span class="n">lon_da</span> <span class="o">=</span> <span class="n">da2</span><span class="p">[</span><span class="n">lon_coord_name</span><span class="p">]</span>
            <span class="n">lat_da</span> <span class="o">=</span> <span class="n">da2</span><span class="p">[</span><span class="n">lat_coord_name</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">lon_da</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">lat_da</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># align dims if needed</span>
                <span class="k">if</span> <span class="n">lon_da</span><span class="o">.</span><span class="n">dims</span> <span class="o">!=</span> <span class="n">da2</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                    <span class="n">da2</span> <span class="o">=</span> <span class="n">da2</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">*</span><span class="n">lon_da</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
                    <span class="n">lon_da</span> <span class="o">=</span> <span class="n">da2</span><span class="p">[</span><span class="n">lon_coord_name</span><span class="p">]</span>
                    <span class="n">lat_da</span> <span class="o">=</span> <span class="n">da2</span><span class="p">[</span><span class="n">lat_coord_name</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lon_da</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lat_da</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">lon_da</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">lat_da</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">lon2d</span><span class="p">,</span> <span class="n">lat2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lon_da</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lat_da</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;xy&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">lon2d</span><span class="p">,</span> <span class="n">lat2d</span>

            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mixed/unsupported explicit coord dims: lon=</span><span class="si">{</span><span class="n">lon_da</span><span class="o">.</span><span class="n">ndim</span><span class="si">}</span><span class="s2">, lat=</span><span class="si">{</span><span class="n">lat_da</span><span class="o">.</span><span class="n">ndim</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># ---- 2) Infer coords from da2 ----</span>
        <span class="k">if</span> <span class="n">infer_if_missing</span><span class="p">:</span>
            <span class="c1"># common patterns</span>
            <span class="n">cand_pairs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="s2">&quot;latitude&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;TLON&quot;</span><span class="p">,</span> <span class="s2">&quot;TLAT&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;ULON&quot;</span><span class="p">,</span> <span class="s2">&quot;ULAT&quot;</span><span class="p">),</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">xnm</span><span class="p">,</span> <span class="n">ynm</span> <span class="ow">in</span> <span class="n">cand_pairs</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">xnm</span> <span class="ow">in</span> <span class="n">da2</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ynm</span> <span class="ow">in</span> <span class="n">da2</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span>
                    <span class="n">lon_da</span> <span class="o">=</span> <span class="n">da2</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">xnm</span><span class="p">]</span>
                    <span class="n">lat_da</span> <span class="o">=</span> <span class="n">da2</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">ynm</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">lon_da</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">lat_da</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">lon_da</span><span class="o">.</span><span class="n">dims</span> <span class="o">!=</span> <span class="n">da2</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                            <span class="n">da2</span> <span class="o">=</span> <span class="n">da2</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">*</span><span class="n">lon_da</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
                            <span class="n">lon_da</span> <span class="o">=</span> <span class="n">da2</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">xnm</span><span class="p">]</span>
                            <span class="n">lat_da</span> <span class="o">=</span> <span class="n">da2</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">ynm</span><span class="p">]</span>
                        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lon_da</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lat_da</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">lon_da</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">lat_da</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">lon2d</span><span class="p">,</span> <span class="n">lat2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lon_da</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lat_da</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;xy&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">lon2d</span><span class="p">,</span> <span class="n">lat2d</span>

        <span class="c1"># ---- 3) B/T grid coords ----</span>
        <span class="k">if</span> <span class="n">bcoords</span> <span class="ow">and</span> <span class="n">tcoords</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot set both bcoords and tcoords True.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bcoords</span> <span class="ow">or</span> <span class="n">tcoords</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must set bcoords or tcoords, or provide lon/lat coords on da.&quot;</span><span class="p">)</span>

        <span class="c1"># Only load grid if we need it</span>
        <span class="c1"># (adjust to your class: load_bgrid may load both; otherwise add load_tgrid, etc.)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_bgrid</span><span class="p">(</span><span class="n">slice_hem</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bcoords</span><span class="p">:</span>
            <span class="n">lon2d_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G_u</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">lat2d_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G_u</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lon2d_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G_t</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">lat2d_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G_t</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lon2d_full</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">da2</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">lon2d_full</span><span class="p">,</span> <span class="n">lat2d_full</span>

        <span class="c1"># subset lon/lat to match da2 using nj/ni index coords</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;nj&quot;</span> <span class="ow">in</span> <span class="n">da2</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;ni&quot;</span> <span class="ow">in</span> <span class="n">da2</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span>
            <span class="n">nj_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">da2</span><span class="p">[</span><span class="s2">&quot;nj&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">ni_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">da2</span><span class="p">[</span><span class="s2">&quot;ni&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">lon2d_full</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">nj_idx</span><span class="p">,</span> <span class="n">ni_idx</span><span class="p">)],</span> <span class="n">lat2d_full</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">nj_idx</span><span class="p">,</span> <span class="n">ni_idx</span><span class="p">)]</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Grid lon/lat shape </span><span class="si">{</span><span class="n">lon2d_full</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> does not match da shape </span><span class="si">{</span><span class="n">da2</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="s2">&quot;and da has no nj/ni coords for subsetting.&quot;</span>
        <span class="p">)</span>

<div class="viewcode-block" id="SeaIcePlotter.pygmt_da_prep">
<a class="viewcode-back" href="../sea_ice_plotter.html#sea_ice_plotter.SeaIcePlotter.pygmt_da_prep">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pygmt_da_prep</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">da</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">bcoords</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">tcoords</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">lon_coord_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">lat_coord_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">region</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">lon_wrap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>   <span class="c1"># &quot;auto&quot; | &quot;0-360&quot; | &quot;-180-180&quot;</span>
        <span class="n">extra_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mask_zero</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">z_clip</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">z_range_mask</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;float32&quot;</span><span class="p">,</span>
        <span class="n">infer_coords</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">return_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>         <span class="c1"># NEW</span>
        <span class="n">return_flat_index</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dict with 1D arrays for PyGMT plotting.</span>

<span class="sd">        Always returns: lon, lat, z</span>
<span class="sd">        Optionally returns:</span>
<span class="sd">        - mask2d: 2D boolean mask on da2 grid</span>
<span class="sd">        - flat_idx: 1D integer indices into da2.ravel() where mask is True</span>
<span class="sd">        - shape: original 2D shape (for sanity checks)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">da2</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">da2</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected 2D DataArray after squeeze; got dims=</span><span class="si">{</span><span class="n">da2</span><span class="o">.</span><span class="n">dims</span><span class="si">}</span><span class="s2">, shape=</span><span class="si">{</span><span class="n">da2</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># prefer canonical order if present</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;nj&quot;</span> <span class="ow">in</span> <span class="n">da2</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;ni&quot;</span> <span class="ow">in</span> <span class="n">da2</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">da2</span><span class="o">.</span><span class="n">dims</span> <span class="o">!=</span> <span class="p">(</span><span class="s2">&quot;nj&quot;</span><span class="p">,</span> <span class="s2">&quot;ni&quot;</span><span class="p">)):</span>
            <span class="n">da2</span> <span class="o">=</span> <span class="n">da2</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;nj&quot;</span><span class="p">,</span> <span class="s2">&quot;ni&quot;</span><span class="p">)</span>

        <span class="n">lon2d</span><span class="p">,</span> <span class="n">lat2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_lonlat_2d</span><span class="p">(</span>
            <span class="n">da2</span><span class="p">,</span>
            <span class="n">bcoords</span><span class="o">=</span><span class="n">bcoords</span><span class="p">,</span>
            <span class="n">tcoords</span><span class="o">=</span><span class="n">tcoords</span><span class="p">,</span>
            <span class="n">lon_coord_name</span><span class="o">=</span><span class="n">lon_coord_name</span><span class="p">,</span>
            <span class="n">lat_coord_name</span><span class="o">=</span><span class="n">lat_coord_name</span><span class="p">,</span>
            <span class="n">infer_if_missing</span><span class="o">=</span><span class="n">infer_coords</span><span class="p">,</span>
        <span class="p">)</span>
        
        <span class="c1"># ---- NEW: harmonise lon convention with region ----</span>
        <span class="k">if</span> <span class="n">lon_wrap</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">region</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">region</span>

                <span class="c1"># If region uses negative longitudes, force lon to -180..180</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">xmin</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">):</span>
                    <span class="n">lon2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalise_longitudes</span><span class="p">(</span><span class="n">lon2d</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="s2">&quot;-180-180&quot;</span><span class="p">)</span>

                <span class="c1"># If region is clearly 0..360-ish, force lon to 0..360</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">xmin</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">&gt;</span> <span class="mf">180.0</span><span class="p">):</span>
                    <span class="n">lon2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalise_longitudes</span><span class="p">(</span><span class="n">lon2d</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="s2">&quot;0-360&quot;</span><span class="p">)</span>
                <span class="c1"># else: leave as-is</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lon2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalise_longitudes</span><span class="p">(</span><span class="n">lon2d</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="n">lon_wrap</span><span class="p">)</span>

        <span class="c1"># materialize Z</span>
        <span class="n">z_data</span> <span class="o">=</span> <span class="n">da2</span><span class="o">.</span><span class="n">data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_dask_array</span><span class="p">(</span><span class="n">z_data</span><span class="p">):</span>
            <span class="n">z2d</span> <span class="o">=</span> <span class="n">da2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">z_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">z_clip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">z2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">z2d</span><span class="p">,</span> <span class="n">z_clip</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">z_clip</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># base mask</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">z2d</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mask_zero</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask_zero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_mask_zero</span><span class="p">(</span><span class="n">da2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask_zero</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">z2d</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">z_range_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">z_range_mask</span>
            <span class="n">m</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">z2d</span> <span class="o">&gt;=</span> <span class="n">lo</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">z2d</span> <span class="o">&lt;=</span> <span class="n">hi</span><span class="p">)</span>

        <span class="c1"># ---- region mask (DATELINE-SAFE) ----</span>
        <span class="k">if</span> <span class="n">region</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">region</span>

            <span class="n">lat_ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">lat2d</span> <span class="o">&gt;=</span> <span class="n">ymin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat2d</span> <span class="o">&lt;=</span> <span class="n">ymax</span><span class="p">)</span>

            <span class="c1"># handle regions that cross the dateline by allowing xmin &gt; xmax</span>
            <span class="k">if</span> <span class="n">xmin</span> <span class="o">&lt;=</span> <span class="n">xmax</span><span class="p">:</span>
                <span class="n">lon_ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon2d</span> <span class="o">&gt;=</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lon2d</span> <span class="o">&lt;=</span> <span class="n">xmax</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lon_ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon2d</span> <span class="o">&gt;=</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">lon2d</span> <span class="o">&lt;=</span> <span class="n">xmax</span><span class="p">)</span>

            <span class="n">m</span> <span class="o">&amp;=</span> <span class="n">lon_ok</span> <span class="o">&amp;</span> <span class="n">lat_ok</span>
        <span class="c1"># if region is not None:</span>
        <span class="c1">#     xmin, xmax, ymin, ymax = region</span>
        <span class="c1">#     m &amp;= (lon2d &gt;= xmin) &amp; (lon2d &lt;= xmax) &amp; (lat2d &gt;= ymin) &amp; (lat2d &lt;= ymax)</span>

        <span class="k">if</span> <span class="n">extra_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">em</span> <span class="o">=</span> <span class="n">extra_mask</span><span class="p">(</span><span class="n">da2</span><span class="p">)</span> <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">extra_mask</span><span class="p">)</span> <span class="k">else</span> <span class="n">extra_mask</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">em</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
                <span class="n">em</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">em</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">em</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">em</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">em</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">z2d</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extra_mask shape mismatch: </span><span class="si">{</span><span class="n">em</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">z2d</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">&amp;=</span> <span class="n">em</span>

        <span class="n">lon1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lon2d</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">lat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lat2d</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">z1</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">z2d</span><span class="p">,</span>  <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="n">lon1</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">lat1</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">z1</span><span class="p">,</span> <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="n">z2d</span><span class="o">.</span><span class="n">shape</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">return_mask</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;mask2d&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>

        <span class="k">if</span> <span class="n">return_flat_index</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;flat_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="SeaIcePlotter.pygmt_map_plot_one_var">
<a class="viewcode-back" href="../sea_ice_plotter.html#sea_ice_plotter.SeaIcePlotter.pygmt_map_plot_one_var">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pygmt_map_plot_one_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span>
                               <span class="n">sim_name</span>       <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">plot_regions</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">regional_dict</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">hemisphere</span>     <span class="o">=</span> <span class="s2">&quot;south&quot;</span><span class="p">,</span>
                               <span class="n">time_stamp</span>     <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">tit_str</span>        <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">plot_GI</span>        <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                               <span class="n">cmap</span>           <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">series</span>         <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">reverse</span>        <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">cbar_label</span>     <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">cbar_units</span>     <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">extend_cbar</span>    <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                               <span class="n">cbar_position</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">lon_coord_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">lat_coord_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">use_bcoords</span>    <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                               <span class="n">use_tcoords</span>    <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                               <span class="n">fig_size</span>       <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">var_sq_size</span>    <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
                               <span class="n">GI_sq_size</span>     <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
                               <span class="n">GI_fill_color</span>  <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
                               <span class="n">plot_iceshelves</span><span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                               <span class="n">plot_bathymetry</span><span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                               <span class="n">add_stat_annot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                               <span class="n">land_color</span>     <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">water_color</span>    <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">P_png</span>          <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">var_out</span>        <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">overwrite_fig</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">show_fig</span>       <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a PyGMT figure showing a variable (e.g., FIA, FIP, differences) as a spatial map</span>
<span class="sd">        over Antarctic regions or hemispheric view, optionally including grounded icebergs,</span>
<span class="sd">        ice shelf outlines, and bathymetry.</span>

<span class="sd">        This flexible mapping function supports multiple types of visualizations:</span>
<span class="sd">        - Scalar field plots (e.g., fast ice persistence, concentration)</span>
<span class="sd">        - Binary or categorical masks (e.g., agreement maps, simulation masks)</span>
<span class="sd">        - Difference plots (e.g., observation minus simulation)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        da : xarray.DataArray</span>
<span class="sd">            Input 2D (or broadcastable) data array to be plotted, e.g., fast ice persistence.</span>
<span class="sd">        var_name : str</span>
<span class="sd">            Name of the variable to be plotted. Used to look up color map settings and labels.</span>
<span class="sd">        sim_name : str, optional</span>
<span class="sd">            Simulation name used for file naming and figure annotation. Defaults to `self.sim_name`.</span>
<span class="sd">        plot_regions : int or None, optional</span>
<span class="sd">            Number of regional plots:</span>
<span class="sd">            - 8 : Antarctic 8-sector view</span>
<span class="sd">            - 2 : East/West sectors</span>
<span class="sd">            - None : Full hemisphere plot (default)</span>
<span class="sd">        regional_dict : dict, optional</span>
<span class="sd">            Custom dictionary of plotting regions (overrides built-ins if provided).</span>
<span class="sd">        hemisphere : str, default=&quot;south&quot;</span>
<span class="sd">            Hemisphere name for hemispheric plot. Typically &quot;south&quot;.</span>
<span class="sd">        time_stamp : str, optional</span>
<span class="sd">            Timestamp string for file naming. Defaults to `self.dt0_str`.</span>
<span class="sd">        tit_str : str, optional</span>
<span class="sd">            Title string to display on the figure.</span>
<span class="sd">        plot_GI : bool, default=False</span>
<span class="sd">            Whether to overlay grounded iceberg locations using `load_GI_lon_lats()`.</span>
<span class="sd">        cmap : str, optional</span>
<span class="sd">            Color map name for continuous scalar plots.</span>
<span class="sd">        series : list of float, optional</span>
<span class="sd">            Min, max, and increment for the colorbar (e.g., [0, 1, 0.1]).</span>
<span class="sd">        reverse : bool, optional</span>
<span class="sd">            Whether to reverse the colormap.</span>
<span class="sd">        cbar_label : str, optional</span>
<span class="sd">            Label to show on the colorbar.</span>
<span class="sd">        cbar_units : str, optional</span>
<span class="sd">            Units for the colorbar (shown on secondary axis).</span>
<span class="sd">        extend_cbar : bool, default=False</span>
<span class="sd">            Whether to add extension arrows to colorbar.</span>
<span class="sd">        cbar_position : str, optional</span>
<span class="sd">            PyGMT-compatible position string for placing the colorbar.</span>
<span class="sd">        lon_coord_name : str, optional</span>
<span class="sd">            Longitude coordinate name in `da`. Defaults to `self.pygmt_dict`.</span>
<span class="sd">        lat_coord_name : str, optional</span>
<span class="sd">            Latitude coordinate name in `da`. Defaults to `self.pygmt_dict`.</span>
<span class="sd">        fig_size : float, optional</span>
<span class="sd">            Figure width in centimeters for hemispheric plot.</span>
<span class="sd">        var_sq_size : float, default=0.2</span>
<span class="sd">            Marker size (in cm) for main plotted variable (for scatter plotting).</span>
<span class="sd">        GI_sq_size : float, default=0.1</span>
<span class="sd">            Marker size (in cm) for grounded iceberg overlay.</span>
<span class="sd">        GI_fill_color : str, default=&quot;red&quot;</span>
<span class="sd">            Color to use for grounded iceberg markers.</span>
<span class="sd">        plot_iceshelves : bool, default=True</span>
<span class="sd">            Whether to overlay Antarctic ice shelf outlines.</span>
<span class="sd">        plot_bathymetry : bool, default=True</span>
<span class="sd">            Whether to plot IBCSO bathymetry using shaded relief (`grdimage`).</span>
<span class="sd">        add_stat_annot : bool, default=False</span>
<span class="sd">            Whether to annotate figure with basic regional statistics.</span>
<span class="sd">        land_color : str, optional</span>
<span class="sd">            Color for land. Defaults to `self.pygmt_dict[&#39;land_color&#39;]`.</span>
<span class="sd">        water_color : str, optional</span>
<span class="sd">            Color for ocean/water. Defaults to `self.pygmt_dict[&#39;water_color&#39;]`.</span>
<span class="sd">        P_png : pathlib.Path, optional</span>
<span class="sd">            File path to save the figure. If None, path is generated automatically.</span>
<span class="sd">        var_out : str, optional</span>
<span class="sd">            Output variable name used in file naming. Defaults to `var_name`.</span>
<span class="sd">        overwrite_fig : bool, optional</span>
<span class="sd">            Whether to overwrite existing figure if it exists.</span>
<span class="sd">        show_fig : bool, optional</span>
<span class="sd">            Whether to display the figure interactively.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            The method generates and optionally saves or displays a PyGMT figure.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Supports 8-region, 2-region, or full hemisphere plotting via `plot_regions`.</span>
<span class="sd">        - For &quot;diff&quot; plots (where &#39;diff&#39; in var_name), colors are assigned categorically (e.g., agreement/simulation/observation).</span>
<span class="sd">        - Bathymetry and ice shelf overlays are loaded from NetCDF and shapefiles respectively.</span>
<span class="sd">        - The method gracefully skips plotting if required coordinates or data are missing.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        - self.pygmt_da_prep : Prepares data dictionary for plotting</span>
<span class="sd">        - self.create_cbar_frame           : Builds formatted colorbar strings</span>
<span class="sd">        - self.load_GI_lon_lats            : Loads grounded iceberg locations</span>
<span class="sd">        - self.load_ice_shelves            : Loads Antarctic ice shelf polygons</span>
<span class="sd">        - self.load_IBCSO_bath             : Loads bathymetry grid from IBCSO</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; self.pygmt_map_plot_one_var(FIP_DA, &quot;FIP&quot;, plot_regions=8, show_fig=True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sim_name</span>    <span class="o">=</span> <span class="n">sim_name</span>      <span class="k">if</span> <span class="n">sim_name</span>      <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_name</span>
        <span class="n">show_fig</span>    <span class="o">=</span> <span class="n">show_fig</span>      <span class="k">if</span> <span class="n">show_fig</span>      <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_fig</span>
        <span class="n">ow_fig</span>      <span class="o">=</span> <span class="n">overwrite_fig</span> <span class="k">if</span> <span class="n">overwrite_fig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ow_fig</span>
        <span class="n">time_stamp</span>  <span class="o">=</span> <span class="n">time_stamp</span>    <span class="k">if</span> <span class="n">time_stamp</span>    <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt0_str</span>
        <span class="c1">#lon_coord_name = lon_coord_name if lon_coord_name is not None else self.pygmt_dict.get(&quot;lon_coord_name&quot;, &quot;TLON&quot;)</span>
        <span class="c1">#lat_coord_name = lat_coord_name if lat_coord_name is not None else self.pygmt_dict.get(&quot;lat_coord_name&quot;, &quot;TLAT&quot;)</span>
        <span class="n">cmap</span>        <span class="o">=</span> <span class="n">cmap</span>          <span class="k">if</span> <span class="n">cmap</span>          <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_var_dict</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="s1">&#39;cmap&#39;</span><span class="p">]</span>
        <span class="n">series</span>      <span class="o">=</span> <span class="n">series</span>        <span class="k">if</span> <span class="n">series</span>        <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_var_dict</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="s1">&#39;series&#39;</span><span class="p">]</span>
        <span class="n">reverse</span>     <span class="o">=</span> <span class="n">reverse</span>       <span class="k">if</span> <span class="n">reverse</span>       <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_var_dict</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="s1">&#39;reverse&#39;</span><span class="p">]</span>
        <span class="n">cbar_lab</span>    <span class="o">=</span> <span class="n">cbar_label</span>    <span class="k">if</span> <span class="n">cbar_label</span>    <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_var_dict</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">cbar_units</span>  <span class="o">=</span> <span class="n">cbar_units</span>    <span class="k">if</span> <span class="n">cbar_units</span>    <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_var_dict</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
        <span class="n">fig_size</span>    <span class="o">=</span> <span class="n">fig_size</span>      <span class="k">if</span> <span class="n">fig_size</span>      <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">pygmt_dict</span><span class="p">[</span><span class="s1">&#39;fig_size&#39;</span><span class="p">]</span>
        <span class="n">cbar_pos</span>    <span class="o">=</span> <span class="n">cbar_position</span> <span class="k">if</span> <span class="n">cbar_position</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">pygmt_dict</span><span class="p">[</span><span class="s1">&#39;cbar_pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">fig_size</span><span class="o">*</span><span class="mf">0.8</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>
        <span class="n">land_color</span>  <span class="o">=</span> <span class="n">land_color</span>    <span class="k">if</span> <span class="n">land_color</span>    <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">pygmt_dict</span><span class="p">[</span><span class="s1">&#39;land_color&#39;</span><span class="p">]</span>
        <span class="n">water_color</span> <span class="o">=</span> <span class="n">water_color</span>   <span class="k">if</span> <span class="n">water_color</span>   <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">pygmt_dict</span><span class="p">[</span><span class="s1">&#39;water_color&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">var_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">var_out</span> <span class="o">=</span> <span class="n">var_name</span>
        <span class="k">if</span> <span class="n">plot_iceshelves</span><span class="p">:</span>
            <span class="n">ANT_IS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_ice_shelves</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">plot_bathymetry</span><span class="p">:</span>
            <span class="n">SO_BATH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_IBCSO_bath</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lon_coord_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lat_coord_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_data_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pygmt_da_prep</span><span class="p">(</span><span class="n">da</span><span class="p">,</span>
                                                <span class="n">bcoords</span>        <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                <span class="n">tcoords</span>        <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                <span class="n">lon_coord_name</span> <span class="o">=</span> <span class="n">lon_coord_name</span><span class="p">,</span>
                                                <span class="n">lat_coord_name</span> <span class="o">=</span> <span class="n">lat_coord_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_bcoords</span> <span class="ow">and</span> <span class="n">use_tcoords</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot set both use_bcoords and use_tcoords to True&quot;</span><span class="p">)</span>
            <span class="n">plot_data_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pygmt_da_prep</span><span class="p">(</span><span class="n">da</span><span class="p">,</span>
                                                <span class="n">bcoords</span>        <span class="o">=</span> <span class="n">use_bcoords</span><span class="p">,</span>
                                                <span class="n">tcoords</span>        <span class="o">=</span> <span class="n">use_tcoords</span><span class="p">,</span>
                                                <span class="n">lon_coord_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                                <span class="n">lat_coord_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">required_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plot_data_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;plot_data_dict is not a dictionary  skipping plot.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">required_keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plot_data_dict</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing key &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39; in plot_data_dict  skipping plot.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">plot_data_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;plot_data_dict[&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39;] is None  skipping plot.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;plot_data_dict[&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39;] is empty  skipping plot.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping plot due to error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">cbar_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_cbar_frame</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">cbar_lab</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">cbar_units</span><span class="p">,</span> <span class="n">extend_cbar</span><span class="o">=</span><span class="n">extend_cbar</span><span class="p">)</span>
        <span class="n">hem_plot</span>   <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">plot_GI</span><span class="p">:</span>
            <span class="n">plot_GI_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_GI_lon_lats</span><span class="p">()</span><span class="c1">#plot_data_dict)</span>
        <span class="k">if</span> <span class="n">plot_regions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">plot_regions</span><span class="o">==</span><span class="mi">8</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;method will plot eight Antarctic sectors regional dictionary&quot;</span><span class="p">)</span>
            <span class="n">reg_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ant_8sectors</span>
        <span class="k">elif</span> <span class="n">plot_regions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">plot_regions</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;method will plot two Antarctic sectors regional dictionary&quot;</span><span class="p">)</span>
            <span class="n">reg_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ant_2sectors</span>
        <span class="k">elif</span> <span class="n">plot_regions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">regional_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;method will plot regional dictionary passed to this method&quot;</span><span class="p">)</span>
            <span class="n">reg_dict</span> <span class="o">=</span> <span class="n">regional_dict</span>
        <span class="k">elif</span> <span class="n">plot_regions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">regional_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;plot_regions argument not valid&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;method will plot hemispheric data&quot;</span><span class="p">)</span>
            <span class="n">hem_plot</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">reg_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hemispheres_dict</span>
        <span class="k">if</span> <span class="n">tit_str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">basemap_frame</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;af&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;+t</span><span class="si">{</span><span class="n">tit_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">basemap_frame</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;af&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">reg_name</span><span class="p">,</span> <span class="n">reg_vals</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reg_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">hem_plot</span> <span class="ow">and</span> <span class="n">reg_name</span><span class="o">!=</span><span class="n">hemisphere</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">P_png</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_fig</span><span class="p">:</span>
                <span class="n">P_png</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D_graph</span><span class="p">,</span> <span class="n">sim_name</span><span class="p">,</span> <span class="n">reg_name</span><span class="p">,</span> <span class="n">var_out</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">time_stamp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sim_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">reg_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">var_out</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
            <span class="n">region</span>     <span class="o">=</span> <span class="n">reg_vals</span><span class="p">[</span><span class="s1">&#39;plot_region&#39;</span><span class="p">]</span>
            <span class="n">projection</span> <span class="o">=</span> <span class="n">reg_vals</span><span class="p">[</span><span class="s1">&#39;projection&#39;</span><span class="p">]</span>               
            <span class="k">if</span> <span class="n">hem_plot</span><span class="p">:</span>
                <span class="n">projection</span> <span class="o">=</span> <span class="n">projection</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fig_size</span><span class="o">=</span><span class="n">fig_size</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">reg_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ant_8sectors</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">MC</span>         <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_meridian_center_from_geographic_extent</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
                <span class="n">projection</span> <span class="o">=</span> <span class="n">projection</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">MC</span><span class="o">=</span><span class="n">MC</span><span class="p">,</span> <span class="n">fig_size</span><span class="o">=</span><span class="n">fig_size</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">reg_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ant_2sectors</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">projection</span> <span class="o">=</span> <span class="n">projection</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fig_width</span><span class="o">=</span><span class="n">fig_size</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">pygmt</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">pygmt</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">FONT_TITLE</span>         <span class="o">=</span> <span class="s2">&quot;16p,Courier-Bold&quot;</span><span class="p">,</span>
                              <span class="n">FONT_ANNOT_PRIMARY</span> <span class="o">=</span> <span class="s2">&quot;14p,Helvetica&quot;</span><span class="p">,</span>
                              <span class="n">COLOR_FOREGROUND</span>   <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">):</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">basemap</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">basemap_frame</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">plot_bathymetry</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">grdimage</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">SO_BATH</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;geo&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">coast</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span> <span class="n">shorelines</span><span class="o">=</span><span class="s2">&quot;1/0.5p,gray30&quot;</span><span class="p">,</span> <span class="n">land</span><span class="o">=</span><span class="n">land_color</span><span class="p">,</span> <span class="n">water</span><span class="o">=</span><span class="n">water_color</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;diff&quot;</span> <span class="ow">in</span> <span class="n">var_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">lat</span>        <span class="o">=</span> <span class="n">da</span><span class="p">[</span><span class="n">lat_coord_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="n">lon</span>        <span class="o">=</span> <span class="n">da</span><span class="p">[</span><span class="n">lon_coord_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="n">val</span>        <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="n">lat_valid</span>  <span class="o">=</span> <span class="n">lat</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
                    <span class="n">lon_valid</span>  <span class="o">=</span> <span class="n">lon</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
                    <span class="n">val_valid</span>  <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                    <span class="n">label_map</span>  <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;agreement&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;observation&quot;</span><span class="p">}</span>
                    <span class="n">labels</span>     <span class="o">=</span> <span class="p">[</span><span class="n">label_map</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val_valid</span><span class="p">]</span>
                    <span class="n">df</span>         <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;longitude&quot;</span> <span class="p">:</span> <span class="n">lon_valid</span><span class="p">,</span>
                                            <span class="s2">&quot;latitude&quot;</span>  <span class="p">:</span> <span class="n">lat_valid</span><span class="p">,</span>
                                            <span class="s2">&quot;z&quot;</span>         <span class="p">:</span> <span class="n">val_valid</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)})</span>
                    <span class="n">pygmt</span><span class="o">.</span><span class="n">makecpt</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;categorical&quot;</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">color_model</span><span class="o">=</span><span class="s2">&quot;+cagreement,simulation,observation&quot;</span><span class="p">)</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;s</span><span class="si">{</span><span class="n">var_sq_size</span><span class="si">}</span><span class="s2">c&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s2">&quot;mask&quot;</span> <span class="ow">in</span> <span class="n">var_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">plot_data_dict</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">plot_data_dict</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;s</span><span class="si">{</span><span class="n">var_sq_size</span><span class="si">}</span><span class="s2">c&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pygmt</span><span class="o">.</span><span class="n">makecpt</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">)</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">plot_data_dict</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">plot_data_dict</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">fill</span><span class="o">=</span><span class="n">plot_data_dict</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="n">style</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;s</span><span class="si">{</span><span class="n">var_sq_size</span><span class="si">}</span><span class="s2">c&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>           
                <span class="k">if</span> <span class="n">plot_bathymetry</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">coast</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span> <span class="n">shorelines</span><span class="o">=</span><span class="s2">&quot;1/0.5p,gray30&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">plot_GI</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">plot_GI_dict</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">plot_GI_dict</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">fill</span><span class="o">=</span><span class="n">GI_fill_color</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;c</span><span class="si">{</span><span class="n">GI_sq_size</span><span class="si">}</span><span class="s2">c&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">plot_iceshelves</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ANT_IS</span><span class="p">,</span> <span class="n">pen</span><span class="o">=</span><span class="s2">&quot;0.2p,gray&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;lightgray&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">add_stat_annot</span><span class="p">:</span>
                    <span class="n">annot_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_regional_annotation_stats</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">lon_coord_name</span><span class="p">,</span> <span class="n">lat_coord_name</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">annot_text</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="s2">&quot;TR&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">line</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="s2">&quot;12p,Helvetica-Bold,black&quot;</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;LM&quot;</span><span class="p">,</span> <span class="n">no_clip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;-1/</span><span class="si">{</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">pygmt</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">GMTCLibError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in plotting anotation text </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> -- skipping annotation&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;diff&quot;</span> <span class="ow">in</span> <span class="n">var_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="n">cbar_pos</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x+l&quot;</span> <span class="o">+</span> <span class="n">cbar_lab</span><span class="p">])</span>
                <span class="k">elif</span> <span class="s2">&quot;mask&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="n">cbar_pos</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">cbar_frame</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">pygmt</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">GMTCLibError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in adding colorbar: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">  skipping colorbar.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">P_png</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">P_png</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="n">P_png</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">P_png</span><span class="p">)</span>  
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved figure to </span><span class="si">{</span><span class="n">P_png</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>   
                    <span class="k">if</span> <span class="n">ow_fig</span><span class="p">:</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">P_png</span><span class="p">)</span>  
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved figure to </span><span class="si">{</span><span class="n">P_png</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">P_png</span><span class="si">}</span><span class="s2"> already exists and not overwriting&quot;</span><span class="p">)</span>
                <span class="n">P_png</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">show_fig</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">pygmt</span><span class="o">.</span><span class="n">clib</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="fm">__exit__</span></div>


<div class="viewcode-block" id="SeaIcePlotter.pygmt_fastice_panel">
<a class="viewcode-back" href="../sea_ice_plotter.html#sea_ice_plotter.SeaIcePlotter.pygmt_fastice_panel">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pygmt_fastice_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">fast_ice_variable</span> <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="s2">&quot;FIA&quot;</span><span class="p">,</span>   <span class="c1"># &quot;FIA&quot;|&quot;fia&quot; or &quot;FIT&quot;|&quot;fit&quot; or &quot;FIS|fis&quot;</span>
                            <span class="n">ice_class</span>         <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>    <span class="c1"># &quot;FI_BT&quot; ... see SeaIceToolbox for more help</span>
                            <span class="n">class_type</span>        <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="s2">&quot;bin&quot;</span><span class="p">,</span>   <span class="c1"># &#39;bin&#39;, &#39;roll&#39; or None</span>
                            <span class="n">sim_name</span>          <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">roll_days</span>         <span class="p">:</span> <span class="nb">int</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="c1"># Generic (can be overridden)</span>
                            <span class="n">fig_width</span>         <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">fig_height</span>        <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">ylim</span>              <span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">frame_bndy</span>        <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">yaxis_pri</span>         <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">xaxis_pri</span>         <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="s2">&quot;a1Of15Dg&quot;</span><span class="p">,</span>
                            <span class="n">leg_pos</span>           <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">leg_box</span>           <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="s2">&quot;+gwhite+p.5p&quot;</span><span class="p">,</span>
                            <span class="n">spat_var_style</span>    <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">GI_plot_style</span>     <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="s2">&quot;c0.05c&quot;</span><span class="p">,</span>
                            <span class="n">GI_fill_color</span>     <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="s2">&quot;#BA561A&quot;</span><span class="p">,</span>
                            <span class="n">plot_GI</span>           <span class="p">:</span> <span class="nb">bool</span>  <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="n">min_max_trans_val</span> <span class="p">:</span> <span class="nb">int</span>   <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
                            <span class="n">yshift_top</span>        <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">yshift_bot</span>        <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">bottom_frame_bndy</span> <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="s2">&quot;WSne&quot;</span><span class="p">,</span>
                            <span class="n">bottom_yaxis</span>      <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">bottom_xaxis</span>      <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">land_clr</span>          <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="s1">&#39;#D1DDE0&#39;</span><span class="p">,</span>
                            <span class="n">water_clr</span>         <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="s2">&quot;#EDF2F5&quot;</span><span class="p">,</span>
                            <span class="n">coast_pen</span>         <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="s2">&quot;1/0.5p,black&quot;</span><span class="p">,</span>
                            <span class="n">cbar_pos</span>          <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">lon_coord_name</span>    <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">lat_coord_name</span>    <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">cmap</span>              <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">series</span>            <span class="p">:</span> <span class="nb">list</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">cbar_frame</span>        <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">ANT_IS_pen</span>        <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="s2">&quot;0.2p,black&quot;</span><span class="p">,</span>
                            <span class="n">ANT_IS_color</span>      <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="s2">&quot;#C1CED6&quot;</span><span class="p">,</span>
                            <span class="n">font_annot_pri</span>    <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="s2">&quot;24p,Times-Roman&quot;</span><span class="p">,</span>
                            <span class="n">font_annot_sec</span>    <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="s2">&quot;16p,Times-Roman&quot;</span><span class="p">,</span>
                            <span class="n">font_lab</span>          <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="s2">&quot;22p,Times-Bold&quot;</span><span class="p">,</span>
                            <span class="n">line_pen</span>         <span class="p">:</span> <span class="nb">str</span>    <span class="o">=</span> <span class="s2">&quot;2p&quot;</span><span class="p">,</span>
                            <span class="n">grid_pen_pri</span>      <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="s2">&quot;.5p&quot;</span><span class="p">,</span>
                            <span class="n">grid_pen_sec</span>      <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="s2">&quot;.25p&quot;</span><span class="p">,</span>
                            <span class="n">fmt_geo_map</span>       <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="s2">&quot;D:mm&quot;</span><span class="p">,</span>
                            <span class="n">P_png</span>             <span class="p">:</span> <span class="nb">str</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">save_fig</span>          <span class="p">:</span> <span class="nb">bool</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">overwrite_fig</span>     <span class="p">:</span> <span class="nb">bool</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">show_fig</span>          <span class="p">:</span> <span class="nb">bool</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unified PyGMT fast-ice panel plotter.</span>

<span class="sd">        Set `fast_ice_variable` to:</span>
<span class="sd">            - &quot;FIA&quot; (or &quot;fia&quot;)  -&gt; plots FIA time series + FIP maps</span>
<span class="sd">            - &quot;FIT&quot; (or &quot;fit&quot;)  -&gt; plots FIT time series + FIHI maps</span>

<span class="sd">        Everything else (loading, styling, legends, grounded iceberg overlay, etc.)</span>
<span class="sd">        follows the same code path with variable-specific defaults injected via</span>
<span class="sd">        a small configuration dictionary.</span>

<span class="sd">        The rest of the arguments let you override those defaults if you need to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">fast_ice_variable</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;fia&quot;</span><span class="p">,</span> <span class="s2">&quot;fit&quot;</span><span class="p">,</span> <span class="s2">&quot;fis&quot;</span><span class="p">,</span> <span class="s2">&quot;fimar&quot;</span><span class="p">,</span> <span class="s2">&quot;fimvr&quot;</span><span class="p">,</span> <span class="s2">&quot;fitar&quot;</span><span class="p">,</span> <span class="s2">&quot;fitvr&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`fast_ice_variable` must be one of [&#39;FIA&#39;,&#39;FIT&#39;,&#39;FIS&#39;,&#39;FIMAR&#39;,&#39;FIMVR&#39;,&#39;FITAR&#39;,&#39;FITVR&#39;]; got </span><span class="si">{</span><span class="n">fast_ice_variable</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># -------------------------------------------------------------------------</span>
        <span class="c1"># Per-variable defaults (you can push more things in here if you like)</span>
        <span class="c1"># -------------------------------------------------------------------------</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pygmt_FI_panel</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
        <span class="c1"># -------------------------------------------------------------------------</span>
        <span class="c1"># Resolve user overrides or fall back to defaults</span>
        <span class="c1"># -------------------------------------------------------------------------</span>
        <span class="n">sim_name</span>       <span class="o">=</span> <span class="n">sim_name</span>       <span class="k">if</span> <span class="n">sim_name</span>       <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_name</span>
        <span class="n">ice_class</span>      <span class="o">=</span> <span class="n">ice_class</span>      <span class="k">if</span> <span class="n">ice_class</span>      <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ice_class</span>
        <span class="n">show_fig</span>       <span class="o">=</span> <span class="n">show_fig</span>       <span class="k">if</span> <span class="n">show_fig</span>       <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_fig</span>
        <span class="n">save_fig</span>       <span class="o">=</span> <span class="n">save_fig</span>       <span class="k">if</span> <span class="n">save_fig</span>       <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_fig</span>
        <span class="n">ow_fig</span>         <span class="o">=</span> <span class="n">overwrite_fig</span>  <span class="k">if</span> <span class="n">overwrite_fig</span>  <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ow_fig</span>
        <span class="n">frame_bndy</span>     <span class="o">=</span> <span class="n">frame_bndy</span>     <span class="k">if</span> <span class="n">frame_bndy</span>     <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;WS&quot;</span>
        <span class="n">fig_width</span>      <span class="o">=</span> <span class="n">fig_width</span>      <span class="k">if</span> <span class="n">fig_width</span>      <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;30c&quot;</span>
        <span class="n">fig_height</span>     <span class="o">=</span> <span class="n">fig_height</span>     <span class="k">if</span> <span class="n">fig_height</span>     <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;25c&quot;</span>
        <span class="n">spat_var_style</span> <span class="o">=</span> <span class="n">spat_var_style</span> <span class="k">if</span> <span class="n">spat_var_style</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;s0.2c&quot;</span>
        <span class="n">yshift_top</span>     <span class="o">=</span> <span class="n">yshift_top</span>     <span class="k">if</span> <span class="n">yshift_top</span>     <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;-6.25c&quot;</span>
        <span class="n">yshift_bot</span>     <span class="o">=</span> <span class="n">yshift_bot</span>     <span class="k">if</span> <span class="n">yshift_bot</span>     <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;-10.5c&quot;</span>
        <span class="n">bottom_yaxis</span>   <span class="o">=</span> <span class="n">bottom_yaxis</span>   <span class="k">if</span> <span class="n">bottom_yaxis</span>   <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;a5f1g&quot;</span>
        <span class="n">bottom_xaxis</span>   <span class="o">=</span> <span class="n">bottom_xaxis</span>   <span class="k">if</span> <span class="n">bottom_xaxis</span>   <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;a30f10g&quot;</span>
        <span class="n">cbar_pos</span>       <span class="o">=</span> <span class="n">cbar_pos</span>       <span class="k">if</span> <span class="n">cbar_pos</span>       <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;JBC+w25c/1c+mc+h&quot;</span>
        <span class="n">ylim</span>           <span class="o">=</span> <span class="n">ylim</span>           <span class="k">if</span> <span class="n">ylim</span>           <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;panel_ylim&quot;</span><span class="p">]</span>
        <span class="n">yaxis_pri</span>      <span class="o">=</span> <span class="n">yaxis_pri</span>      <span class="k">if</span> <span class="n">yaxis_pri</span>      <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;yaxis_pri&quot;</span><span class="p">]</span>
        <span class="n">leg_pos</span>        <span class="o">=</span> <span class="n">leg_pos</span>        <span class="k">if</span> <span class="n">leg_pos</span>        <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;leg_pos&quot;</span><span class="p">]</span>
        <span class="n">cbar_frame</span>     <span class="o">=</span> <span class="n">cbar_frame</span>     <span class="k">if</span> <span class="n">cbar_frame</span>     <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;cbar_frame&quot;</span><span class="p">]</span>
        <span class="n">cmap</span>           <span class="o">=</span> <span class="n">cmap</span>           <span class="k">if</span> <span class="n">cmap</span>           <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;cmap&quot;</span><span class="p">]</span>
        <span class="n">series</span>         <span class="o">=</span> <span class="n">series</span>         <span class="k">if</span> <span class="n">series</span>         <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;series&quot;</span><span class="p">]</span>
        <span class="c1"># -------------------------------------------------------------------------</span>
        <span class="c1"># Paths / loads</span>
        <span class="c1"># -------------------------------------------------------------------------</span>
        <span class="n">ANT_IS</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_ice_shelves</span><span class="p">()</span>
        <span class="n">ice_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ice_class</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ice_class</span><span class="si">}</span><span class="s2">_roll&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ice_class</span><span class="si">}</span><span class="s2">_bin&quot;</span><span class="p">]</span>
        <span class="n">ts_dict</span>     <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">var</span><span class="o">==</span><span class="s1">&#39;fia&#39;</span><span class="p">:</span>
            <span class="n">ts_dict</span><span class="p">[</span><span class="s2">&quot;AF2020&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AF_FI_dict</span><span class="p">[</span><span class="s1">&#39;P_AF2020_FIA&#39;</span><span class="p">])[</span><span class="s2">&quot;AF2020&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">iclass</span> <span class="ow">in</span> <span class="n">ice_classes</span><span class="p">:</span>
            <span class="n">P_mets</span>          <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D_ispd_thresh</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">iclass</span><span class="si">}</span><span class="s2">_mets.zarr&quot;</span><span class="p">)</span>
            <span class="n">ts_dict</span><span class="p">[</span><span class="n">iclass</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">P_mets</span><span class="p">)[</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;top_name&quot;</span><span class="p">]]</span>
        <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_min_max_dates</span><span class="p">(</span><span class="n">ts_dict</span><span class="p">)</span>
        <span class="c1"># prioritise binary-days classification, then rolling-mean</span>
        <span class="n">P_spat</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D_ispd_thresh</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ice_class</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">class_type</span><span class="si">}</span><span class="s2">_mets.zarr&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">class_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D_ispd_thresh</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ice_class</span><span class="si">}</span><span class="s2">_mets.zarr&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">da_spat</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">P_spat</span><span class="p">)[</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;bottom_name&quot;</span><span class="p">]]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;could not load </span><span class="si">{</span><span class="n">P_spat</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">df_spat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pygmt_da_prep</span><span class="p">(</span><span class="n">da_spat</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_GI</span><span class="p">:</span>
            <span class="n">plot_GI_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_GI_lon_lats</span><span class="p">()</span>
        <span class="c1"># -------------------------------------------------------------------------</span>
        <span class="c1"># Plot</span>
        <span class="c1"># -------------------------------------------------------------------------</span>
        <span class="n">plot_region</span>     <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">leap_year</span><span class="si">}</span><span class="s2">-01-01&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">leap_year</span><span class="si">}</span><span class="s2">-12-31&quot;</span><span class="p">,</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">plot_projection</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;X</span><span class="si">{</span><span class="n">fig_width</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">fig_height</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">frame</span>           <span class="o">=</span> <span class="p">[</span><span class="n">frame_bndy</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;px</span><span class="si">{</span><span class="n">xaxis_pri</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;py</span><span class="si">{</span><span class="n">yaxis_pri</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">pygmt</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">pygmt</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">FONT_ANNOT_PRIMARY</span>      <span class="o">=</span> <span class="n">font_annot_pri</span><span class="p">,</span>
                          <span class="n">FONT_ANNOT_SECONDARY</span>    <span class="o">=</span> <span class="n">font_annot_sec</span><span class="p">,</span>
                          <span class="n">FONT_LABEL</span>              <span class="o">=</span> <span class="n">font_lab</span><span class="p">,</span>
                          <span class="n">MAP_GRID_PEN_PRIMARY</span>    <span class="o">=</span> <span class="n">grid_pen_pri</span><span class="p">,</span>
                          <span class="n">MAP_GRID_PEN_SECONDARY</span>  <span class="o">=</span> <span class="n">grid_pen_sec</span><span class="p">,</span>
                          <span class="n">FORMAT_GEO_MAP</span>          <span class="o">=</span> <span class="n">fmt_geo_map</span><span class="p">,</span>
                          <span class="n">FORMAT_DATE_MAP</span>         <span class="o">=</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span>
                          <span class="n">FORMAT_TIME_PRIMARY_MAP</span> <span class="o">=</span> <span class="s2">&quot;Abbreviated&quot;</span><span class="p">):</span>
            <span class="c1"># ---- time-series top panel ----</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">basemap</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">plot_region</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">plot_projection</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s2">&quot;frame&quot;</span><span class="p">:</span> <span class="n">frame</span><span class="p">})</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">da</span> <span class="ow">in</span> <span class="n">ts_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;pygmt_FIA_dict&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pygmt_FIA_dict</span><span class="p">:</span>
                    <span class="n">leg_lab</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pygmt_FIA_dict</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
                    <span class="n">line_pen</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pygmt_FIA_dict</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;line_pen&quot;</span><span class="p">]</span>
                    <span class="n">line_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pygmt_FIA_dict</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;line_color&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">leg_lab</span><span class="p">,</span> <span class="n">line_pen</span><span class="p">,</span> <span class="n">line_color</span> <span class="o">=</span> <span class="n">k</span><span class="p">,</span> <span class="s2">&quot;1.5p&quot;</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span>
                <span class="n">clim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_doy_climatology</span><span class="p">(</span><span class="n">da</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span>            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">clim</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">clim</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]),</span>
                         <span class="n">y</span>            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">clim</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">clim</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]),</span>
                         <span class="n">fill</span>         <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">line_color</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">min_max_trans_val</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="n">close</span>        <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                         <span class="n">transparency</span> <span class="o">=</span> <span class="n">min_max_trans_val</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span>     <span class="o">=</span> <span class="n">clim</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                         <span class="n">y</span>     <span class="o">=</span> <span class="n">clim</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                         <span class="n">pen</span>   <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">line_pen</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">line_color</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="n">label</span> <span class="o">=</span> <span class="n">leg_lab</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="n">leg_pos</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="n">leg_box</span><span class="p">)</span>
            <span class="c1"># ---- bottom panel(s) ----</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">shift_origin</span><span class="p">(</span><span class="n">yshift</span><span class="o">=</span><span class="n">yshift_top</span><span class="p">)</span>
            <span class="n">pygmt</span><span class="o">.</span><span class="n">makecpt</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">reg_name</span><span class="p">,</span> <span class="n">reg_vals</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ant_2sectors</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">b_region</span>     <span class="o">=</span> <span class="n">reg_vals</span><span class="p">[</span><span class="s2">&quot;plot_region&quot;</span><span class="p">]</span>
                <span class="n">b_projection</span> <span class="o">=</span> <span class="n">reg_vals</span><span class="p">[</span><span class="s2">&quot;projection&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fig_width</span><span class="o">=</span><span class="n">fig_width</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">shift_origin</span><span class="p">(</span><span class="n">yshift</span><span class="o">=</span><span class="n">yshift_bot</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">basemap</span><span class="p">(</span><span class="n">region</span>     <span class="o">=</span> <span class="n">b_region</span><span class="p">,</span>
                            <span class="n">projection</span> <span class="o">=</span> <span class="n">b_projection</span><span class="p">,</span>
                            <span class="n">frame</span>      <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x</span><span class="si">{</span><span class="n">bottom_xaxis</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;y</span><span class="si">{</span><span class="n">bottom_yaxis</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">coast</span><span class="p">(</span><span class="n">water</span><span class="o">=</span><span class="n">water_clr</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span>     <span class="o">=</span> <span class="n">df_spat</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">],</span>
                         <span class="n">y</span>     <span class="o">=</span> <span class="n">df_spat</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span>
                         <span class="n">fill</span>  <span class="o">=</span> <span class="n">df_spat</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">],</span>
                         <span class="n">style</span> <span class="o">=</span> <span class="n">spat_var_style</span><span class="p">,</span>
                         <span class="n">cmap</span>  <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">plot_GI</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span>     <span class="o">=</span> <span class="n">plot_GI_dict</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">],</span>
                             <span class="n">y</span>     <span class="o">=</span> <span class="n">plot_GI_dict</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span>
                             <span class="n">fill</span>  <span class="o">=</span> <span class="n">GI_fill_color</span><span class="p">,</span>
                             <span class="n">style</span> <span class="o">=</span> <span class="n">GI_plot_style</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">coast</span><span class="p">(</span><span class="n">land</span><span class="o">=</span><span class="n">land_clr</span><span class="p">,</span> <span class="n">shorelines</span><span class="o">=</span><span class="n">coast_pen</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ANT_IS</span><span class="p">,</span> <span class="n">pen</span><span class="o">=</span><span class="n">ANT_IS_pen</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">ANT_IS_color</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="n">cbar_pos</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">cbar_frame</span><span class="p">)</span>
        <span class="c1"># Save / Show</span>
        <span class="k">if</span> <span class="n">save_fig</span><span class="p">:</span>
            <span class="n">F_png</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;top_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;bottom_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sim_name</span><span class="si">}</span><span class="s2">_ispd_thresh</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ispd_thresh_str</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">tmin</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">tmax</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="n">P_png</span> <span class="o">=</span> <span class="n">P_png</span> <span class="k">if</span> <span class="n">P_png</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D_graph</span><span class="p">,</span> <span class="n">sim_name</span><span class="p">,</span> <span class="n">F_png</span><span class="p">)</span>
            <span class="n">P_png</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">P_png</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="n">ow_fig</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">P_png</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;saved figure to </span><span class="si">{</span><span class="n">P_png</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">P_png</span><span class="si">}</span><span class="s2"> already exists and not overwriting&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_fig</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="SeaIcePlotter.pygmt_FIP_figure">
<a class="viewcode-back" href="../sea_ice_plotter.html#sea_ice_plotter.SeaIcePlotter.pygmt_FIP_figure">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pygmt_FIP_figure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                         <span class="n">plot_data</span>     <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>                <span class="c1"># xr.DataArray (single or precomputed diff/diff_cat)</span>
                         <span class="o">*</span><span class="p">,</span>
                         <span class="n">obs</span>           <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>                <span class="c1"># For &quot;diff&quot; mode (continuous + alpha): supply obs+mod instead of plot_data</span>
                         <span class="n">mod</span>           <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">show_fig</span>      <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="n">P_png</span>         <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">region</span>        <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">62</span><span class="p">),</span>
                         <span class="n">projection</span>    <span class="o">=</span> <span class="s2">&quot;S0.0/-90.0/50/20c&quot;</span><span class="p">,</span>
                         <span class="c1"># Base map</span>
                         <span class="n">basemap_frame</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;af&quot;</span><span class="p">,),</span>
                         <span class="n">land_color</span>    <span class="o">=</span> <span class="s2">&quot;#666666&quot;</span><span class="p">,</span>
                         <span class="n">water_color</span>   <span class="o">=</span> <span class="s2">&quot;#BABCDE&quot;</span><span class="p">,</span>
                         <span class="n">shoreline_pen</span> <span class="o">=</span> <span class="s2">&quot;1/0.25p&quot;</span><span class="p">,</span>
                         <span class="c1"># Symbols</span>
                         <span class="n">G_pt_marker</span>   <span class="o">=</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span>
                         <span class="n">G_pt_size</span>     <span class="o">=</span> <span class="s2">&quot;0.05&quot;</span><span class="p">,</span>
                         <span class="n">G_pt_unit</span>     <span class="o">=</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span>
                         <span class="c1"># CPT selection:</span>
                         <span class="n">mode</span>          <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>                <span class="c1"># &quot;auto&quot; | &quot;single&quot; | &quot;diff&quot;</span>
                         <span class="n">color_mode</span>    <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>          <span class="c1"># &quot;auto&quot; | &quot;continuous&quot; | &quot;categorical&quot;</span>
                         <span class="n">cmap</span>          <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>                  <span class="c1"># path to CPT for single-source continuous, else None -&gt; self.pygmt_dict[&quot;FIP_CPT&quot;]</span>
                         <span class="n">series</span>        <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                         <span class="c1"># Continuous diff tri-color:</span>
                         <span class="n">tricolor</span>        <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                         <span class="n">P_tricolor_cpt</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">tricolor_kwargs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>       <span class="c1"># dict forwarded to tricolor_cpt_and_alpha</span>
                         <span class="c1"># Categorical diff:</span>
                         <span class="n">P_cat_cpt</span>       <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">cat_labels</span>      <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Agreement&quot;</span><span class="p">,</span> <span class="s2">&quot;Model-dominant&quot;</span><span class="p">,</span> <span class="s2">&quot;Obs.-dominant&quot;</span><span class="p">),</span>
                         <span class="n">cat_colors</span>      <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;#FDAE61&quot;</span><span class="p">,</span> <span class="s2">&quot;#2CA25F&quot;</span><span class="p">,</span> <span class="s2">&quot;#2171B5&quot;</span><span class="p">),</span>   <span class="c1"># (0,1,2) colors</span>
                         <span class="c1"># Colorbar:</span>
                         <span class="n">cbar_pos</span>        <span class="o">=</span> <span class="s2">&quot;JBC+w15c/1c+mc+h&quot;</span><span class="p">,</span>
                         <span class="n">cbar_frame</span>      <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;xa0.2f0.05+lFast Ice Persistence&quot;</span><span class="p">,),</span>
                         <span class="n">cat_cbar_frame</span>  <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;+lFIP difference category&quot;</span><span class="p">,),</span>
                         <span class="c1"># Transparency options:</span>
                         <span class="n">transparency</span>        <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>          <span class="c1"># scalar percent or 1D array percent (already masked)</span>
                         <span class="n">weight_da</span>           <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>             <span class="c1"># xr.DataArray in [0,1] used to derive transparency if set</span>
                         <span class="n">transparency_from</span>   <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>   <span class="c1"># &quot;auto&quot; | &quot;none&quot; | &quot;weight&quot; | &quot;alpha&quot;</span>
                         <span class="n">n_transparency_bins</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>      <span class="c1"># number of passes (bins) if using array transparency</span>
                         <span class="c1"># GI overlay:</span>
                         <span class="n">plot_GI</span>             <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="n">GI_color</span>            <span class="o">=</span> <span class="s2">&quot;#E349D0&quot;</span><span class="p">,</span>
                         <span class="n">GI_marker</span>           <span class="o">=</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span>
                         <span class="n">GI_size</span>             <span class="o">=</span> <span class="s2">&quot;0.01&quot;</span><span class="p">,</span>
                         <span class="n">GI_pt_unit</span>          <span class="o">=</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span>
                         <span class="n">plot_bathymetry</span>     <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A single entry point for:</span>
<span class="sd">        - single-source FIP (continuous)</span>
<span class="sd">        - diff continuous (tri-color + alpha)</span>
<span class="sd">        - diff categorical (0/1/2)</span>

<span class="sd">        Notes:</span>
<span class="sd">        - Uses binned transparency for robustness (multiple fig.plot calls).</span>
<span class="sd">        - If obs/mod provided and tricolor=True: computes z,t internally.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">plot_GI</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_cice_grid</span><span class="p">(</span><span class="n">slice_hem</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_bathymetry</span><span class="p">:</span>
            <span class="n">SO_BATH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_IBCSO_bath</span><span class="p">()</span>
        <span class="c1"># ---- decide mode / color_mode ----</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;diff&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;single&quot;</span>
        <span class="k">if</span> <span class="n">color_mode</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;diff&quot;</span><span class="p">:</span>
                <span class="c1"># if user gave diff_cat, treat as categorical</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plot_data</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;diff_cat&quot;</span> <span class="ow">in</span> <span class="p">(</span><span class="n">plot_data</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                    <span class="n">color_mode</span> <span class="o">=</span> <span class="s2">&quot;categorical&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">color_mode</span> <span class="o">=</span> <span class="s2">&quot;continuous&quot;</span> <span class="k">if</span> <span class="n">tricolor</span> <span class="k">else</span> <span class="s2">&quot;continuous&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color_mode</span> <span class="o">=</span> <span class="s2">&quot;continuous&quot;</span>
        <span class="c1"># ---- build x,y,z,t (transparency) ----</span>
        <span class="n">t</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;diff&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">color_mode</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
            <span class="c1"># compute tri-color z and alpha-derived transparency</span>
            <span class="n">obs2</span><span class="p">,</span> <span class="n">mod2</span>         <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s2">&quot;exact&quot;</span><span class="p">)</span>
            <span class="n">P_tricolor_cpt</span>     <span class="o">=</span> <span class="n">P_tricolor_cpt</span> <span class="ow">or</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D_graph</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;_cpt&quot;</span> <span class="o">/</span> <span class="s2">&quot;FIP_tricolor.cpt&quot;</span><span class="p">)</span>
            <span class="n">tricolor_kwargs</span>    <span class="o">=</span> <span class="n">tricolor_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">cpt_path</span><span class="p">,</span> <span class="n">z2d</span><span class="p">,</span> <span class="n">t2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tricolor_cpt_and_alpha</span><span class="p">(</span><span class="n">P_tricolor_cpt</span><span class="p">,</span> <span class="n">obs2</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">mod2</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="o">**</span><span class="n">tricolor_kwargs</span><span class="p">)</span>
            <span class="c1"># put z into a DataArray to reuse prep/masking</span>
            <span class="n">z_da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">z2d</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">obs2</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">obs2</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;FIP_diff&quot;</span><span class="p">)</span>
            <span class="n">prep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pygmt_da_prep</span><span class="p">(</span><span class="n">z_da</span><span class="p">,</span>
                                      <span class="n">lon_coord_name</span><span class="o">=</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span>
                                      <span class="n">lat_coord_name</span><span class="o">=</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span>
                                      <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
                                      <span class="n">mask_zero</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">return_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                      <span class="n">return_flat_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">mask2d</span> <span class="o">=</span> <span class="n">prep</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">prep</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">prep</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="n">prep</span><span class="p">[</span><span class="s1">&#39;mask2d&#39;</span><span class="p">]</span>
            <span class="n">t</span>               <span class="o">=</span> <span class="n">t2d</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">prep</span><span class="p">[</span><span class="s2">&quot;flat_idx&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">cmap_use</span>        <span class="o">=</span> <span class="n">cpt_path</span>
            <span class="c1"># transparency precedence:</span>
            <span class="k">if</span> <span class="n">transparency_from</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">):</span>
                <span class="k">pass</span>  <span class="c1"># keep t from alpha</span>
            <span class="k">elif</span> <span class="n">transparency_from</span> <span class="o">==</span> <span class="s2">&quot;weight&quot;</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># will be replaced below from weight_da</span>
            <span class="k">elif</span> <span class="n">transparency_from</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># single-source OR categorical OR precomputed diff</span>
            <span class="k">if</span> <span class="n">plot_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;plot_data must be provided unless using obs+mod continuous diff mode.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plot_data</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;For this refactor, pass an xarray.DataArray for plot_data.&quot;</span><span class="p">)</span>
            <span class="n">prep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pygmt_da_prep</span><span class="p">(</span><span class="n">plot_data</span><span class="p">,</span>
                                      <span class="n">lon_coord_name</span><span class="o">=</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span>
                                      <span class="n">lat_coord_name</span><span class="o">=</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span>
                                      <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
                                      <span class="n">mask_zero</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">return_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                      <span class="n">return_flat_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">mask2d</span> <span class="o">=</span> <span class="n">prep</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">prep</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">prep</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="n">prep</span><span class="p">[</span><span class="s1">&#39;mask2d&#39;</span><span class="p">]</span>
            <span class="c1"># choose cmap</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;single&quot;</span><span class="p">:</span>
                <span class="n">cmap_use</span> <span class="o">=</span> <span class="n">cmap</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">pygmt_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FIP_CPT&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">series</span>   <span class="o">=</span> <span class="n">series</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_var_dict</span><span class="p">[</span><span class="s1">&#39;FIP&#39;</span><span class="p">][</span><span class="s1">&#39;series&#39;</span><span class="p">]</span>
                <span class="n">P_out</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D_graph</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;CPTs&quot;</span> <span class="o">/</span> <span class="s2">&quot;FIP_pygmt_AF2020.cpt&quot;</span>
                <span class="n">pygmt</span><span class="o">.</span><span class="n">makecpt</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap_use</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">P_out</span><span class="p">))</span>
                <span class="n">cmap_use</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">P_out</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cmap_use</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No CPT found: set cmap=... or define self.pygmt_dict[&#39;FIP_CPT&#39;].&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># diff mode but not obs/mod continuous:</span>
                <span class="k">if</span> <span class="n">color_mode</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
                    <span class="n">cmap_use</span> <span class="o">=</span> <span class="n">cmap</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">pygmt_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FIP_DIFF_CPT&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cmap_use</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tricolor</span><span class="p">:</span>
                        <span class="n">P_master</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D_graph</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;CPTs&quot;</span> <span class="o">/</span> <span class="s2">&quot;FIP_tricolor_master.cpt&quot;</span>
                        <span class="n">master</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_tricolour_cpt</span><span class="p">(</span><span class="n">P_master</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">vmid</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
                        <span class="n">P_out</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D_graph</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;CPTs&quot;</span> <span class="o">/</span> <span class="s2">&quot;FIP_tricolor_0p01.cpt&quot;</span>
                        <span class="n">pygmt</span><span class="o">.</span><span class="n">makecpt</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">master</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">],</span> <span class="n">output</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">P_out</span><span class="p">))</span>
                        <span class="n">cmap_use</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">P_out</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># categorical: build categorical CPT file (0..3 bins) so codes 0/1/2 map cleanly</span>
                    <span class="n">P_cat_cpt</span> <span class="o">=</span> <span class="n">P_cat_cpt</span> <span class="ow">or</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D_graph</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;CPTs&quot;</span> <span class="o">/</span> <span class="s2">&quot;FIP_diff_cat.cpt&quot;</span><span class="p">)</span>
                    <span class="n">P_cat_cpt</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">P_cat_cpt</span><span class="p">)</span>
                    <span class="n">P_cat_cpt</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="c1"># Use makecpt so labels are embedded (+c...) and CPT is categorical. :contentReference[oaicite:1]{index=1}</span>
                    <span class="n">pygmt</span><span class="o">.</span><span class="n">makecpt</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cat_colors</span><span class="p">),</span>
                                  <span class="n">series</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                  <span class="n">categorical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">color_model</span><span class="o">=</span><span class="s2">&quot;R+c&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cat_labels</span><span class="p">),</span>
                                  <span class="n">output</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">P_cat_cpt</span><span class="p">))</span>
                    <span class="n">cmap_use</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">P_cat_cpt</span><span class="p">)</span>
        <span class="c1"># derive transparency from weight if requested</span>
        <span class="k">if</span> <span class="n">transparency_from</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">weight_da</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">w2</span> <span class="o">=</span> <span class="n">weight_da</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
            <span class="c1"># apply same 2D mask used above</span>
            <span class="k">if</span> <span class="s2">&quot;mask2d&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Internal: mask2d not defined for weight mapping.&quot;</span><span class="p">)</span>
            <span class="n">wv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">w2</span><span class="p">[</span><span class="n">mask2d</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">wv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">wv</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">t</span>  <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">wv</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span>
        <span class="c1"># if caller provided transparency explicitly, override</span>
        <span class="k">if</span> <span class="n">transparency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">transparency</span>
        <span class="c1"># ---- plotting ----</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">pygmt</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">pygmt</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">FONT_TITLE</span>           <span class="o">=</span> <span class="s2">&quot;22p,Bookman-Demi&quot;</span><span class="p">,</span>
                          <span class="n">FONT_ANNOT_PRIMARY</span>   <span class="o">=</span> <span class="s2">&quot;16p,NewCenturySchlbk-Roman&quot;</span><span class="p">,</span>
                          <span class="n">FONT_ANNOT_SECONDARY</span> <span class="o">=</span> <span class="s2">&quot;16p,NewCenturySchlbk-Bold&quot;</span><span class="p">,</span>
                          <span class="n">FONT_LABEL</span>           <span class="o">=</span> <span class="s2">&quot;16p,NewCenturySchlbk-Bold&quot;</span><span class="p">,</span>
                          <span class="n">COLOR_FOREGROUND</span>     <span class="o">=</span> <span class="s2">&quot;black&quot;</span><span class="p">):</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">basemap</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">basemap_frame</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">plot_bathymetry</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">grdimage</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">SO_BATH</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;geo&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">coast</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span> <span class="n">land</span><span class="o">=</span><span class="n">land_color</span><span class="p">,</span> <span class="n">water</span><span class="o">=</span><span class="n">water_color</span><span class="p">)</span>
            <span class="c1"># draw points, optionally with binned transparency</span>
            <span class="n">style</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">G_pt_marker</span><span class="si">}{</span><span class="n">G_pt_size</span><span class="si">}{</span><span class="n">G_pt_unit</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_use</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># robust: bin transparency to N levels (scalar -t each pass)</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="n">xg</span><span class="p">,</span> <span class="n">yg</span><span class="p">,</span> <span class="n">zg</span><span class="p">,</span> <span class="n">tg</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">good</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">good</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">good</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">good</span><span class="p">]</span>
                <span class="c1"># drop fully transparent</span>
                <span class="n">keep</span> <span class="o">=</span> <span class="n">tg</span> <span class="o">&lt;</span> <span class="mf">100.0</span>
                <span class="n">xg</span><span class="p">,</span> <span class="n">yg</span><span class="p">,</span> <span class="n">zg</span><span class="p">,</span> <span class="n">tg</span> <span class="o">=</span> <span class="n">xg</span><span class="p">[</span><span class="n">keep</span><span class="p">],</span> <span class="n">yg</span><span class="p">[</span><span class="n">keep</span><span class="p">],</span> <span class="n">zg</span><span class="p">[</span><span class="n">keep</span><span class="p">],</span> <span class="n">tg</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
                <span class="c1"># bins in transparency space (0..100)</span>
                <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_transparency_bins</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">bin_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">tg</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">bin_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">bin_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">sel</span> <span class="o">=</span> <span class="n">bin_idx</span> <span class="o">==</span> <span class="n">b</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">sel</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">tau</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">+</span> <span class="n">edges</span><span class="p">[</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>  <span class="c1"># representative scalar transparency</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xg</span><span class="p">[</span><span class="n">sel</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">yg</span><span class="p">[</span><span class="n">sel</span><span class="p">],</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">zg</span><span class="p">[</span><span class="n">sel</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_use</span><span class="p">,</span> <span class="n">transparency</span><span class="o">=</span><span class="n">tau</span><span class="p">)</span>
            <span class="c1"># colorbar</span>
            <span class="k">if</span> <span class="n">color_mode</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="n">cbar_pos</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">cat_cbar_frame</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_use</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="n">cbar_pos</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">cbar_frame</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_use</span><span class="p">)</span>
            <span class="c1"># GI overlay</span>
            <span class="k">if</span> <span class="n">plot_GI</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">G_GI</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                         <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">G_GI</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                         <span class="n">fill</span><span class="o">=</span><span class="n">GI_color</span><span class="p">,</span>
                         <span class="n">style</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GI_marker</span><span class="si">}{</span><span class="n">GI_size</span><span class="si">}{</span><span class="n">GI_pt_unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">coast</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span> <span class="n">shorelines</span><span class="o">=</span><span class="n">shoreline_pen</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">P_png</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">P_png</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_fig</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_smooth_df_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Smooth a time series in df with columns [&#39;time&#39;,&#39;data&#39;].</span>
<span class="sd">        &#39;window&#39; can be an int (# of samples) or a time offset string like &#39;15D&#39;.</span>
<span class="sd">        Returns a new df with smoothed &#39;data&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">window</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
        <span class="c1"># Pandas rolling supports both integer and time-based windows on a DatetimeIndex</span>
        <span class="n">s_sm</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="n">min_periods</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_sm</span><span class="o">.</span><span class="n">values</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_repeat_doy_over_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_time_data</span><span class="p">,</span> <span class="n">full_range</span><span class="p">,</span> <span class="n">time_coord</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">):</span>
        <span class="n">src</span>         <span class="o">=</span> <span class="n">df_time_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">src</span><span class="p">[</span><span class="s2">&quot;doy&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="n">time_coord</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofyear</span>
        <span class="n">clim_lookup</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;doy&quot;</span><span class="p">)[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># index = 1..365 or 366</span>
        <span class="n">rep</span>         <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">full_range</span><span class="p">})</span>
        <span class="n">rep</span><span class="p">[</span><span class="s2">&quot;doy&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">rep</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofyear</span>
        <span class="c1"># handle leap day: if 366 not in lookup, remap DOY=366 -&gt; 365</span>
        <span class="k">if</span> <span class="mi">366</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clim_lookup</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">rep</span><span class="p">[</span><span class="s2">&quot;doy_eff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rep</span><span class="p">[</span><span class="s2">&quot;doy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rep</span><span class="p">[</span><span class="s2">&quot;doy&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">366</span><span class="p">,</span> <span class="mi">365</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rep</span><span class="p">[</span><span class="s2">&quot;doy_eff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rep</span><span class="p">[</span><span class="s2">&quot;doy&quot;</span><span class="p">]</span>
        <span class="n">rep</span><span class="p">[</span><span class="s2">&quot;rep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rep</span><span class="p">[</span><span class="s2">&quot;doy_eff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">clim_lookup</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rep</span><span class="p">[[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;rep&quot;</span><span class="p">]]</span>

<div class="viewcode-block" id="SeaIcePlotter.pygmt_timeseries">
<a class="viewcode-back" href="../sea_ice_plotter.html#sea_ice_plotter.SeaIcePlotter.pygmt_timeseries">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pygmt_timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts_dict</span><span class="p">,</span>
                        <span class="n">comp_name</span>        <span class="p">:</span> <span class="nb">str</span>              <span class="o">=</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span>
                        <span class="n">primary_key</span>      <span class="p">:</span> <span class="nb">str</span>              <span class="o">=</span> <span class="s2">&quot;FIA&quot;</span><span class="p">,</span>  <span class="c1"># &quot;FIA&quot;</span>
                        <span class="n">smooth</span>           <span class="p">:</span> <span class="nb">str</span><span class="o">|</span><span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>   <span class="c1"># e.g., 15, &quot;15D&quot;</span>
                        <span class="n">clim_smooth</span>      <span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span>       <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>   <span class="c1"># 15</span>
                        <span class="n">climatology</span>      <span class="p">:</span> <span class="nb">bool</span>             <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">ylabel</span>           <span class="p">:</span> <span class="nb">str</span>              <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>   <span class="c1"># &quot;@[Fast Ice Area (1\\times10^3 km^2)@[&quot;,</span>
                        <span class="n">ylim</span>             <span class="p">:</span> <span class="nb">tuple</span>            <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000</span><span class="p">],</span>
                        <span class="n">yaxis_pri</span>        <span class="p">:</span> <span class="nb">int</span>              <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">ytick_pri</span>        <span class="p">:</span> <span class="nb">int</span>              <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                        <span class="n">ytick_sec</span>        <span class="p">:</span> <span class="nb">int</span>              <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                        <span class="n">projection</span>       <span class="p">:</span> <span class="nb">str</span>              <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">fig_width</span>        <span class="p">:</span> <span class="nb">str</span>              <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">fig_height</span>       <span class="p">:</span> <span class="nb">str</span>              <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">xaxis_pri</span>        <span class="p">:</span> <span class="nb">str</span>              <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">xaxis_sec</span>        <span class="p">:</span> <span class="nb">str</span>              <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">frame_bndy</span>       <span class="p">:</span> <span class="nb">str</span>              <span class="o">=</span> <span class="s2">&quot;WS&quot;</span><span class="p">,</span>
                        <span class="n">legend_pos</span>       <span class="p">:</span> <span class="nb">str</span>              <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">legend_box</span>       <span class="p">:</span> <span class="nb">str</span>              <span class="o">=</span> <span class="s2">&quot;+gwhite+p0.5p&quot;</span><span class="p">,</span>
                        <span class="n">fmt_dt_pri</span>       <span class="p">:</span> <span class="nb">str</span>              <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">fmt_dt_sec</span>       <span class="p">:</span> <span class="nb">str</span>              <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">fmt_dt_map</span>       <span class="p">:</span> <span class="nb">str</span>              <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">fnt_type</span>         <span class="p">:</span> <span class="nb">str</span>              <span class="o">=</span> <span class="s2">&quot;Helvetica&quot;</span><span class="p">,</span>
                        <span class="n">fnt_wght_lab</span>     <span class="p">:</span> <span class="nb">str</span>              <span class="o">=</span> <span class="s2">&quot;20p&quot;</span><span class="p">,</span>
                        <span class="n">fnt_wght_ax</span>      <span class="p">:</span> <span class="nb">str</span>              <span class="o">=</span> <span class="s2">&quot;18p&quot;</span><span class="p">,</span>
                        <span class="n">line_pen</span>         <span class="p">:</span> <span class="nb">str</span>              <span class="o">=</span> <span class="s2">&quot;1p&quot;</span><span class="p">,</span>
                        <span class="n">grid_wght_pri</span>    <span class="p">:</span> <span class="nb">str</span>              <span class="o">=</span> <span class="s2">&quot;.25p&quot;</span><span class="p">,</span>
                        <span class="n">grid_wght_sec</span>    <span class="p">:</span> <span class="nb">str</span>              <span class="o">=</span> <span class="s2">&quot;.1p&quot;</span><span class="p">,</span>
                        <span class="n">P_png</span>            <span class="p">:</span> <span class="nb">str</span>              <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">time_coord</span>       <span class="p">:</span> <span class="nb">str</span>              <span class="o">=</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span>
                        <span class="n">time_coord_alt</span>   <span class="p">:</span> <span class="nb">str</span>              <span class="o">=</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span>
                        <span class="n">keys2plot</span>        <span class="p">:</span> <span class="nb">list</span>             <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">repeat_keys</span>      <span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">repeat_policy</span>    <span class="p">:</span> <span class="nb">str</span>              <span class="o">=</span> <span class="s2">&quot;inside_others&quot;</span><span class="p">,</span> <span class="c1"># &quot;inside_others&quot; | &quot;outside_others&quot; | &quot;fill_gaps&quot; | &quot;always&quot;</span>
                        <span class="n">repeat_ref_keys</span>  <span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>            <span class="c1"># which keys define the &quot;others&quot; window; default: all except current</span>
                        <span class="n">clip_x_axis</span>      <span class="p">:</span> <span class="nb">bool</span>             <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">zero_line</span>        <span class="p">:</span> <span class="nb">bool</span>             <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">zero_line_level</span>  <span class="p">:</span> <span class="nb">float</span>            <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                        <span class="n">zero_line_pen</span>    <span class="p">:</span> <span class="nb">str</span>              <span class="o">=</span> <span class="s2">&quot;2p,black&quot;</span><span class="p">,</span>
                        <span class="n">save_fig</span>         <span class="p">:</span> <span class="nb">bool</span>             <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">show_fig</span>         <span class="p">:</span> <span class="nb">bool</span>             <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot time series of a primary variable (e.g., FIA) for a set of simulations or observations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ts_dict : dict</span>
<span class="sd">            Dictionary of xarray DataArrays keyed by simulation or dataset name.</span>
<span class="sd">        comp_name : str</span>
<span class="sd">            Name for the comparison (used in figure title and filename).</span>
<span class="sd">        primary_key : str</span>
<span class="sd">            Key used to extract the variable from each dataset (except &#39;AF2020&#39;).</span>
<span class="sd">        climatology : bool</span>
<span class="sd">            If True, plot daily climatology with fill and mean lines.</span>
<span class="sd">        ylim : tuple or None</span>
<span class="sd">            Y-axis limits. If None, inferred from data with 5% padding.</span>
<span class="sd">        ylabel : str</span>
<span class="sd">            Label for the Y-axis.</span>
<span class="sd">        ytick_inc : int</span>
<span class="sd">            Interval between Y-axis ticks.</span>
<span class="sd">        xaxis_pri, xaxis_sec : str</span>
<span class="sd">            GMT frame settings for primary and secondary axes (when climatology is False).</span>
<span class="sd">        P_png : str or None</span>
<span class="sd">            Optional full path to save figure. If None, default filename is constructed.</span>
<span class="sd">        legend_box : str</span>
<span class="sd">            GMT legend box styling.</span>
<span class="sd">        line_pen : str</span>
<span class="sd">            Line thickness for plotted time series.</span>
<span class="sd">        time_coord : str</span>
<span class="sd">            Name of time coordinate in each DataArray.</span>
<span class="sd">        keys2plot : list or None</span>
<span class="sd">            If provided, only datasets with keys in this list are plotted.</span>
<span class="sd">        show_fig : bool or None</span>
<span class="sd">            If True, show figure interactively. Defaults to self.show_fig.</span>
<span class="sd">        repeat_keys : list[str] or None</span>
<span class="sd">            Keys in `ts_dict` to plot as a repeated day-of-year climatology when</span>
<span class="sd">            `climatology=False`.</span>
<span class="sd">        repeat_policy : {&quot;outside_others&quot;,&quot;fill_gaps&quot;,&quot;always&quot;}</span>
<span class="sd">            - &quot;outside_others&quot;: keep original values where *other* series exist in time,</span>
<span class="sd">            but replace values outside that union with day-of-year climatology of</span>
<span class="sd">            the nominated series (good for fair comparison).</span>
<span class="sd">            - &quot;fill_gaps&quot;: use climatology only where the nominated series has no data,</span>
<span class="sd">            keep original where it does.</span>
<span class="sd">            - &quot;always&quot;: ignore original values and plot the repeated climatology across</span>
<span class="sd">            the full x-range.</span>
<span class="sd">        repeat_ref_keys : list[str] or None</span>
<span class="sd">            If provided, these keys define the &quot;others&quot; time span for the</span>
<span class="sd">            &quot;outside_others&quot; policy. By default, it&#39;s all plotted series except the</span>
<span class="sd">            current one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">show_fig</span>   <span class="o">=</span> <span class="n">show_fig</span>   <span class="k">if</span> <span class="n">show_fig</span>   <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_fig</span>
        <span class="n">save_fig</span>   <span class="o">=</span> <span class="n">save_fig</span>   <span class="k">if</span> <span class="n">save_fig</span>   <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_fig</span>
        <span class="n">fmt_dt_pri</span> <span class="o">=</span> <span class="n">fmt_dt_pri</span> <span class="k">if</span> <span class="n">fmt_dt_pri</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;Character&quot;</span>
        <span class="n">fmt_dt_sec</span> <span class="o">=</span> <span class="n">fmt_dt_sec</span> <span class="k">if</span> <span class="n">fmt_dt_sec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;Abbreviated&quot;</span>
        <span class="n">fmt_dt_map</span> <span class="o">=</span> <span class="n">fmt_dt_map</span> <span class="k">if</span> <span class="n">fmt_dt_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;o&quot;</span>
        <span class="c1"># primary_key = primary_key if primary_key is not None else keys2plot[0]</span>
        <span class="c1"># if keys2plot is None:</span>
        <span class="c1">#     raise(&quot;either &#39;primary_key&#39; or &#39;keys2plot&#39; must be defined&quot;)</span>
        <span class="c1"># need to get out the maximum times for plot boundaries</span>
        <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_min_max_dates</span><span class="p">(</span><span class="n">ts_dict</span><span class="p">,</span> <span class="n">keys2plot</span><span class="o">=</span><span class="n">keys2plot</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="n">primary_key</span><span class="p">,</span> <span class="n">time_coord</span><span class="o">=</span><span class="n">time_coord</span><span class="p">)</span>
        <span class="c1"># --- normalize new params ---</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">repeat_keys</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="n">repeat_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">repeat_keys</span><span class="p">]</span>
        <span class="n">repeat_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">repeat_keys</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">repeat_ref_keys</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="n">repeat_ref_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">repeat_ref_keys</span><span class="p">]</span>
        <span class="n">x_start</span><span class="p">,</span> <span class="n">x_end</span> <span class="o">=</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">climatology</span><span class="p">)</span> <span class="ow">and</span> <span class="n">clip_x_axis</span> <span class="ow">and</span> <span class="n">repeat_keys</span><span class="p">:</span>
            <span class="c1"># reference keys = all plotted except the repeated ones, unless user specified</span>
            <span class="k">if</span> <span class="n">repeat_ref_keys</span><span class="p">:</span>
                <span class="n">ref_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">repeat_ref_keys</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ref_keys</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ts_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="p">(</span><span class="n">keys2plot</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="n">keys2plot</span> <span class="ow">or</span> <span class="p">[]))</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">repeat_keys</span><span class="p">}</span>
            <span class="n">other_mins</span><span class="p">,</span> <span class="n">other_maxs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ref_keys</span><span class="p">:</span>
                <span class="n">da2</span> <span class="o">=</span> <span class="n">ts_dict</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">primary_key</span><span class="p">]</span>
                <span class="n">tt2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">da2</span><span class="p">[</span><span class="n">time_coord</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tt2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">other_mins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tt2</span><span class="o">.</span><span class="n">min</span><span class="p">());</span> <span class="n">other_maxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tt2</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">other_mins</span><span class="p">:</span>  <span class="c1"># only override if we actually have refs</span>
                <span class="n">x_start</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">other_mins</span><span class="p">))</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
                <span class="n">x_end</span>   <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">other_maxs</span><span class="p">))</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
        <span class="c1"># there are differences in the projection and x-axis for the two types of figures</span>
        <span class="k">if</span> <span class="n">climatology</span><span class="p">:</span>
            <span class="n">fake_year</span>  <span class="o">=</span> <span class="mi">1996</span>
            <span class="n">fig_width</span>  <span class="o">=</span> <span class="n">fig_width</span>  <span class="k">if</span> <span class="n">fig_width</span>  <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;20c&quot;</span>
            <span class="n">fig_height</span> <span class="o">=</span> <span class="n">fig_height</span> <span class="k">if</span> <span class="n">fig_height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;15c&quot;</span>
            <span class="n">xaxis_sec</span>  <span class="o">=</span> <span class="n">xaxis_sec</span>  <span class="k">if</span> <span class="n">xaxis_sec</span>  <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">xaxis_pri</span>  <span class="o">=</span> <span class="n">xaxis_pri</span>  <span class="k">if</span> <span class="n">xaxis_pri</span>  <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;a1Og&quot;</span>
            <span class="n">region</span>     <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fake_year</span><span class="si">}</span><span class="s2">-01-01&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fake_year</span><span class="si">}</span><span class="s2">-12-31&quot;</span><span class="p">,</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig_width</span>  <span class="o">=</span> <span class="n">fig_width</span>  <span class="k">if</span> <span class="n">fig_width</span>  <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;50c&quot;</span>
            <span class="n">fig_height</span> <span class="o">=</span> <span class="n">fig_height</span> <span class="k">if</span> <span class="n">fig_height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;15c&quot;</span>
            <span class="n">xaxis_pri</span>  <span class="o">=</span> <span class="n">xaxis_pri</span>  <span class="k">if</span> <span class="n">xaxis_pri</span>  <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;a2Of30D&quot;</span><span class="c1">#g30D&quot;</span>
            <span class="n">xaxis_sec</span>  <span class="o">=</span> <span class="n">xaxis_sec</span>  <span class="k">if</span> <span class="n">xaxis_sec</span>  <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;a1Y&quot;</span>
            <span class="n">region</span>     <span class="o">=</span> <span class="p">[</span><span class="n">x_start</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">x_end</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="c1"># define the projection and frame of the figure</span>
        <span class="n">legend_pos</span> <span class="o">=</span> <span class="n">legend_pos</span> <span class="k">if</span> <span class="n">legend_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;JTL+jTL+o0.2c+w</span><span class="si">{</span><span class="n">fig_width</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;X</span><span class="si">{</span><span class="n">fig_width</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">fig_height</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">yaxis_pri</span>  <span class="o">=</span> <span class="n">yaxis_pri</span> <span class="k">if</span> <span class="n">yaxis_pri</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;a</span><span class="si">{</span><span class="n">ytick_pri</span><span class="si">}</span><span class="s2">f</span><span class="si">{</span><span class="n">ytick_sec</span><span class="si">}</span><span class="s2">+l</span><span class="si">{</span><span class="n">ylabel</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">xaxis_sec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="p">[</span><span class="n">frame_bndy</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sx</span><span class="si">{</span><span class="n">xaxis_sec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;px</span><span class="si">{</span><span class="n">xaxis_pri</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;py</span><span class="si">{</span><span class="n">yaxis_pri</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="p">[</span><span class="n">frame_bndy</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;px</span><span class="si">{</span><span class="n">xaxis_pri</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;py</span><span class="si">{</span><span class="n">yaxis_pri</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="c1"># make sure the figure has the same configuration by wrapping it in a with condition</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">pygmt</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">pygmt</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">FONT_LABEL</span>                <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fnt_wght_lab</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">fnt_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                          <span class="n">FONT</span>                      <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fnt_wght_ax</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">fnt_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                          <span class="n">MAP_GRID_PEN_PRIMARY</span>      <span class="o">=</span> <span class="n">grid_wght_pri</span><span class="p">,</span>
                          <span class="n">MAP_GRID_PEN_SECONDARY</span>    <span class="o">=</span> <span class="n">grid_wght_sec</span><span class="p">,</span>
                          <span class="n">FORMAT_TIME_PRIMARY_MAP</span>   <span class="o">=</span> <span class="n">fmt_dt_pri</span><span class="p">,</span>
                          <span class="n">FORMAT_TIME_SECONDARY_MAP</span> <span class="o">=</span> <span class="n">fmt_dt_sec</span><span class="p">,</span>
                          <span class="n">FORMAT_DATE_MAP</span>           <span class="o">=</span> <span class="n">fmt_dt_map</span><span class="p">):</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">basemap</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">frame</span><span class="p">)</span>
            <span class="c1"># loop over each key in the dictionary and if keys2plot is defined only plot those dictionaries</span>
            <span class="n">cnt</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">dict_key</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ts_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extracting data array from ts_dict[</span><span class="si">{</span><span class="n">dict_key</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">primary_key</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
                <span class="n">da</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">primary_key</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;matching </span><span class="si">{</span><span class="n">dict_key</span><span class="si">}</span><span class="s2"> with JSON-toolbox-config dictionary for line color and legend label&quot;</span><span class="p">)</span>
                <span class="c1"># removed option to pass &#39;line_clr&#39; and &#39;leg_lab&#39; with ts_dict</span>
                <span class="n">line_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_var_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dict_key</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;line_clr&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">leg_lab</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_var_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dict_key</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;leg_lab&quot;</span><span class="p">,</span> <span class="n">dict_key</span> <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   legend label: </span><span class="si">{</span><span class="n">leg_lab</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   line color  : </span><span class="si">{</span><span class="n">line_color</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dict_key</span><span class="o">==</span><span class="s2">&quot;AF2020&quot;</span> <span class="ow">and</span> <span class="n">primary_key</span><span class="o">==</span><span class="s2">&quot;FIA&quot;</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="n">time_coord_alt</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">da</span><span class="o">.</span><span class="n">values</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="n">time_coord</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">da</span><span class="o">.</span><span class="n">values</span><span class="p">})</span>
                <span class="k">if</span> <span class="n">climatology</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dict_key</span><span class="o">==</span><span class="s2">&quot;AF2020&quot;</span> <span class="ow">and</span> <span class="n">primary_key</span><span class="o">==</span><span class="s2">&quot;FIA&quot;</span><span class="p">:</span>
                        <span class="n">clim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_doy_climatology</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">time_coord</span><span class="o">=</span><span class="n">time_coord_alt</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">clim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_doy_climatology</span><span class="p">(</span><span class="n">da</span><span class="p">)</span>
                    <span class="n">mean_x</span> <span class="o">=</span> <span class="n">clim</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
                    <span class="n">mean_y</span> <span class="o">=</span> <span class="n">clim</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="k">if</span> <span class="n">clim_smooth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">clim_smooth</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">mean_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">mean_y</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">mean_x</span><span class="p">)</span>
                                    <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">clim_smooth</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                                    <span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span>            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">clim</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">clim</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]),</span>
                             <span class="n">y</span>            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">clim</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">clim</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]),</span>
                             <span class="n">fill</span>         <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">line_color</span><span class="si">}</span><span class="s2">@80&quot;</span><span class="p">,</span>
                             <span class="n">close</span>        <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="n">transparency</span> <span class="o">=</span> <span class="mi">80</span><span class="p">)</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span>     <span class="o">=</span> <span class="n">mean_x</span><span class="p">,</span>
                             <span class="n">y</span>     <span class="o">=</span> <span class="n">mean_y</span><span class="p">,</span>
                             <span class="n">pen</span>   <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">line_pen</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">line_color</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                             <span class="n">label</span> <span class="o">=</span> <span class="n">leg_lab</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>       
                    <span class="k">if</span> <span class="n">dict_key</span> <span class="ow">in</span> <span class="n">repeat_keys</span><span class="p">:</span>
                        <span class="c1"># target x-range (union for figure)</span>
                        <span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span> <span class="o">=</span> <span class="n">tmin</span><span class="o">.</span><span class="n">normalize</span><span class="p">(),</span> <span class="n">tmax</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
                        <span class="n">full_range</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>
                        <span class="c1"># repeated climatology over the full range</span>
                        <span class="n">rep_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeat_doy_over_range</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">full_range</span><span class="p">)</span>  <span class="c1"># cols: time, rep</span>
                        <span class="c1"># original reindexed over full range</span>
                        <span class="n">base</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">full_range</span><span class="p">})</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;orig&quot;</span><span class="p">}),</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
                        <span class="n">mix</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">rep_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">repeat_policy</span> <span class="o">==</span> <span class="s2">&quot;always&quot;</span><span class="p">:</span>
                            <span class="n">out_df</span> <span class="o">=</span> <span class="n">mix</span><span class="p">[[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;rep&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rep&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">})</span>
                        <span class="k">elif</span> <span class="n">repeat_policy</span> <span class="o">==</span> <span class="s2">&quot;fill_gaps&quot;</span><span class="p">:</span>
                            <span class="n">mix</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="p">[</span><span class="s2">&quot;orig&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mix</span><span class="p">[</span><span class="s2">&quot;rep&quot;</span><span class="p">])</span>
                            <span class="n">out_df</span> <span class="o">=</span> <span class="n">mix</span><span class="p">[[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">]]</span>
                        <span class="k">elif</span> <span class="n">repeat_policy</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;outside_others&quot;</span><span class="p">,</span> <span class="s2">&quot;inside_others&quot;</span><span class="p">):</span>
                            <span class="c1"># Determine the &quot;others&quot; window</span>
                            <span class="k">if</span> <span class="n">repeat_ref_keys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">ref_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">repeat_ref_keys</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">ref_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ts_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                                            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">dict_key</span> <span class="ow">and</span> <span class="p">(</span><span class="n">keys2plot</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys2plot</span><span class="p">))</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="c1"># no refs -&gt; behave like fill_gaps (but still allow inside_others to clip nothing)</span>
                                <span class="n">mix</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="p">[</span><span class="s2">&quot;orig&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mix</span><span class="p">[</span><span class="s2">&quot;rep&quot;</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">repeat_policy</span> <span class="o">==</span> <span class="s2">&quot;inside_others&quot;</span><span class="p">:</span>
                                    <span class="n">mix</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># nothing to show if no reference window</span>
                                <span class="n">out_df</span> <span class="o">=</span> <span class="n">mix</span><span class="p">[[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">]]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># compute min/max over &quot;others&quot;</span>
                                <span class="n">other_mins</span><span class="p">,</span> <span class="n">other_maxs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
                                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ref_keys</span><span class="p">:</span>
                                    <span class="n">d2</span> <span class="o">=</span> <span class="n">ts_dict</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">primary_key</span><span class="p">]</span>
                                    <span class="n">tt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">d2</span><span class="p">[</span><span class="n">time_coord</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="n">other_mins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">min</span><span class="p">());</span> <span class="n">other_maxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                                <span class="n">other_min</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">other_mins</span><span class="p">))</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
                                <span class="n">other_max</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">other_maxs</span><span class="p">))</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
                                <span class="n">inside</span> <span class="o">=</span> <span class="p">(</span><span class="n">mix</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">other_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mix</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">other_max</span><span class="p">)</span>
                                <span class="c1"># inside the others window: use original where present, else repeated</span>
                                <span class="n">mix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inside</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inside</span><span class="p">,</span> <span class="s2">&quot;orig&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inside</span><span class="p">,</span> <span class="s2">&quot;rep&quot;</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">repeat_policy</span> <span class="o">==</span> <span class="s2">&quot;inside_others&quot;</span><span class="p">:</span>
                                    <span class="c1"># outside -&gt; hide (clip)</span>
                                    <span class="n">mix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">inside</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># outside -&gt; use repeated climatology</span>
                                    <span class="n">mix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">inside</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">inside</span><span class="p">,</span> <span class="s2">&quot;rep&quot;</span><span class="p">]</span>
                                <span class="n">out_df</span> <span class="o">=</span> <span class="n">mix</span><span class="p">[[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown repeat_policy: </span><span class="si">{</span><span class="n">repeat_policy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="c1"># optional smoothing after composition</span>
                        <span class="n">out_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smooth_df_time</span><span class="p">(</span><span class="n">out_df</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">smooth</span><span class="p">)</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">out_df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">out_df</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">],</span> <span class="n">pen</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">line_pen</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">line_color</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">leg_lab</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">df_sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smooth_df_time</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">smooth</span><span class="p">)</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df_sm</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">df_sm</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">],</span> <span class="n">pen</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">line_pen</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">line_color</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">leg_lab</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">zero_line</span><span class="p">:</span>
                <span class="n">y0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">zero_line_level</span><span class="p">)</span>
                <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">ylim</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">y_min</span> <span class="o">&lt;=</span> <span class="n">y0</span> <span class="o">&lt;=</span> <span class="n">y_max</span><span class="p">):</span>
                    <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span> <span class="o">=</span> <span class="n">region</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">region</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">y0</span><span class="p">],</span> <span class="n">pen</span><span class="o">=</span><span class="n">zero_line_pen</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="n">legend_pos</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="n">legend_box</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save_fig</span><span class="p">:</span>
            <span class="n">F_png</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">primary_key</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">comp_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="s1">&#39;climatology_&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">climatology</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}{</span><span class="n">tmin</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">tmax</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="n">P_png</span> <span class="o">=</span> <span class="n">P_png</span> <span class="k">if</span> <span class="n">P_png</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D_graph</span><span class="p">,</span> <span class="s2">&quot;timeseries&quot;</span><span class="p">,</span> <span class="n">F_png</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">P_png</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;saved figure to </span><span class="si">{</span><span class="n">P_png</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_fig</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">pygmt</span><span class="o">.</span><span class="n">clib</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="fm">__exit__</span></div>


<div class="viewcode-block" id="SeaIcePlotter.plot_taylor">
<a class="viewcode-back" href="../sea_ice_plotter.html#sea_ice_plotter.SeaIcePlotter.plot_taylor">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_taylor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stats_dict</span><span class="p">,</span> <span class="n">out_path</span><span class="p">):</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">polar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_theta_zero_location</span><span class="p">(</span><span class="s1">&#39;E&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_theta_direction</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">rms</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">]:</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">rms</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">rs</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;ko&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Reference&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;corr&quot;</span><span class="p">])</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">stat</span><span class="p">[</span><span class="s2">&quot;std_ratio&quot;</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_rmax</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_rticks</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_rlabel_position</span><span class="p">(</span><span class="mi">135</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Taylor Diagram: Sea Ice Speed Comparison&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.45</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="SeaIcePlotter.pygmt_map_plot_multi_var_8sectors">
<a class="viewcode-back" href="../sea_ice_plotter.html#sea_ice_plotter.SeaIcePlotter.pygmt_map_plot_multi_var_8sectors">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pygmt_map_plot_multi_var_8sectors</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">das</span><span class="p">,</span>
        <span class="n">var_names</span><span class="p">,</span>
        <span class="n">sim_name</span>        <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">time_stamp</span>      <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tit_str</span>         <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">panel_titles</span>    <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">plot_GI</span>         <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">diff_plots</span>      <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cmaps</span>           <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">series_list</span>     <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">reverse_list</span>    <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cbar_labels</span>     <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cbar_units_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">extend_cbars</span>    <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">cbar_positions</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">lon_coord_names</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">lat_coord_names</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_bcoords</span>     <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">use_tcoords</span>     <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">fig_size</span>        <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">var_sq_size</span>     <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">GI_sq_size</span>      <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">GI_fill_color</span>   <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="n">plot_iceshelves</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">plot_bathymetry</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">land_color</span>      <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">water_color</span>     <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">P_png</span>           <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">var_out</span>         <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">overwrite_fig</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">show_fig</span>        <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">xshift</span>          <span class="o">=</span> <span class="s2">&quot;w+1c&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        8-sector plot with 23 panels laid out left-to-right using shift_origin.</span>

<span class="sd">        Performance: compute PyGMT plot point clouds ONCE per panel (u1/u2/du),</span>
<span class="sd">        then sector-filter the point clouds cheaply (no repeated Dask compute).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_as_list</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="n">n</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> must have length </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> (got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_as_bool_list</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="n">n</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> must have length </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> (got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[</span><span class="nb">bool</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">[</span><span class="nb">bool</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span> <span class="o">*</span> <span class="n">n</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_sector_png_path</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">sector_name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">P</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">P</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">P</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector_name</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="k">return</span> <span class="n">P</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">P</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sector_name</span><span class="si">}{</span><span class="n">P</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_norm360</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mf">360.0</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_lon_in_range_1d</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">):</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">_norm360</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
            <span class="n">lon_min</span> <span class="o">=</span> <span class="n">lon_min</span> <span class="o">%</span> <span class="mf">360.0</span>
            <span class="n">lon_max</span> <span class="o">=</span> <span class="n">lon_max</span> <span class="o">%</span> <span class="mf">360.0</span>
            <span class="k">if</span> <span class="n">lon_min</span> <span class="o">&lt;=</span> <span class="n">lon_max</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">lon</span> <span class="o">&gt;=</span> <span class="n">lon_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lon</span> <span class="o">&lt;=</span> <span class="n">lon_max</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># crosses dateline</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">lon</span> <span class="o">&gt;=</span> <span class="n">lon_min</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">lon</span> <span class="o">&lt;=</span> <span class="n">lon_max</span><span class="p">)</span>

        <span class="c1"># --- validate ---</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">das</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var_names</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;das and var_names must be lists/tuples&quot;</span><span class="p">)</span>
        <span class="n">n_pan</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">das</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_pan</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;das must contain 2 or 3 DataArrays (got </span><span class="si">{</span><span class="n">n_pan</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_names</span><span class="p">)</span> <span class="o">!=</span> <span class="n">n_pan</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;var_names must match length of das&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">da</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">das</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="s2">&quot;dims&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="n">da</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;das[</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">] has &#39;time&#39; dim; pass a 2D time-slice.&quot;</span><span class="p">)</span>

        <span class="c1"># --- defaults ---</span>
        <span class="n">sim_name</span>    <span class="o">=</span> <span class="n">sim_name</span>      <span class="k">if</span> <span class="n">sim_name</span>      <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_name</span>
        <span class="n">show_fig</span>    <span class="o">=</span> <span class="n">show_fig</span>      <span class="k">if</span> <span class="n">show_fig</span>      <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_fig</span>
        <span class="n">ow_fig</span>      <span class="o">=</span> <span class="n">overwrite_fig</span> <span class="k">if</span> <span class="n">overwrite_fig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ow_fig</span>
        <span class="n">time_stamp</span>  <span class="o">=</span> <span class="n">time_stamp</span>    <span class="k">if</span> <span class="n">time_stamp</span>    <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt0_str</span>
        <span class="n">fig_size</span>    <span class="o">=</span> <span class="n">fig_size</span>      <span class="k">if</span> <span class="n">fig_size</span>      <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">pygmt_dict</span><span class="p">[</span><span class="s2">&quot;fig_size&quot;</span><span class="p">]</span>
        <span class="n">land_color</span>  <span class="o">=</span> <span class="n">land_color</span>    <span class="k">if</span> <span class="n">land_color</span>    <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">pygmt_dict</span><span class="p">[</span><span class="s2">&quot;land_color&quot;</span><span class="p">]</span>
        <span class="n">water_color</span> <span class="o">=</span> <span class="n">water_color</span>   <span class="k">if</span> <span class="n">water_color</span>   <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">pygmt_dict</span><span class="p">[</span><span class="s2">&quot;water_color&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">panel_titles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">panel_titles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">var_names</span><span class="p">)</span>

        <span class="n">diff_plots_l</span>      <span class="o">=</span> <span class="n">_as_bool_list</span><span class="p">(</span><span class="n">diff_plots</span><span class="p">,</span> <span class="n">n_pan</span><span class="p">,</span> <span class="s2">&quot;diff_plots&quot;</span><span class="p">)</span>
        <span class="n">cmaps_l</span>           <span class="o">=</span> <span class="n">_as_list</span><span class="p">(</span><span class="n">cmaps</span><span class="p">,</span> <span class="n">n_pan</span><span class="p">,</span> <span class="s2">&quot;cmaps&quot;</span><span class="p">)</span>
        <span class="n">series_l</span>          <span class="o">=</span> <span class="n">_as_list</span><span class="p">(</span><span class="n">series_list</span><span class="p">,</span> <span class="n">n_pan</span><span class="p">,</span> <span class="s2">&quot;series_list&quot;</span><span class="p">)</span>
        <span class="n">reverse_l</span>         <span class="o">=</span> <span class="n">_as_list</span><span class="p">(</span><span class="n">reverse_list</span><span class="p">,</span> <span class="n">n_pan</span><span class="p">,</span> <span class="s2">&quot;reverse_list&quot;</span><span class="p">)</span>
        <span class="n">cbar_labels_l</span>     <span class="o">=</span> <span class="n">_as_list</span><span class="p">(</span><span class="n">cbar_labels</span><span class="p">,</span> <span class="n">n_pan</span><span class="p">,</span> <span class="s2">&quot;cbar_labels&quot;</span><span class="p">)</span>
        <span class="n">cbar_units_l</span>      <span class="o">=</span> <span class="n">_as_list</span><span class="p">(</span><span class="n">cbar_units_list</span><span class="p">,</span> <span class="n">n_pan</span><span class="p">,</span> <span class="s2">&quot;cbar_units_list&quot;</span><span class="p">)</span>
        <span class="n">extend_cbars_l</span>    <span class="o">=</span> <span class="n">_as_bool_list</span><span class="p">(</span><span class="n">extend_cbars</span><span class="p">,</span> <span class="n">n_pan</span><span class="p">,</span> <span class="s2">&quot;extend_cbars&quot;</span><span class="p">)</span>
        <span class="n">cbar_positions_l</span>  <span class="o">=</span> <span class="n">_as_list</span><span class="p">(</span><span class="n">cbar_positions</span><span class="p">,</span> <span class="n">n_pan</span><span class="p">,</span> <span class="s2">&quot;cbar_positions&quot;</span><span class="p">)</span>
        <span class="n">lon_names_l</span>       <span class="o">=</span> <span class="n">_as_list</span><span class="p">(</span><span class="n">lon_coord_names</span><span class="p">,</span> <span class="n">n_pan</span><span class="p">,</span> <span class="s2">&quot;lon_coord_names&quot;</span><span class="p">)</span>
        <span class="n">lat_names_l</span>       <span class="o">=</span> <span class="n">_as_list</span><span class="p">(</span><span class="n">lat_coord_names</span><span class="p">,</span> <span class="n">n_pan</span><span class="p">,</span> <span class="s2">&quot;lat_coord_names&quot;</span><span class="p">)</span>
        <span class="n">use_bcoords_l</span>     <span class="o">=</span> <span class="n">_as_bool_list</span><span class="p">(</span><span class="n">use_bcoords</span><span class="p">,</span> <span class="n">n_pan</span><span class="p">,</span> <span class="s2">&quot;use_bcoords&quot;</span><span class="p">)</span>
        <span class="n">use_tcoords_l</span>     <span class="o">=</span> <span class="n">_as_bool_list</span><span class="p">(</span><span class="n">use_tcoords</span><span class="p">,</span> <span class="n">n_pan</span><span class="p">,</span> <span class="s2">&quot;use_tcoords&quot;</span><span class="p">)</span>

        <span class="c1"># overlays loaded once</span>
        <span class="k">if</span> <span class="n">plot_iceshelves</span><span class="p">:</span>
            <span class="n">ANT_IS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_ice_shelves</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">plot_bathymetry</span><span class="p">:</span>
            <span class="n">SO_BATH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_IBCSO_bath</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">plot_GI</span><span class="p">:</span>
            <span class="n">plot_GI_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_GI_lon_lats</span><span class="p">()</span>

        <span class="c1"># ensure grid loaded (for tcoords/bcoords path in pygmt_da_prep)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_cice_grid</span><span class="p">(</span><span class="n">slice_hem</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">reg_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ant_8sectors</span>
        <span class="k">if</span> <span class="n">var_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">var_out</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">var_names</span><span class="p">)</span>

        <span class="c1"># --- BIG SPEED WIN: compute plot point clouds ONCE per panel ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;precomputing plot point clouds (once per panel) ...&quot;</span><span class="p">)</span>
        <span class="n">pdicts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_pan</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">lon_names_l</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">lat_names_l</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">pd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pygmt_da_prep</span><span class="p">(</span>
                    <span class="n">das</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                    <span class="n">bcoords</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">tcoords</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">lon_coord_name</span><span class="o">=</span><span class="n">lon_names_l</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                    <span class="n">lat_coord_name</span><span class="o">=</span><span class="n">lat_names_l</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                    <span class="n">diff_plot</span><span class="o">=</span><span class="n">diff_plots_l</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">use_bcoords_l</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">and</span> <span class="n">use_tcoords_l</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot set both use_bcoords and use_tcoords True&quot;</span><span class="p">)</span>
                <span class="n">pd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pygmt_da_prep</span><span class="p">(</span>
                    <span class="n">das</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                    <span class="n">bcoords</span><span class="o">=</span><span class="n">use_bcoords_l</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                    <span class="n">tcoords</span><span class="o">=</span><span class="n">use_tcoords_l</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">use_bcoords_l</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">diff_plot</span><span class="o">=</span><span class="n">diff_plots_l</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="n">pdicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="p">)</span>

        <span class="c1"># Precompute sector masks ONCE using lon/lat from panel 0 (assumes common grid)</span>
        <span class="n">lon0</span> <span class="o">=</span> <span class="n">pdicts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span>
        <span class="n">lat0</span> <span class="o">=</span> <span class="n">pdicts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_sector_point_idx_cache&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sector_point_idx_cache</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">sector_idx</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">reg_name</span><span class="p">,</span> <span class="n">reg_vals</span> <span class="ow">in</span> <span class="n">reg_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">reg_vals</span><span class="p">[</span><span class="s2">&quot;plot_region&quot;</span><span class="p">]</span>  <span class="c1"># [lonmin, lonmax, latmin, latmax]</span>
            <span class="n">lonmin</span><span class="p">,</span> <span class="n">lonmax</span><span class="p">,</span> <span class="n">latmin</span><span class="p">,</span> <span class="n">latmax</span> <span class="o">=</span> <span class="n">region</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">_lon_in_range_1d</span><span class="p">(</span><span class="n">lon0</span><span class="p">,</span> <span class="n">lonmin</span><span class="p">,</span> <span class="n">lonmax</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat0</span> <span class="o">&gt;=</span> <span class="n">latmin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat0</span> <span class="o">&lt;=</span> <span class="n">latmax</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">sector_idx</span><span class="p">[</span><span class="n">reg_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>

        <span class="c1"># --- plot ---</span>
        <span class="k">for</span> <span class="n">reg_name</span><span class="p">,</span> <span class="n">reg_vals</span> <span class="ow">in</span> <span class="n">reg_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="n">idx</span> <span class="o">=</span> <span class="n">sector_idx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reg_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">idx</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">reg_name</span><span class="si">}</span><span class="s2">: no points in this sector after masking; skipping.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># output path per sector</span>
            <span class="n">P_png_reg</span> <span class="o">=</span> <span class="n">_sector_png_path</span><span class="p">(</span><span class="n">P_png</span><span class="p">,</span> <span class="n">reg_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">P_png_reg</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_fig</span><span class="p">:</span>
                <span class="n">P_png_reg</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D_graph</span><span class="p">,</span> <span class="n">sim_name</span><span class="p">,</span> <span class="n">reg_name</span><span class="p">,</span> <span class="n">var_out</span><span class="p">,</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">time_stamp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sim_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">reg_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">var_out</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>

            <span class="n">region</span>     <span class="o">=</span> <span class="n">reg_vals</span><span class="p">[</span><span class="s2">&quot;plot_region&quot;</span><span class="p">]</span>
            <span class="n">MC</span>         <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_meridian_center_from_geographic_extent</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
            <span class="n">projection</span> <span class="o">=</span> <span class="n">reg_vals</span><span class="p">[</span><span class="s2">&quot;projection&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">MC</span><span class="o">=</span><span class="n">MC</span><span class="p">,</span> <span class="n">fig_size</span><span class="o">=</span><span class="n">fig_size</span><span class="p">)</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">pygmt</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

            <span class="k">with</span> <span class="n">pygmt</span><span class="o">.</span><span class="n">config</span><span class="p">(</span>
                <span class="n">FONT_TITLE</span><span class="o">=</span><span class="s2">&quot;16p,Courier-Bold&quot;</span><span class="p">,</span>
                <span class="n">FONT_ANNOT_PRIMARY</span><span class="o">=</span><span class="s2">&quot;14p,Helvetica&quot;</span><span class="p">,</span>
                <span class="n">COLOR_FOREGROUND</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_pan</span><span class="p">):</span>

                    <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">shift_origin</span><span class="p">(</span><span class="n">xshift</span><span class="o">=</span><span class="n">xshift</span><span class="p">,</span> <span class="n">yshift</span><span class="o">=</span><span class="s2">&quot;0c&quot;</span><span class="p">)</span>

                    <span class="n">vn</span> <span class="o">=</span> <span class="n">var_names</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

                    <span class="c1"># per-panel defaults</span>
                    <span class="n">cmap_j</span>   <span class="o">=</span> <span class="n">cmaps_l</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>       <span class="k">if</span> <span class="n">cmaps_l</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>       <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_var_dict</span><span class="p">[</span><span class="n">vn</span><span class="p">][</span><span class="s2">&quot;cmap&quot;</span><span class="p">]</span>
                    <span class="n">series_j</span> <span class="o">=</span> <span class="n">series_l</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>      <span class="k">if</span> <span class="n">series_l</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>      <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_var_dict</span><span class="p">[</span><span class="n">vn</span><span class="p">][</span><span class="s2">&quot;series&quot;</span><span class="p">]</span>
                    <span class="n">rev_j</span>    <span class="o">=</span> <span class="n">reverse_l</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>     <span class="k">if</span> <span class="n">reverse_l</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>     <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_var_dict</span><span class="p">[</span><span class="n">vn</span><span class="p">][</span><span class="s2">&quot;reverse&quot;</span><span class="p">]</span>
                    <span class="n">lab_j</span>    <span class="o">=</span> <span class="n">cbar_labels_l</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">if</span> <span class="n">cbar_labels_l</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_var_dict</span><span class="p">[</span><span class="n">vn</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                    <span class="n">unit_j</span>   <span class="o">=</span> <span class="n">cbar_units_l</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>  <span class="k">if</span> <span class="n">cbar_units_l</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>  <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_var_dict</span><span class="p">[</span><span class="n">vn</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">]</span>

                    <span class="n">cbar_pos_j</span> <span class="o">=</span> <span class="n">cbar_positions_l</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">cbar_pos_j</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">cbar_pos_j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pygmt_dict</span><span class="p">[</span><span class="s2">&quot;cbar_pos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">fig_size</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>

                    <span class="c1"># basemap frame</span>
                    <span class="n">title_here</span> <span class="o">=</span> <span class="n">panel_titles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">if</span> <span class="n">panel_titles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">vn</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tit_str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="n">frame</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;af&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;+t</span><span class="si">{</span><span class="n">tit_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">frame</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;af&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;+t</span><span class="si">{</span><span class="n">title_here</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>

                    <span class="n">fig</span><span class="o">.</span><span class="n">basemap</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">frame</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">plot_bathymetry</span><span class="p">:</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">grdimage</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">SO_BATH</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;geo&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">coast</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span>
                                <span class="n">shorelines</span><span class="o">=</span><span class="s2">&quot;1/0.5p,gray30&quot;</span><span class="p">,</span> <span class="n">land</span><span class="o">=</span><span class="n">land_color</span><span class="p">,</span> <span class="n">water</span><span class="o">=</span><span class="n">water_color</span><span class="p">)</span>

                    <span class="c1"># Plot points for this sector</span>
                    <span class="n">pd</span> <span class="o">=</span> <span class="n">pdicts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">pygmt</span><span class="o">.</span><span class="n">makecpt</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap_j</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">rev_j</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">series_j</span><span class="p">)</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">=</span><span class="n">pd</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span>
                        <span class="n">y</span><span class="o">=</span><span class="n">pd</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span>
                        <span class="n">fill</span><span class="o">=</span><span class="n">pd</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span>
                        <span class="n">style</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;s</span><span class="si">{</span><span class="n">var_sq_size</span><span class="si">}</span><span class="s2">c&quot;</span><span class="p">,</span>
                        <span class="n">cmap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="c1"># overlays</span>
                    <span class="k">if</span> <span class="n">plot_bathymetry</span><span class="p">:</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">coast</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span> <span class="n">shorelines</span><span class="o">=</span><span class="s2">&quot;1/0.5p,gray30&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">plot_GI</span><span class="p">:</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">plot_GI_dict</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">plot_GI_dict</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span>
                                <span class="n">fill</span><span class="o">=</span><span class="n">GI_fill_color</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;c</span><span class="si">{</span><span class="n">GI_sq_size</span><span class="si">}</span><span class="s2">c&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">plot_iceshelves</span><span class="p">:</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ANT_IS</span><span class="p">,</span> <span class="n">pen</span><span class="o">=</span><span class="s2">&quot;0.2p,gray&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;lightgray&quot;</span><span class="p">)</span>

                    <span class="c1"># colorbar</span>
                    <span class="n">cbar_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_cbar_frame</span><span class="p">(</span><span class="n">series_j</span><span class="p">,</span> <span class="n">lab_j</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">unit_j</span><span class="p">,</span> <span class="n">extend_cbar</span><span class="o">=</span><span class="n">extend_cbars_l</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="n">cbar_pos_j</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">cbar_frame</span><span class="p">)</span>

            <span class="c1"># save/show</span>
            <span class="k">if</span> <span class="n">P_png_reg</span><span class="p">:</span>
                <span class="n">P_png_reg</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">P_png_reg</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span> <span class="ow">or</span> <span class="n">ow_fig</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">P_png_reg</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved figure to </span><span class="si">{</span><span class="n">P_png_reg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">P_png_reg</span><span class="si">}</span><span class="s2"> already exists and not overwriting&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">show_fig</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Daniel Atwater.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>